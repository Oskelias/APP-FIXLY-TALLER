<!DOCTYPE html>

<!-- saved from url=(0053)file:///C:/Users/Osk/Downloads/megusta_adjusted.html# -->
<html lang="es">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Fixly Taller - Sistema de Gestión Completo
  </title>
<link href="./Fixly Taller - Sistema de Gestión Completo_files/tailwind.min.css" rel="stylesheet"/>
<link href="./Fixly Taller - Sistema de Gestión Completo_files/all.min.css" rel="stylesheet"/>
<script src="./Fixly Taller - Sistema de Gestión Completo_files/chart.js.descargar">
</script>
<style>
   body, html { height: 100%; overflow: auto; }
        
        #mainApp {
            height: 100vh;
            overflow: hidden;
        }
        
        .main-content {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .dashboard-container {
            height: calc(100vh - 2rem);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 1rem;
        }
        
        .chart-container {
            height: 300px !important;
            position: relative;
        }
        
        .chart-container canvas {
            height: 300px !important;
            max-height: 300px !important;
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
        }
        .sidebar-item:hover {
            background-color: #f3f4f6;
            transform: translateX(2px);
        }
        
        .sidebar-item.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .sidebar-item.active:hover {
            background-color: #2563eb;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size:15px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-recibido { background-color: #fef3c7; color: #d97706; }
        .status-diagnosticando { background-color: #dbeafe; color: #2563eb; }
        .status-listo { background-color: #d1fae5; color: #059669; }
        .status-entregado { background-color: #e5e7eb; color: #6b7280; }
        /* Estados adicionales para resultado de reparación */
        .status-reparado { background-color: #d1fae5; color: #059669; }
        .status-no-reparado { background-color: #fee2e2; color: #b91c1c; }
        .status-no-repuesto { background-color: #fef9c3; color: #eab308; }
        .status-devolver { background-color: #fce7f3; color: #be185d; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .edit-mode-indicator {
            display: none;
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size:17px;
        }
        
        .edit-mode-indicator.show {
            display: block;
        }

        /* Estilos para la hoja de impresión - ULTRA COMPACTO */
        .print-page {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
            font-size:13px;
            line-height: 1.5;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #000;
            padding-bottom: 4px;
        }
        
        .print-title {
            font-size:18px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .print-subtitle {
            font-size:16px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .print-order {
            font-size:17px;
            font-weight: bold;
            margin-bottom: 6px;
        }
        
        .print-section {
            margin-bottom: 10px;
        }
        
        .print-row {
            display: flex;
            margin-bottom: 6px;
        }
        
        .print-label {
            font-weight: bold;
            width: 60px;
            flex-shrink: 0;
            font-size:13px;
        }
        
        .print-value {
            flex: 1;
            margin-right: 8px;
            font-size:13px;
        }

        /* Fix Observaciones layout: put Observaciones value on new line under the label */
        .print-row.print-row--stack .print-value {
            margin-left: 60px;
            white-space: pre-wrap;
        }
        
        .print-separator { display: none !important; }
        
        .print-separator::before {
            content: "✂  ✂";
            background: white;
            padding: 0 5px;
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            font-size:12px;
        }
        
        .print-signature { display: none !important; }
        
        .print-footer {
  margin-top: 8px;
  font-size: 8px;
  text-align: center;   
  border-top: 1px solid #000;
  padding-top: 4px;
  line-height: 1.2;
        }

        @media print {
            @page {
                margin: 0;
                size: A4;
            }
            
            body * {
                visibility: hidden;
            }
            .print-page, .print-page * {
                visibility: visible;
            }
            .print-page {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 10mm;
                box-shadow: none;
            }
        }

        /* Botón de impresión naranja sin sombra */
        .btn-print-orange {
            background-color: #f97316 !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.4) !important;
        }
        
        .btn-print-orange:hover {
            background-color: #ea580c !important;
            box-shadow: 0 6px 8px -1px rgba(249, 115, 22, 0.5) !important;
        }
  </style>
<style>
   @media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
  </style>
<style>
   .genspark-notice-dialog {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }

    .genspark-notice-content {
      background-color: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      box-sizing: border-box;
      padding: 10px 30px 30px 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-size: 16px;
    }

    .genspark-notice-title {
      color: #000;
      font-family: Arial;
      font-size: 20px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; 
    }

    .genspark-notice-list {
      margin: 24px 0;
      
      color: #606366;
      font-family: Arial;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      padding-left: 12px;
    }

    .genspark-notice-list li {
      margin-bottom: 12px;
      list-style-type: disc;
    }

    .genspark-notice-list li a {
      color: #606366;
      text-decoration: underline;
    }

    .genspark-notice-checkbox {
      display: flex;
      align-items: center;
      margin-top: 20px;
      gap: 10px;

      color: #232425;

      font-family: Arial;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }

    .genspark-notice-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
      
    .genspark-notice-ok {
      color: #232425;

      text-align: center;
      font-family: Arial;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; 

      cursor: pointer;
      display: flex;
      height: 40px;
      padding: 6px 14px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      align-self: stretch;
      border-radius: 8px;
      border: 1px solid #000;
      box-sizing: border-box;
      width: 100%;
    }
  </style>
<script src="https://cdn.tailwindcss.com">
</script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
</script>
<style>
  /* Mostrar solo las 5 filas más recientes del historial de WhatsApp (oculta el resto visualmente) */
  table #historial-mensajes tr:nth-child(n+6) { display: none; }
</style>
<style>
/* Badges/pills compactos */
.badge, .status-badge, .pill, .chip {
  font-size: 12px !important;
  padding: 3px 10px !important;
  border-radius: 12px !important;
}

/* Distribución: Anticipo y Costo angostos, Técnico ancho */
.trio-line {
  display: grid;
  grid-template-columns: minmax(120px, 1fr) minmax(120px, 1fr) minmax(250px, 2fr);
  gap: 1rem;
  width: 100%;
}

/* Labels uniformes encima de cada input para alinear */
.trio-line label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: 500;
}

/* Altura y estilo uniforme */
.trio-line input,
.trio-line select {
  height: 42px;
  padding: 0.5rem 0.75rem;
  font-size: 0.95rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
  width: 100%;
}

@media (max-width: 900px){
  .trio-line { grid-template-columns: 1fr; }
}
</style></head>
<body class="bg-gray-100">
<script>
  // utilidades mínimas
  function _digits(s){ return String(s||'').replace(/\D/g,''); }
  function _validPhone(s){ const d=_digits(s); return d.length>=7 && d.length<=15; }

  // guarda el teléfono por cliente en localStorage (opcional)
  function _savePhoneByClient(nombre, tel){
    try{
      const key='phonesByClient';
      const book = JSON.parse(localStorage.getItem(key) || '{}');
      book[nombre] = _digits(tel);
      localStorage.setItem(key, JSON.stringify(book));
    }catch(_){}
  }

  // 🚀 botón del formulario WhatsApp
  function enviarMensajeWhatsApp(){
    const sec = document.getElementById('whatsapp');
    if(!sec){ alert('No se encontró la sección WhatsApp'); return; }

    const clienteEl = sec.querySelector('#notif-cliente');
    const telEl     = sec.querySelector('#notif-telefono');
    const msgEl     = sec.querySelector('#mensaje-preview');

    const cliente = (clienteEl?.value || '').trim();
    let   tel     = _digits(telEl?.value || '');
    const msg     = (msgEl?.value || '').trim();

    if(!msg){
      alert('No hay mensaje para enviar. Escribí o elegí una plantilla.');
      return;
    }

    if(!_validPhone(tel)){
      const ingreso = prompt('Ingresá el teléfono (7–15 dígitos, con o sin +/espacios):', tel || '');
      if(ingreso === null) return; // canceló
      tel = _digits(ingreso);
      if(!_validPhone(tel)){ alert('Número inválido.'); return; }
      if(cliente) _savePhoneByClient(cliente, tel);
      if(telEl) telEl.value = tel; // refleja el teléfono corregido en el input
    }

    // abrir WhatsApp
    const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(msg);
    window.open(url, '_blank');
  }
</script>
<!-- Pantalla de Login -->
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 hidden" id="loginScreen">
<div class="bg-white p-8 rounded-xl shadow-2xl w-96">
<div class="text-center mb-8">
<div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
<i class="fas fa-mobile-alt text-blue-600 text-2xl">
</i>
</div>
<h1 class="text-2xl font-bold text-gray-800">
      Fixly Taller
     </h1>
<p class="text-gray-600">
      Sistema de Gestión
     </p>
</div>
<form id="loginForm" onsubmit="return window.__loginOverride(event)">
<div class="mb-4">
<label class="block text-gray-700 text-sm font-bold mb-2">
       Usuario
      </label>
<input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" id="username" required="" type="text"/>
</div>
<div class="mb-6">
<label class="block text-gray-700 text-sm font-bold mb-2">
       Contraseña
      </label>
<input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" id="password" required="" type="password"/>
</div>
<button class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200" type="submit">
<i class="fas fa-sign-in-alt mr-2">
</i>
      Iniciar Sesión
     </button>
</form>
<div class="mt-4 text-center text-sm text-gray-600">
<p>
      Usuario por defecto:
      <strong>
       admin
      </strong>
</p>
<p>
      Contraseña:
      <strong>
       admin123
      </strong>
</p>
</div>
</div>
</div>
<!-- Aplicación Principal -->
<div class="" id="mainApp">
<div class="flex h-screen bg-gray-100">
<!-- Sidebar -->
<div class="w-64 bg-white shadow-lg">
<div class="p-6 border-b">
<div class="flex items-center">
<div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center mr-3">
<i class="fas fa-mobile-alt text-blue-600">
</i>
</div>
<div>
<h1 class="text-lg font-bold text-gray-800">
         Fixly
        </h1>
<h1 class="text-lg font-bold text-blue-600">
         Taller
        </h1>
</div>
</div>
</div>
<nav class="mt-6">
<a class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" href="file:///C:/Users/Osk/Downloads/megusta_adjusted.html#" onclick="showSection(event,'dashboard')">
<i class="fas fa-tachometer-alt mr-3">
</i>
       Dashboard
      </a>
<a class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100 active" href="file:///C:/Users/Osk/Downloads/megusta_adjusted.html#" onclick="showSection(event,'reparaciones')">
<i class="fas fa-tools mr-3">
</i>
       Reparaciones
      </a>
<a class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" href="file:///C:/Users/Osk/Downloads/megusta_adjusted.html#" onclick="showSection(event,'historial')">
<i class="fas fa-history mr-3">
</i>
       Historial
      </a>
<a class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" href="file:///C:/Users/Osk/Downloads/megusta_adjusted.html#" onclick="showSection(event,'clientes')">
<i class="fas fa-users mr-3">
</i>
       Clientes
      </a>
<a class="py-3 items-center text-gray-700 flex sidebar-item px-6 btn-whatsapp hover:bg-gray-100" href="#" onclick="enviarWhatsAppDesdeBoton(this)">
<i class="fab fa-whatsapp mr-3">
</i>
       WhatsApp
      </a>
<a class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" href="file:///C:/Users/Osk/Downloads/megusta_adjusted.html#" onclick="showSection(event,'pedidos')">
<i class="fas fa-shopping-cart mr-3">
</i>
       Formulario de Pedidos
      </a>
<a class="sidebar-item flex items-center px-6 py-3 text-gray-700 hover:bg-gray-100" href="file:///C:/Users/Osk/Downloads/megusta_adjusted.html#" onclick="showSection(event,'configuracion')">
<i class="fas fa-cog mr-3">
</i>
       Configuración
      </a>
</nav>
</div>
<!-- Contenido Principal -->
<div class="flex-1 main-content">
<!-- Dashboard -->
<div class="section p-8" id="dashboard">
<div class="dashboard-container">
<div class="flex justify-between items-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">
         Dashboard
        </h1>
<div class="text-sm text-gray-600">
<i class="fas fa-calendar mr-2">
</i>
<span id="fecha-actual">
          martes, 19 de agosto de 2025
         </span>
</div>
</div>
<!-- KPIs -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
<div class="card bg-white p-6 rounded-xl">
<div class="flex items-center justify-between">
<div>
<p class="text-sm font-medium text-gray-600">
            Reparaciones Hoy
           </p>
<p class="text-2xl font-bold text-gray-900" id="kpi-hoy">
            0
           </p>
</div>
<div class="bg-blue-100 p-3 rounded-full">
<i class="fas fa-calendar-day text-blue-600">
</i>
</div>
</div>
</div>
<div class="card bg-white p-6 rounded-xl">
<div class="flex items-center justify-between">
<div>
<p class="text-sm font-medium text-gray-600">
            En Proceso
           </p>
<p class="text-2xl font-bold text-gray-900" id="kpi-proceso">
            1
           </p>
</div>
<div class="bg-yellow-100 p-3 rounded-full">
<i class="fas fa-cog text-yellow-600">
</i>
</div>
</div>
</div>
<div class="card bg-white p-6 rounded-xl">
<div class="flex items-center justify-between">
<div>
<p class="text-sm font-medium text-gray-600">
            Listos
           </p>
<p class="text-2xl font-bold text-gray-900" id="kpi-listos">
            1
           </p>
</div>
<div class="bg-green-100 p-3 rounded-full">
<i class="fas fa-check text-green-600">
</i>
</div>
</div>
</div>
<div class="card bg-white p-6 rounded-xl">
<div class="flex items-center justify-between">
<div>
<p class="text-sm font-medium text-gray-600">
            Clientes
           </p>
<p class="text-2xl font-bold text-gray-900" id="kpi-clientes">
            3
           </p>
</div>
<div class="bg-purple-100 p-3 rounded-full">
<i class="fas fa-users text-purple-600">
</i>
</div>
</div>
</div>
</div>
<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-lg font-semibold mb-4">
          Estados de Reparaciones
         </h3>
<div class="chart-container">
<canvas height="300" id="statusChart" style="display: block; box-sizing: border-box; height: 300px; width: 439px;" width="439">
</canvas>
</div>
</div>
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-lg font-semibold mb-4">
          Ingresos del Mes
         </h3>
<div class="chart-container">
<canvas height="300" id="revenueChart" style="display: block; box-sizing: border-box; height: 300px; width: 439px;" width="439">
</canvas>
</div>
</div>
</div>
</div>
</div>
<!-- Reparaciones -->
<div class="section p-8 active" id="reparaciones">
<div class="flex justify-between items-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">
        Reparaciones
       </h1>
<p class="text-gray-600">
        Gestión de órdenes de reparación
       </p>
<button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200" onclick="showNuevaReparacion()">
<i class="fas fa-plus mr-2">
</i>
        Nueva Reparación
       </button>
</div>
<!-- Lista de Reparaciones -->
<div class="card bg-white p-6 rounded-xl">
<div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
<input class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filtro-busqueda" placeholder="Buscar por cliente, equipo o orden..." type="text"/>
<select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filtro-estado">
<option value="">
          Todos los estados
         </option>
<option value="recibido">
          Recibido
         </option>
<option value="diagnosticando">
          Diagnosticando
         </option>
<option value="listo">
          Listo
         </option>
</select>
<select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filter-tecnico">
<option value="">
          Todos los técnicos
         </option>
<option value="Ana Silva">
          Ana Silva - iPhone y Samsung
         </option>
<option value="Juan Pérez">
          Juan Pérez - Xiaomi y Motorola
         </option>
<option value="Luis Rodríguez">
          Luis Rodríguez - Tablets y Notebooks
         </option>
</select>
</div>
<div class="overflow-x-auto">
<table class="w-full">
<thead>
<tr class="border-b">
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Orden
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Cliente
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Equipo
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Estado
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Técnico
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Fecha
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Acciones
           </th>
</tr>
</thead>
<tbody id="tabla-reparaciones">
<tr class="border-b hover:bg-gray-50">
<td class="py-3 px-4 font-medium">
            #1001
           </td>
<td class="py-3 px-4">
            María González
           </td>
<td class="py-3 px-4">
            iPhone 13 Pro
           </td>
<td class="py-3 px-4">
<span class="status-badge status-diagnosticando">
             diagnosticando
            </span>
</td>
<td class="py-3 px-4">
            Ana Silva
           </td>
<td class="py-3 px-4">
            08/11/2025
           </td>
<td class="py-3 px-4">
<div class="flex gap-2">
<button class="btn-print-orange text-white p-2 rounded" onclick="imprimirComprobante('1001')" title="Imprimir">
<i class="fas fa-print">
</i>
</button>
<button class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700" onclick="editarReparacion('1001')" title="Editar">
<i class="fas fa-edit">
</i>
</button>
<button class="hover:bg-green-700 bg-green-600 text-white p-2 btn-whatsapp rounded" onclick="enviarWhatsAppDesdeBoton(this)" title="WhatsApp" type="button">
<i class="fab fa-whatsapp">
</i>
</button>
<button class="bg-red-600 text-white p-2 rounded hover:bg-red-700" onclick="eliminarReparacion('1001')" title="Eliminar">
<i class="fas fa-trash">
</i>
</button>
</div>
</td>
</tr>
<tr class="border-b hover:bg-gray-50">
<td class="py-3 px-4 font-medium">
            #1002
           </td>
<td class="py-3 px-4">
            Carlos López
           </td>
<td class="py-3 px-4">
            Samsung Galaxy A54
           </td>
<td class="py-3 px-4">
<span class="status-badge status-listo">
             listo
            </span>
</td>
<td class="py-3 px-4">
            Ana Silva
           </td>
<td class="py-3 px-4">
            07/11/2025
           </td>
<td class="py-3 px-4">
<div class="flex gap-2">
<button class="btn-print-orange text-white p-2 rounded" onclick="imprimirComprobante('1002')" title="Imprimir">
<i class="fas fa-print">
</i>
</button>
<button class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700" onclick="editarReparacion('1002')" title="Editar">
<i class="fas fa-edit">
</i>
</button>
<button class="hover:bg-green-700 bg-green-600 text-white p-2 btn-whatsapp rounded" onclick="enviarWhatsAppDesdeBoton(this)" title="WhatsApp" type="button">
<i class="fab fa-whatsapp">
</i>
</button>
<button class="bg-red-600 text-white p-2 rounded hover:bg-red-700" onclick="eliminarReparacion('1002')" title="Eliminar">
<i class="fas fa-trash">
</i>
</button>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- HISTORIAL -->
<div class="section p-8" id="historial">
<div class="flex justify-between items-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">
        Historial
       </h1>
<p class="text-gray-600">
        Equipos entregados y archivados
       </p>
</div>
<!-- Lista de Historial -->
<div class="card bg-white p-6 rounded-xl">
<div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
<input class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filtro-historial" placeholder="Buscar en historial..." type="text"/>
<select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filtro-mes">
<option value="">
          Todos los meses
         </option>
<option value="01">
          Enero
         </option>
<option value="02">
          Febrero
         </option>
<option value="03">
          Marzo
         </option>
<option value="04">
          Abril
         </option>
<option value="05">
          Mayo
         </option>
<option value="06">
          Junio
         </option>
<option value="07">
          Julio
         </option>
<option value="08">
          Agosto
         </option>
<option value="09">
          Septiembre
         </option>
<option value="10">
          Octubre
         </option>
<option value="11">
          Noviembre
         </option>
<option value="12">
          Diciembre
         </option>
</select>
<select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filtro-tecnico-historial">
<option value="">
          Todos los técnicos
         </option>
<option value="Ana Silva">
          Ana Silva - iPhone y Samsung
         </option>
<option value="Juan Pérez">
          Juan Pérez - Xiaomi y Motorola
         </option>
<option value="Luis Rodríguez">
          Luis Rodríguez - Tablets y Notebooks
         </option>
</select>
</div>
<div class="overflow-x-auto">
<table class="w-full">
<thead>
<tr class="border-b">
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Orden
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Cliente
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Equipo
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Técnico
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Fecha Ingreso
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Fecha Entrega
           </th>
<th class="text-left py-3 px-4 font-semibold text-gray-700">
            Acciones
           </th>
</tr>
</thead>
<tbody id="tabla-historial">
<tr class="border-b hover:bg-gray-50">
<td class="py-3 px-4 font-medium">
            #1000
           </td>
<td class="py-3 px-4">
            Pedro Martínez
           </td>
<td class="py-3 px-4">
            iPhone 12
           </td>
<td class="py-3 px-4">
            Juan Pérez
           </td>
<td class="py-3 px-4">
            01/11/2025
           </td>
<td class="py-3 px-4">
            05/11/2025
           </td>
<td class="py-3 px-4">
<div class="flex gap-2">
<button class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700" onclick="verDetalleHistorial('1000')" title="Ver Detalles">
<i class="fas fa-eye">
</i>
</button>
<button class="btn-print-orange text-white p-2 rounded" onclick="imprimirHistorial(1000)" title="Reimprimir">
<i class="fas fa-print">
</i>
</button>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Clientes -->
<div class="section p-8" id="clientes">
<h1 class="text-3xl font-bold text-gray-800 mb-8">
       Clientes
      </h1>
<div class="card bg-white p-6 rounded-xl">
<p class="text-gray-600">
        Módulo de clientes en desarrollo...
       </p>
</div>
</div>
<!-- WhatsApp -->
<div class="section p-8" id="whatsapp">
<h1 class="text-3xl font-bold text-gray-800 mb-8">
       WhatsApp
      </h1>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Notificar Cliente -->
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-xl font-semibold mb-6">
         Notificar Cliente
        </h3>
<div id="whatsapp-messages">
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Seleccionar Reparación
          </label>
<select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" id="select-reparacion" onchange="cargarDatosReparacion()">
<option value="">
            Seleccionar reparación
           </option>
<option value="1001">
            #1001 - María González - iPhone 13 Pro
           </option>
<option value="1002">
            #1002 - Carlos López - Samsung Galaxy A54
           </option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Cliente
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" id="notif-cliente" readonly="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Teléfono
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" id="notif-telefono" readonly="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Tipo de Mensaje
          </label>
<select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" id="tipo-mensaje" onchange="generarMensaje()">
<option value="recibido" selected>
            Equipo Recibido
           </option>
<option value="diagnostico">
            Diagnóstico Listo
           </option>
<option value="listo">
            Equipo Listo
           </option>
<option value="recordatorio">
            Recordatorio - Equipo Listo
           </option>
<option value="no-reparable">
            No Reparable
           </option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Mensaje
          </label>
<!-- Indicador de modo de edición -->
<div class="edit-mode-indicator" id="edit-mode-indicator">
<i class="fas fa-edit mr-2">
</i>
           Modo edición activado - Puedes modificar el mensaje
          </div>
<textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" id="mensaje-preview" placeholder="El mensaje se generará automáticamente..." rows="4"></textarea>
<div class="mt-2 flex gap-2" id="mensaje-controls" style="display: none;">
</div>
</div>
<button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition" id="btn-enviar-wsp" onclick="enviarMensajeWhatsApp()" type="button">
<i class="fab fa-whatsapp mr-2"></i> Enviar por WhatsApp
</button>
</div>
</div>
<!-- Plantillas de Mensajes -->
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-xl font-semibold mb-6">
         Plantillas de Mensajes
        </h3>
<div class="space-y-4">
<div class="border-l-4 border-blue-500 pl-4">
<h4 class="font-semibold text-green-600">
           Equipo Recibido
          </h4>
<p class="text-sm text-gray-600">
           Hola [Nombre], hemos recibido su [Equipo]. Le mantendremos informado del progreso. Ticket: [Ticket]
          </p>
</div>
<div class="border-l-4 border-yellow-500 pl-4">
<h4 class="font-semibold text-green-600">
           Diagnóstico Listo
          </h4>
<p class="text-sm text-gray-600">
           Hola [Nombre], hemos diagnosticado su [Equipo]. [Problema]. Costo estimado: $[Costo]. ¿Autoriza la reparación?
          </p>
</div>
<div class="border-l-4 border-green-500 pl-4">
<h4 class="font-semibold text-green-600">
           Equipo Listo
          </h4>
<p class="text-sm text-gray-600">
           ¡Buenas noticias! Su [Equipo] está listo para retirar. Costo total: $[Costo]. Horario: Lun-Vie 9-18hs, Sáb 9-13hs
          </p>
</div>
<div class="border-l-4 border-red-500 pl-4">
<h4 class="font-semibold text-green-600">
           Recordatorio - Equipo Listo
          </h4>
<p class="text-sm text-gray-600">
           Hola [Nombre], su [Equipo] está listo para retirar desde hace varios días. Por favor coordine su retiro. Gracias.
          </p>
</div>
        <div class="border-l-4 border-gray-500 pl-4">
<h4 class="font-semibold text-green-600">
           No Reparable
          </h4>
<p class="text-sm text-gray-600">
           Hola [Nombre], lamentablemente su [Equipo] no se puede reparar debido a [Problema]. Puede pasar a retirarlo sin cargo. Gracias.
          </p>
        </div>
</div>
<div class="mt-8">
<h4 class="font-semibold mb-4">
          Historial de Envíos
         </h4>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead>
<tr class="border-b">
<th class="text-left py-2">
              Cliente
             </th>
<th class="text-left py-2">
              Mensaje
             </th>
<th class="text-left py-2">
              Estado
             </th>
<th class="text-left py-2">
              Fecha
             </th>
</tr>
</thead>
<tbody id="historial-mensajes">
<!-- Se llena dinámicamente -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- Formulario de Pedidos -->
<div class="section p-8" id="pedidos">
<div class="flex justify-between items-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">
        Formulario de Pedidos
       </h1>
<p class="text-gray-600">
        Gestión de pedidos de productos y servicios
       </p>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Nuevo Pedido -->
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-xl font-semibold mb-6 flex items-center">
<i class="fas fa-plus-circle text-blue-600 mr-2">
</i>
         Nuevo Pedido
        </h3>
<div id="pedidos-messages">
</div>
<form class="space-y-4" id="formNuevoPedido">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Cliente
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="cliente" placeholder="Nombre del cliente" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Teléfono
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="telefono" placeholder="Número de teléfono" required="" type="tel"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Producto/Servicio
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="producto" placeholder="Ej: Memoria SD 32GB" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Descripción
          </label>
<textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="descripcion" placeholder="Detalles adicionales del pedido" rows="3"></textarea>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
            ¿Deja seña?
           </label>
<div class="flex gap-4">
<label class="flex items-center">
<input class="mr-2" name="deja_sena" onchange="toggleSena()" type="radio" value="si"/>
             Sí
            </label>
<label class="flex items-center">
<input checked="" class="mr-2" name="deja_sena" onchange="toggleSena()" type="radio" value="no"/>
             No
            </label>
</div>
</div>
<div id="sena-container" style="display: none;">
<label class="block text-sm font-medium text-gray-700 mb-2">
            Seña ($)
           </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" name="sena" placeholder="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Precio Total ($)
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" name="precio_total" placeholder="0" required="" type="number"/>
</div>
<button class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center" type="submit">
<i class="fas fa-plus mr-2">
</i>
          Crear Pedido
         </button>
</form>
</div>
<!-- Lista de Pedidos -->
<div class="card bg-white p-6 rounded-xl">
<div class="flex justify-between items-center mb-6">
<h3 class="text-xl font-semibold flex items-center">
<i class="fas fa-list text-green-600 mr-2">
</i>
          Lista de Pedidos
         </h3>
<div class="flex gap-2">
<input class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="buscar-pedidos" placeholder="Buscar cliente o producto..." type="text"/>
<select class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="filtro-estado-pedidos">
<option value="">
            Todos
           </option>
<option value="pendiente">
            Pendiente
           </option>
<option value="listo">
            Listo
           </option>
<option value="entregado">
            Entregado
           </option>
</select>
</div>
</div>
<div class="space-y-3" id="lista-pedidos"></div>
</div>
</div>
</div>
<!-- Configuración -->
<div class="section p-8" id="configuracion">
<div class="flex justify-between items-center mb-8">
<h1 class="text-3xl font-bold text-gray-800">
        Configuración
       </h1>
<p class="text-gray-600">
        Ajustes del sistema y gestión de técnicos
       </p>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Información del Taller -->
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-xl font-semibold mb-6 flex items-center">
<i class="fas fa-store text-blue-600 mr-2">
</i>
         Información del Taller
        </h3>
<div id="config-messages">
</div>
<form class="space-y-4" id="formConfigTaller">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Nombre del Taller
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="nombre_taller" required="" type="text" value="Fixly Taller"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Dirección
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="direccion" required="" type="text" value="Av. Corrientes 1234, CABA"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Teléfono
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="telefono" required="" type="tel" value="+54 11 1234-5678"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Email
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" name="email" required="" type="email" value="info@fixlytaller.com"/>
</div>
<button class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center" type="submit">
<i class="fas fa-save mr-2">
</i>
          Guardar Información
         </button>
</form>
</div>
<!-- Gestión de Técnicos -->
<div class="card bg-white p-6 rounded-xl">
<div class="flex justify-between items-center mb-6">
<h3 class="text-xl font-semibold flex items-center">
<i class="fas fa-users-cog text-green-600 mr-2">
</i>
          Técnicos
         </h3>
<button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm" onclick="showAgregarTecnico()">
<i class="fas fa-plus mr-1">
</i>
          Agregar
         </button>
</div>
<div class="space-y-3" id="lista-tecnicos">
<div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
<div class="flex justify-between items-center">
<div>
<h4 class="font-semibold text-gray-800">
             Ana Silva
            </h4>
<p class="text-sm text-gray-600">
             iPhone y Samsung
            </p>
</div>
<button class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700" onclick="eliminarTecnico(0)">
<i class="fas fa-trash">
</i>
</button>
</div>
</div>
<div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
<div class="flex justify-between items-center">
<div>
<h4 class="font-semibold text-gray-800">
             Juan Pérez
            </h4>
<p class="text-sm text-gray-600">
             Xiaomi y Motorola
            </p>
</div>
<button class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700" onclick="eliminarTecnico(1)">
<i class="fas fa-trash">
</i>
</button>
</div>
</div>
<div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50">
<div class="flex justify-between items-center">
<div>
<h4 class="font-semibold text-gray-800">
             Luis Rodríguez
            </h4>
<p class="text-sm text-gray-600">
             Tablets y Notebooks
            </p>
</div>
<button class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700" onclick="eliminarTecnico(2)">
<i class="fas fa-trash">
</i>
</button>
</div>
</div>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
<!-- Sistema y Seguridad -->
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-xl font-semibold mb-6 flex items-center">
<i class="fas fa-shield-alt text-orange-600 mr-2">
</i>
         Sistema y Seguridad
        </h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Cambiar Contraseña
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" id="nueva-password" placeholder="Nueva contraseña" type="password"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">
           Confirmar Contraseña
          </label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" id="confirmar-password" placeholder="Confirmar nueva contraseña" type="password"/>
</div>
<button class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition duration-200 flex items-center justify-center" onclick="cambiarPassword()">
<i class="fas fa-key mr-2">
</i>
          Cambiar Contraseña
         </button>
</div>
</div>
<!-- Respaldo y Datos -->
<div class="card bg-white p-6 rounded-xl">
<h3 class="text-xl font-semibold mb-6 flex items-center">
<i class="fas fa-database text-purple-600 mr-2">
</i>
         Respaldo y Datos
        </h3>
<div class="space-y-4">
<button class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center" onclick="exportarDatos()">
<i class="fas fa-download mr-2">
</i>
          Exportar Datos
         </button>
<button class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center" onclick="importarDatos()">
<i class="fas fa-upload mr-2">
</i>
          Importar Datos
         </button>
<button class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center" onclick="limpiarTodosLosDatos()">
<i class="fas fa-trash mr-2">
</i>
          Limpiar Todos los Datos
         </button>
<div class="text-xs text-gray-500 mt-4">
<p>
<strong>
            Nota:
           </strong>
           El respaldo incluye todas las reparaciones, historial, técnicos y configuraciones.
          </p>
<p>
           Se recomienda hacer respaldos periódicos de los datos.
          </p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Modal Nueva Reparación -->
<div class="modal" id="nueva-reparacion-modal">
<div class="modal-content">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">
      Nueva Reparación
     </h2>
<button class="text-gray-500 hover:text-gray-700" onclick="hideNuevaReparacion()">
<i class="fas fa-times text-xl">
</i>
</button>
</div>
<div id="nueva-messages">
</div>
<form class="grid grid-cols-1 md:grid-cols-2 gap-4" id="formNuevaReparacion">
<div>
<label class="block text-sm font-medium mb-2">
       Cliente *
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="cliente" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       DNI
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="dni" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Teléfono *
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="telefono" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Email
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="email" type="email"/>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium mb-2">
       Dirección
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="direccion" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Equipo *
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="equipo" required="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Serie / IMEI
      </label>
<input class="w-full px-4 py-2 border rounded-lg" name="imei" type="text"/>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium mb-2">
       Problema Reportado *
      </label>
<textarea class="w-full px-4 py-2 border rounded-lg" name="problema" required="" rows="3"></textarea>
</div><div class="grid gap-4 trio-line"><div>
<label class="block text-sm font-medium mb-2">
       Anticipo
      </label>
<input class="w-full px-4 py-2 border rounded-lg" min="0" name="anticipo" type="number"/>
</div><div class="mb-4">
<label class="block text-sm font-medium">
       Costo
      </label>
<input class="w-full border rounded-lg p-2" id="costo" name="costo" type="number"/>
</div><div>
<label class="block text-sm font-medium mb-2">
       Técnico Asignado
      </label>
<select class="w-full px-4 py-2 border rounded-lg" id="select-tecnico" name="tecnico">
<option value="">
        Seleccionar técnico
       </option>
<option value="Ana Silva">
        Ana Silva - iPhone y Samsung
       </option>
<option value="Juan Pérez">
        Juan Pérez - Xiaomi y Motorola
       </option>
<option value="Luis Rodríguez">
        Luis Rodríguez - Tablets y Notebooks
       </option>
</select>
</div></div>
<div class="md:col-span-2">
<label class="block text-sm font-medium mb-2">
       Observaciones
      </label>
<textarea class="w-full px-4 py-2 border rounded-lg" name="observaciones" rows="2"></textarea>
</div>
<div class="md:col-span-2 flex gap-4 mt-6">
<button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" type="submit">
<i class="fas fa-save mr-2">
</i>
       Guardar Reparación
      </button>
<button class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600" onclick="hideNuevaReparacion()" type="button">
<i class="fas fa-times mr-2">
</i>
       Cancelar
      </button>
</div>
</form>
</div>
</div>
<!-- Modal Estado del Equipo -->
<div class="modal" id="estado-equipo-modal">
<div class="modal-content">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">
      Estado del Equipo
     </h2>
<button class="text-gray-500 hover:text-gray-700" onclick="hideEstadoEquipo()">
<i class="fas fa-times text-xl">
</i>
</button>
</div>
<div id="estado-equipo-messages"></div>
<form class="space-y-4" id="formEstadoEquipo">
<div>
<label class="block text-sm font-medium mb-2">
       Cliente
      </label>
<input class="w-full px-4 py-2 border rounded-lg bg-gray-50" id="estado-equipo-cliente" readonly="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Equipo
      </label>
<input class="w-full px-4 py-2 border rounded-lg bg-gray-50" id="estado-equipo-equipo" readonly="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Resultado
      </label>
<select class="w-full px-4 py-2 border rounded-lg" id="estado-equipo-resultado" required="">
<option value="">
        Seleccionar…
       </option>
<option value="reparado">
        Reparado
       </option>
<option value="no-reparado">
        No reparado
       </option>
<option value="no-repuesto">
        No hay repuesto
       </option>
<option value="devolver">
        Devolver
       </option>
</select>
</div>
<div class="flex gap-4 mt-6">
<button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" type="submit">
<i class="fas fa-save mr-2">
</i>
       Guardar
      </button>
<button class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600" onclick="hideEstadoEquipo()" type="button">
<i class="fas fa-times mr-2">
</i>
       Cancelar
      </button>
</div>
</form>
</div>
</div>
<!-- Modal Editar Estado -->
<div class="modal" id="edit-estado-modal">
<div class="modal-content">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">
      Editar Estado de Reparación
     </h2>
<button class="text-gray-500 hover:text-gray-700" onclick="hideEditEstado()">
<i class="fas fa-times text-xl">
</i>
</button>
</div>
<div id="edit-messages">
</div>
<form class="space-y-4" id="formEditEstado">
<div>
<label class="block text-sm font-medium mb-2">
       Cliente
      </label>
<input class="w-full px-4 py-2 border rounded-lg bg-gray-50" id="edit-cliente" readonly="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Equipo
      </label>
<input class="w-full px-4 py-2 border rounded-lg bg-gray-50" id="edit-equipo" readonly="" type="text"/>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Estado *
      </label>
<select class="w-full px-4 py-2 border rounded-lg" id="edit-estado" required="">
<option value="recibido">
        Recibido
       </option>
<option value="diagnosticando">
        Diagnosticando
       </option>
<option value="listo">
        Listo
       </option>
<option value="entregado">
        Entregado
       </option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Técnico Asignado
      </label>
<select class="w-full px-4 py-2 border rounded-lg" id="edit-tecnico">
<option value="">
        Seleccionar técnico
       </option>
<option value="Ana Silva">
        Ana Silva - iPhone y Samsung
       </option>
<option value="Juan Pérez">
        Juan Pérez - Xiaomi y Motorola
       </option>
<option value="Luis Rodríguez">
        Luis Rodríguez - Tablets y Notebooks
       </option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-2">
       Costo Final
      </label>
<input class="w-full px-4 py-2 border rounded-lg" id="edit-costo" min="0" type="number"/>
</div>
<div class="flex gap-4 mt-6">
<button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" type="submit">
<i class="fas fa-save mr-2">
</i>
       Guardar Cambios
      </button>
<button class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600" onclick="hideEditEstado()" type="button">
<i class="fas fa-times mr-2">
</i>
       Cancelar
      </button>
</div>
</form>
</div>
</div>
<!-- Modal Ver Detalles del Historial -->
<div class="modal" id="detalle-historial-modal">
<div class="modal-content" style="max-width: 800px;">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">
      Detalles del Historial
     </h2>
<button class="text-gray-500 hover:text-gray-700" onclick="hideDetalleHistorial()">
<i class="fas fa-times text-xl">
</i>
</button>
</div>
<div id="detalle-content">
<!-- Se llena dinámicamente -->
</div>
<div class="mt-6 border-t pt-6">
<h3 class="text-lg font-semibold mb-4">
      Notas Adicionales
     </h3>
<div class="mb-4" id="notas-historial">
<!-- Se llenan dinámicamente -->
</div>
<div class="flex gap-2">
<input class="flex-1 px-4 py-2 border rounded-lg" id="nueva-nota" placeholder="Agregar nota..." type="text"/>
<button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onclick="agregarNota()">
<i class="fas fa-plus">
</i>
</button>
</div>
</div>
<div class="mt-6 border-t pt-6">
<h3 class="text-lg font-semibold mb-4">
      Garantía
     </h3>
<div class="flex gap-4">
<button class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700" onclick="reingresarPorGarantia()">
<i class="fas fa-redo mr-2">
</i>
       Reingresar por Garantía
      </button>
<button class="btn-print-orange text-white px-6 py-2 rounded-lg" onclick="imprimirHistorial(equipoDetalleActual?.id)">
<i class="fas fa-print mr-2">
</i>
       Reimprimir Comprobante
      </button>
</div>
</div>
</div>
</div>
<script>
   // Variables globales
        let currentSection = 'dashboard';
        let reparaciones = [];
        let tecnicos = [];
        let proximoOrden = 1003;
        let statusChart, revenueChart;
        let reparacionSeleccionada = null;
        let mensajeOriginal = '';
        let modoEdicion = false;
        let reparacionEditando = null;
        // Variable para la edición del estado del equipo (resultado final)
        let reparacionEditandoEstado = null;
        let historialEntregados = [];
        let historialMensajes = [];
        let equipoDetalleActual = null;

        // Datos iniciales
        const datosIniciales = {
            reparaciones: [
                {
                    id: '1001',
                    cliente: 'María González',
                    dni: '12345678',
                    telefono: '+54 11 1234-5678',
                    email: 'maria@email.com',
                    direccion: 'Av. Corrientes 1234',
                    equipo: 'iPhone 13 Pro',
                    imei: '123456789012345',
                    estado: 'diagnosticando',
                    tecnico: 'Ana Silva',
                    fecha: '08/11/2025',
                    problema: 'Pantalla rota',
                    anticipo: 15000,
                    costoEstimado: 45000,
                    observaciones: 'Funda, cargador'
                },
                {
                    id: '1002',
                    cliente: 'Carlos López',
                    dni: '87654321',
                    telefono: '+54 11 8765-4321',
                    email: 'carlos@email.com',
                    direccion: 'Av. Santa Fe 5678',
                    equipo: 'Samsung Galaxy A54',
                    imei: '987654321098765',
                    estado: 'listo',
                    tecnico: 'Ana Silva',
                    fecha: '07/11/2025',
                    problema: 'Batería no carga',
                    anticipo: 8000,
                    costoEstimado: 18000,
                    accesorios: 'Cargador original'
                }
            ],
            tecnicos: [
                { id: '1', nombre: 'Ana Silva', especialidad: 'iPhone y Samsung' },
                { id: '2', nombre: 'Juan Pérez', especialidad: 'Xiaomi y Motorola' },
                { id: '3', nombre: 'Luis Rodríguez', especialidad: 'Tablets y Notebooks' }
            ],
            historialEntregados: [
                {
                    id: '1000',
                    cliente: 'Pedro Martínez',
                    dni: '11223344',
                    telefono: '+54 11 9999-8888',
                    email: 'pedro@email.com',
                    direccion: 'Av. Rivadavia 1000',
                    equipo: 'iPhone 12',
                    imei: '111222333444555',
                    estado: 'entregado',
                    tecnico: 'Juan Pérez',
                    fecha: '01/11/2025',
                    fechaEntrega: '05/11/2025',
                    problema: 'Cambio de batería',
                    anticipo: 10000,
                    costoEstimado: 25000,
                    accesorios: 'Cargador',
                    notas: ['Reparación completada sin problemas', 'Cliente satisfecho con el servicio']
                }
            ]
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            cargarTecnicos();
            cargarTablaReparaciones();
            cargarTablaHistorial();
            cargarReparacionesEnSelect();
            actualizarKPIs();
            initializeCharts();
            configurarFiltros();
            mostrarFechaActual();

        // --- Guard: asegurar que renderListaPedidos exista para evitar ReferenceError
        function __ensureRenderListaPedidos(){
            if (typeof window.renderListaPedidos !== 'function'){
                window.renderListaPedidos = function(){ /* noop until funciones de pedidos se carguen */ };
            }
        }
        __ensureRenderListaPedidos();
    

            // Configurar formulario de nuevo pedido
            const formPedido = document.getElementById('formNuevoPedido');
            if (formPedido){
                formPedido.addEventListener('submit', function(e){
                    e.preventDefault();
                    crearNuevoPedido(new FormData(formPedido));
                });
            }
            const buscarPedidos = document.getElementById('buscar-pedidos');
            const filtroEstadoPedidos = document.getElementById('filtro-estado-pedidos');
            if (buscarPedidos){ buscarPedidos.addEventListener('input', renderListaPedidos); }
            if (filtroEstadoPedidos){ filtroEstadoPedidos.addEventListener('change', renderListaPedidos); }

            try{ renderListaPedidos(); }catch(e){ console.warn('renderListaPedidos no disponible aún', e); }
            
            // Configurar formulario de login
            
// Login robusto con persistencia y credenciales fallback
(function(){
  const form = document.getElementById('loginForm');
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');

  function showMain(){
    if (loginScreen) loginScreen.classList.add('hidden');
    if (mainApp) mainApp.classList.remove('hidden');
    try { localStorage.setItem('fixlytallerLoggedIn', '1'); } catch(e){}
  }

  // Autologin si ya inició sesión
  try {
    if (localStorage.getItem('fixlytallerLoggedIn') === '1') {
      showMain();
      return;
    }
  } catch(e){}

  if (!form) return;
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const username = (document.getElementById('username')?.value || '').trim();
    const password = (document.getElementById('password')?.value || '').trim();

    // Credenciales desde config si existen
    let cfgUser = 'admin', cfgPass = 'admin123';
    try {
      const raw = localStorage.getItem('fixlytallerData');
      if (raw) {
        const d = JSON.parse(raw);
        if (d && d.config) {
          cfgUser = d.config.usuario || cfgUser;
          cfgPass = d.config.contrasena || cfgPass;
        }
      }
    } catch(e){}

    // Aceptamos también admin/admin por compatibilidad
    const ok =
      (username === cfgUser && password === cfgPass) ||
      (username === 'admin' && password === 'admin') ||
      (username === 'admin' && password === 'admin123');

    if (ok) {
      showMain();
    } else {
      alert('Usuario o contraseña incorrectos');
    }
  });
})();

            // Configurar formulario de nueva reparación
            document.getElementById('formNuevaReparacion').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevaReparacion();
            });

            // Configurar formulario de edición de estado
            document.getElementById('formEditEstado').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarCambiosEstado();
            });
            // Configurar formulario de estado del equipo
            document.getElementById('formEstadoEquipo').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarEstadoEquipo();
            });
        });

        // FUNCIONES DE NAVEGACIÓN Y SECCIONES
        function showSection(event, sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la sección seleccionada
            document.getElementById(sectionName).classList.add('active');
            
            // Actualizar sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            (event && event.target ? event.target : document.querySelector(`[onclick*="'${sectionName}'"]`))?.classList?.add('active');
            currentSection = sectionName;
        }

        function mostrarFechaActual() {
            const fecha = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('fecha-actual').textContent = fecha;
        }

        // FUNCIONES DE DATOS
        function cargarDatos() {
            const datosGuardados = localStorage.getItem('fixlytallerData');
            if (datosGuardados) {
                const datos = JSON.parse(datosGuardados);
                // Cargar pedidos en la variable global y en la local para mantener sincronía
                window.pedidos = Array.isArray(datos.pedidos) ? datos.pedidos : [];
                pedidos = window.pedidos;
                reparaciones = datos.reparaciones || datosIniciales.reparaciones;
                tecnicos = datos.tecnicos || datosIniciales.tecnicos;
                proximoOrden = datos.proximoOrden || 1003;
                historialEntregados = datos.historialEntregados || datosIniciales.historialEntregados;
                historialMensajes = datos.historialMensajes || [];
            } else {
                reparaciones = [...datosIniciales.reparaciones];
                tecnicos = [...datosIniciales.tecnicos];
                proximoOrden = 1003;
                historialEntregados = [...datosIniciales.historialEntregados];
                historialMensajes = [];
                window.pedidos = [];
                pedidos = window.pedidos;
                guardarDatos();
            }
        }

        function guardarDatos() {
            const datos = {
                reparaciones: reparaciones,
                tecnicos: tecnicos,
                proximoOrden: proximoOrden,
                historialEntregados: historialEntregados,
                historialMensajes: historialMensajes
            };
            datos.pedidos = pedidos;
            localStorage.setItem('fixlytallerData', JSON.stringify(datos));
        }

        function obtenerFechaActual() {
            return new Date().toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function actualizarKPIs() {
            const hoy = new Date().toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const reparacionesHoy = reparaciones.filter(r => r.fecha === hoy).length;
            const enProceso = reparaciones.filter(r => ['recibido', 'diagnosticando'].includes(r.estado)).length;
            const listos = reparaciones.filter(r => r.estado === 'listo').length;
            const totalClientes = new Set([...reparaciones.map(r => r.cliente), ...historialEntregados.map(r => r.cliente)]).size;
            
            document.getElementById('kpi-hoy').textContent = reparacionesHoy;
            document.getElementById('kpi-proceso').textContent = enProceso;
            document.getElementById('kpi-listos').textContent = listos;
            document.getElementById('kpi-clientes').textContent = totalClientes;
        }

        function cargarTecnicos() {
            const selectTecnico = document.getElementById('select-tecnico');
            const editTecnico = document.getElementById('edit-tecnico');
            const filterTecnico = document.getElementById('filter-tecnico');
            const filtroTecnicoHistorial = document.getElementById('filtro-tecnico-historial');
            
            [selectTecnico, editTecnico, filterTecnico, filtroTecnicoHistorial].forEach(select => {
                if (select) {
                    // Limpiar opciones existentes (excepto la primera)
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    tecnicos.forEach(tecnico => {
                        const option = document.createElement('option');
                        option.value = tecnico.nombre;
                        option.textContent = `${tecnico.nombre} - ${tecnico.especialidad}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function initializeCharts() {
            // Gráfico de estados
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                const estadosCount = {
                    recibido: reparaciones.filter(r => r.estado === 'recibido').length,
                    diagnosticando: reparaciones.filter(r => r.estado === 'diagnosticando').length,
                    listo: reparaciones.filter(r => r.estado === 'listo').length,
                    entregado: historialEntregados.length
                };

                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Recibido', 'Diagnosticando', 'Listo', 'Entregado'],
                        datasets: [{
                            data: [estadosCount.recibido, estadosCount.diagnosticando, estadosCount.listo, estadosCount.entregado],
                            backgroundColor: ['#fef3c7', '#dbeafe', '#d1fae5', '#e5e7eb']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Gráfico de ingresos
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Ingresos',
                            data: [120000, 150000, 180000, 140000, 200000, 250000],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function cargarTablaReparaciones() {
            const tbody = document.getElementById('tabla-reparaciones');
            tbody.innerHTML = '';
            
            reparaciones.forEach(reparacion => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">#${reparacion.id}</td>
                    <td class="py-3 px-4">${reparacion.cliente}</td>
                    <td class="py-3 px-4">${reparacion.equipo}</td>
                    <td class="py-3 px-4">
                        <span class="status-badge status-${reparacion.estado}">${reparacion.estado}</span>
                    </td>
                    <td class="py-3 px-4">${reparacion.tecnico}</td>
                    <td class="py-3 px-4">${reparacion.fecha}</td>
                    <td class="py-3 px-4">
                        <div class="flex gap-2">
            <button onclick="imprimirComprobante('${reparacion.id}')" class="btn-print-orange text-white p-2 rounded" title="Imprimir">
                <i class="fas fa-print"></i>
            </button>
            <button onclick="editarEstadoEquipo('${reparacion.id}')" class="bg-purple-600 text-white p-2 rounded hover:bg-purple-700" title="Estado Equipo">
                <i class="fas fa-tools"></i>
            </button>
                            <button onclick="editarReparacion('${reparacion.id}')" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="enviarWhatsApp('${reparacion.id}')" class="bg-green-600 text-white p-2 rounded hover:bg-green-700" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function cargarTablaHistorial() {
            const tbody = document.getElementById('tabla-historial');
            tbody.innerHTML = '';
            
            historialEntregados.forEach(equipo => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                row.innerHTML = `                    <td class="py-3 px-4 font-medium">#${equipo.id}</td>
                    <td class="py-3 px-4">${equipo.cliente}</td>
                    <td class="py-3 px-4">${equipo.equipo}</td>
                    <td class="py-3 px-4">${equipo.tecnico}</td>
                    <td class="py-3 px-4">${equipo.fecha}</td>
                    <td class="py-3 px-4">${equipo.fechaEntrega}</td>
                    <td class="py-3 px-4">
                        <div class="flex gap-2">
                            <button onclick="verDetalleHistorial('${equipo.id}')" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="imprimirHistorial('${equipo.id}')" class="btn-print-orange text-white p-2 rounded" title="Reimprimir">
                                <i class="fas fa-print"></i>
                            </button>
                            <button onclick="eliminarHistorial('${equipo.id}')" class="bg-red-600 text-white p-2 rounded hover:bg-red-700" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
            `;
                
                tbody.appendChild(row);
            });
        }

        function configurarFiltros() {
            const filtroBusqueda = document.getElementById('filtro-busqueda');
            const filtroEstado = document.getElementById('filtro-estado');
            const filtroTecnico = document.getElementById('filter-tecnico');
            
            [filtroBusqueda, filtroEstado, filtroTecnico].forEach(filtro => {
                if (filtro) {
                    filtro.addEventListener('input', aplicarFiltros);
                    filtro.addEventListener('change', aplicarFiltros);
                }
            });

            // Filtros para historial
            const filtroHistorial = document.getElementById('filtro-historial');
            const filtroMes = document.getElementById('filtro-mes');
            const filtroTecnicoHistorial = document.getElementById('filtro-tecnico-historial');
            
            [filtroHistorial, filtroMes, filtroTecnicoHistorial].forEach(filtro => {
                if (filtro) {
                    filtro.addEventListener('input', aplicarFiltrosHistorial);
                    filtro.addEventListener('change', aplicarFiltrosHistorial);
                }
            });
        }

        function aplicarFiltros() {
            const busqueda = document.getElementById('filtro-busqueda').value.toLowerCase();
            const estado = document.getElementById('filtro-estado').value;
            const tecnico = document.getElementById('filter-tecnico').value;
            
            const filas = document.querySelectorAll('#tabla-reparaciones tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                const estadoFila = fila.querySelector('.status-badge').textContent.toLowerCase();
                const tecnicoFila = fila.cells[4].textContent;
                
                const coincideBusqueda = texto.includes(busqueda);
                const coincideEstado = !estado || estadoFila === estado;
                const coincideTecnico = !tecnico || tecnicoFila === tecnico;
                
                if (coincideBusqueda && coincideEstado && coincideTecnico) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }

        function aplicarFiltrosHistorial() {
            const busqueda = document.getElementById('filtro-historial').value.toLowerCase();
            const mes = document.getElementById('filtro-mes').value;
            const tecnico = document.getElementById('filtro-tecnico-historial').value;
            
            const filas = document.querySelectorAll('#tabla-historial tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                const fechaEntrega = fila.cells[5].textContent;
                const tecnicoFila = fila.cells[3].textContent;
                
                const coincideBusqueda = texto.includes(busqueda);
                const coincideMes = !mes || fechaEntrega.includes('/' + mes + '/');
                const coincideTecnico = !tecnico || tecnicoFila === tecnico;
                
                if (coincideBusqueda && coincideMes && coincideTecnico) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }

        // FUNCIONES DE MODALES
        function showNuevaReparacion() {
            document.getElementById('nueva-reparacion-modal').classList.add('show');
            // Resetear scroll del modal
            const modalContent = document.querySelector('#nueva-reparacion-modal .modal-content');
            modalContent.scrollTop = 0;
        }

        function hideNuevaReparacion() {
            document.getElementById('nueva-reparacion-modal').classList.remove('show');
            document.getElementById('formNuevaReparacion').reset();
            document.getElementById('nueva-messages').innerHTML = '';
        }

        function showEditEstado(ordenId) {
            const reparacion = reparaciones.find(r => r.id === ordenId);
            if (!reparacion) return;

            reparacionEditando = reparacion;
            
            document.getElementById('edit-cliente').value = reparacion.cliente;
            document.getElementById('edit-equipo').value = reparacion.equipo;
            document.getElementById('edit-estado').value = reparacion.estado;
            document.getElementById('edit-tecnico').value = reparacion.tecnico;
            document.getElementById('edit-costo').value = reparacion.costoEstimado;
            
            // Resetear mensajes
            document.getElementById('edit-messages').innerHTML = '';
            
            document.getElementById('edit-estado-modal').classList.add('show');
        }

        function hideEditEstado() {
            document.getElementById('edit-estado-modal').classList.remove('show');
            reparacionEditando = null;
        }

        // Mostrar el modal de estado del equipo
        function showEstadoEquipo(ordenId) {
            const reparacion = reparaciones.find(r => r.id === ordenId);
            if (!reparacion) return;
            reparacionEditandoEstado = reparacion;
            document.getElementById('estado-equipo-cliente').value = reparacion.cliente;
            document.getElementById('estado-equipo-equipo').value = reparacion.equipo;
            document.getElementById('estado-equipo-resultado').value = reparacion.estadoEquipo || '';
            document.getElementById('estado-equipo-messages').innerHTML = '';
            document.getElementById('estado-equipo-modal').classList.add('show');
        }

        // Ocultar el modal de estado del equipo
        function hideEstadoEquipo() {
            document.getElementById('estado-equipo-modal').classList.remove('show');
            reparacionEditandoEstado = null;
        }

        // Abrir el modal de estado del equipo desde las acciones
        function editarEstadoEquipo(ordenId) {
            showEstadoEquipo(ordenId);
        }

        // Guardar el resultado del estado del equipo
        function guardarEstadoEquipo() {
            if (!reparacionEditandoEstado) return;
            const resultado = document.getElementById('estado-equipo-resultado').value;
            // Asignar la propiedad estadoEquipo al objeto
            reparacionEditandoEstado.estadoEquipo = resultado;
            // Mensaje de confirmación
            mostrarMensaje('success', 'Estado del equipo actualizado exitosamente.', 'estado-equipo-messages');
            guardarDatos();
            cargarTablaReparaciones();
            cargarTablaHistorial();
            if (typeof cargarReparacionesEnSelect === 'function') {
                cargarReparacionesEnSelect();
            }
            if (typeof actualizarKPIs === 'function') {
                actualizarKPIs();
            }
            setTimeout(() => {
                hideEstadoEquipo();
            }, 1500);
        }

        function verDetalleHistorial(equipoId) {
            const equipo = historialEntregados.find(e => e.id === equipoId);
            if (!equipo) return;

            equipoDetalleActual = equipo;

            const detalleContent = document.getElementById('detalle-content');
            detalleContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-700">Información del Cliente</h4>
                        <p><strong>Cliente:</strong> ${equipo.cliente}</p>
                        <p><strong>DNI:</strong> ${equipo.dni}</p>
                        <p><strong>Teléfono:</strong> ${equipo.telefono}</p>
                        <p><strong>Email:</strong> ${equipo.email}</p>
                        <p><strong>Dirección:</strong> ${equipo.direccion}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Información del Equipo</h4>
                        <p><strong>Orden:</strong> #${equipo.id}</p>
                        <p><strong>Equipo:</strong> ${equipo.equipo}</p>
                        <p><strong>IMEI:</strong> ${equipo.imei}</p>
                        <p><strong>Problema:</strong> ${equipo.problema}</p>
                        <!-- Observaciones del equipo (no accesorios) -->
                        <p><strong>Observaciones:</strong> ${equipo.observaciones || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Información de Reparación</h4>
                        <p><strong>Técnico:</strong> ${equipo.tecnico}</p>
                        <p><strong>Fecha Ingreso:</strong> ${equipo.fecha}</p>
                        <p><strong>Fecha Entrega:</strong> ${equipo.fechaEntrega}</p>
                        <p><strong>Estado:</strong> <span class="status-badge status-entregado">Entregado</span></p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Información Económica</h4>
                        <p><strong>Anticipo:</strong> $${equipo.anticipo.toLocaleString()}</p>
                        <p><strong>Costo Final:</strong> $${equipo.costoEstimado.toLocaleString()}</p>
                        <p><strong>Saldo:</strong> $${(equipo.costoEstimado - equipo.anticipo).toLocaleString()}</p>
                    </div>
                </div>
            `;

            cargarNotasHistorial();
            document.getElementById('detalle-historial-modal').classList.add('show');
        }

        function hideDetalleHistorial() {
            document.getElementById('detalle-historial-modal').classList.remove('show');
            equipoDetalleActual = null;
        }

        function cargarNotasHistorial() {
            if (!equipoDetalleActual) return;

            const notasContainer = document.getElementById('notas-historial');
            notasContainer.innerHTML = '';

            if (equipoDetalleActual.notas && equipoDetalleActual.notas.length > 0) {
                equipoDetalleActual.notas.forEach((nota, index) => {
                    const notaDiv = document.createElement('div');
                    notaDiv.className = 'bg-gray-50 p-3 rounded-lg mb-2 flex justify-between items-center';
                    notaDiv.innerHTML = `
                        <span>${nota}</span>
                        <button onclick="eliminarNota(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    `;
                    notasContainer.appendChild(notaDiv);
                });
            } else {
                notasContainer.innerHTML = '<p class="text-gray-500 italic">No hay notas adicionales</p>';
            }
        }

        function agregarNota() {
            if (!equipoDetalleActual) return;

            const nuevaNota = document.getElementById('nueva-nota').value.trim();
            if (!nuevaNota) return;

            if (!equipoDetalleActual.notas) {
                equipoDetalleActual.notas = [];
            }

            equipoDetalleActual.notas.push(nuevaNota);
            
            // Actualizar en historialEntregados
            const index = historialEntregados.findIndex(e => e.id === equipoDetalleActual.id);
            if (index !== -1) {
                historialEntregados[index] = equipoDetalleActual;
            }

            guardarDatos();
            cargarNotasHistorial();
            document.getElementById('nueva-nota').value = '';
        }

        function eliminarNota(index) {
            if (!equipoDetalleActual || !equipoDetalleActual.notas) return;

            if (confirm('¿Estás seguro de que deseas eliminar esta nota?')) {
                equipoDetalleActual.notas.splice(index, 1);
                
                // Actualizar en historialEntregados
                const equipoIndex = historialEntregados.findIndex(e => e.id === equipoDetalleActual.id);
                if (equipoIndex !== -1) {
                    historialEntregados[equipoIndex] = equipoDetalleActual;
                }

                guardarDatos();
                cargarNotasHistorial();
            }
        }

        function reingresarPorGarantia() {
            if (!equipoDetalleActual) return;

            if (confirm('¿Deseas reingresar este equipo por garantía? Se creará una nueva orden de reparación.')) {
                const nuevaReparacion = {
                    ...equipoDetalleActual,
                    id: proximoOrden.toString(),
                    estado: 'recibido',
                    fecha: obtenerFechaActual(),
                    problema: 'Reingreso por garantía - ' + equipoDetalleActual.problema,
                    anticipo: 0,
                    costoEstimado: 0,
                    fechaEntrega: null
                };

                delete nuevaReparacion.notas;

                reparaciones.push(nuevaReparacion);
                proximoOrden++;

                guardarDatos();
                cargarTablaReparaciones();
                cargarReparacionesEnSelect();
                actualizarKPIs();

                hideDetalleHistorial();
                showSection('reparaciones');

                mostrarMensaje('success', `Equipo reingresado por garantía con orden #${nuevaReparacion.id}`, 'nueva-messages');
            }
        }

        // Cerrar modales al hacer clic fuera de ellos
        document.addEventListener('click', function(event) {
            const modalNueva = document.getElementById('nueva-reparacion-modal');
            const modalEdit = document.getElementById('edit-estado-modal');
            const modalDetalle = document.getElementById('detalle-historial-modal');
            
            if (event.target === modalNueva) {
                hideNuevaReparacion();
            }
            if (event.target === modalEdit) {
                hideEditEstado();
            }
            if (event.target === modalDetalle) {
                hideDetalleHistorial();
            }
        });

        // FUNCIONES DE GUARDADO
        function guardarNuevaReparacion() {
            const formData = new FormData(document.getElementById('formNuevaReparacion'));
            
            const nuevaReparacion = {
                id: proximoOrden.toString(),
                cliente: formData.get('cliente'),
                dni: formData.get('dni') || '',
                telefono: formData.get('telefono'),
                email: formData.get('email') || '',
                direccion: formData.get('direccion') || '',
                equipo: formData.get('equipo'),
                imei: formData.get('imei') || '',
                estado: 'recibido',
                tecnico: formData.get('tecnico') || '',
                fecha: obtenerFechaActual(),
                problema: formData.get('problema'),
                anticipo: parseInt(formData.get('anticipo')) || 0,
                costoEstimado: 0,
                accesorios: formData.get('accesorios') || '',
                observaciones: (formData.get('observaciones') || '').trim()

            };
            
            reparaciones.push(nuevaReparacion);
            proximoOrden++;
            
            guardarDatos();
            cargarTablaReparaciones();
            cargarReparacionesEnSelect();
            actualizarKPIs();
            
            mostrarMensaje('success', 'Reparación guardada exitosamente.', 'nueva-messages');
            
            setTimeout(() => {
                hideNuevaReparacion();
            }, 1500);
        }

        function guardarCambiosEstado() {
            if (!reparacionEditando) return;

            const nuevoEstado = document.getElementById('edit-estado').value;
            const nuevoTecnico = document.getElementById('edit-tecnico').value;
            const nuevoCosto = parseInt(document.getElementById('edit-costo').value) || reparacionEditando.costoEstimado;

            // Actualizar la reparación
            reparacionEditando.estado = nuevoEstado;
            if (nuevoTecnico) reparacionEditando.tecnico = nuevoTecnico;
            reparacionEditando.costoEstimado = nuevoCosto;

            // Si el estado cambia a 'entregado', mover al historial
            if (nuevoEstado === 'entregado') {
                // Agregar fecha de entrega
                reparacionEditando.fechaEntrega = obtenerFechaActual();
                
                // Mover al historial
                historialEntregados.push({...reparacionEditando});
                
                // Remover de reparaciones activas
                const index = reparaciones.findIndex(r => r.id === reparacionEditando.id);
                if (index !== -1) {
                    reparaciones.splice(index, 1);
                }
                
                mostrarMensaje('success', 'Reparación marcada como entregada y archivada en el historial.', 'edit-messages');
            } else {
                mostrarMensaje('success', 'Estado actualizado exitosamente.', 'edit-messages');
            }

            guardarDatos();
            cargarTablaReparaciones();
            cargarTablaHistorial();
            cargarReparacionesEnSelect();
            actualizarKPIs();
            
            setTimeout(() => {
                hideEditEstado();
            }, 1500);
        }

        // FUNCIONES DE ACCIONES DE REPARACIÓN
        
        function imprimirComprobante(ordenId) {
            // Buscar coincidencia por ID tratando ambas como cadenas para evitar problemas de tipo
            const reparacion = reparaciones.find(r => String(r.id) === String(ordenId))
                               || historialEntregados.find(r => String(r.id) === String(ordenId));
            if (!reparacion) return;

            // Cargar datos del taller para personalizar el comprobante
            let nombre_taller = 'Fixly Taller', direccion = '', telefono = '', email = '';
            try {
                const raw = localStorage.getItem('fixlytallerData');
                if (raw) {
                    const d = JSON.parse(raw);
                    if (d) {
                        const cfg = d.configTaller || d.config;
                        if (cfg) {
                            // compatibilidad con distintos nombres de propiedad
                            nombre_taller = cfg.nombre || cfg.nombre_taller || nombre_taller;
                            direccion = cfg.direccion || direccion;
                            telefono = cfg.telefono || telefono;
                            email = cfg.email || email;
                        }
                    }
                }
            } catch (e) { /* ignore errors, use defaults */ }

            const ventanaImpresion = window.open('', '_blank');
            // Construir una línea con la información del taller para encabezado y pie de página.
            const infoTaller = [nombre_taller, direccion, telefono, email].filter(Boolean).join(' • ');

            ventanaImpresion.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Comprobante #${reparacion.id}</title>
                    <style>
  @page { size: A4; margin: 10mm; }
  body { font-family: Arial, sans-serif; margin:0; padding:0; width:190mm; margin-left:auto; margin-right:auto; font-size:14pt; line-height:1.2; }
  .print-header { text-align:center; margin-bottom:8pt; border-bottom:1px solid #000; padding-bottom:4pt; }
  .print-title { font-size:20pt; font-weight:700; margin-bottom:2pt; }
  .print-subtitle{ font-size:18pt; font-weight:700; margin-bottom:3pt; }
  .print-order{ font-size:19pt; font-weight:700; margin-bottom:6pt; }
  .print-section{ margin-bottom:10pt; }
  .print-row{ display:flex; margin-bottom:6pt; }
  .print-label{ font-weight:700; width:68pt; flex-shrink:0; font-size:15pt; }
  .print-value{ flex:1; margin-right:8pt; font-size:15pt; }
  /* Asegura que los valores apilados (como Observaciones) aparezcan debajo de la etiqueta
     y no se superpongan ni fluyan horizontalmente.  La clase print-row--stack indica
     que el valor debe ocupar toda la línea bajo su etiqueta. */
  .print-row.print-row--stack .print-value{
    margin-left:68pt;
    white-space: pre-wrap;
    display:block;
  }
  .print-separator{ height:10pt; margin:8pt 0; border-top:1px dashed #999; }
  .print-footer{ margin-top:10pt; font-size:13pt; border-top:1px solid #000; padding-top:6pt; line-height:1.25;  text-align: center;  }
  @media print { .print-header, .print-section, .print-footer { page-break-inside: avoid; } html, body { height:auto; overflow:hidden; } body { zoom:0.98; } }
</style>
                
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head>
                <body>
                    <div class="print-header">
                        <div class="print-title">${nombre_taller}</div>
                        <div class="print-subtitle">ORIGINAL</div>
                        <div class="print-order">ORDEN #${reparacion.id}</div>
                        <!-- En la copia original no se muestran los datos del taller -->
                    </div>
                    
                    <div class="print-section">
                        <div class="print-row">
                            <div class="print-label">Cliente:</div>
                            <div class="print-value">${reparacion.cliente}</div>
                            <div class="print-label">Equipo:</div>
                            <div class="print-value">${reparacion.equipo}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">DNI:</div>
                            <div class="print-value">${reparacion.dni}</div>
                            <div class="print-label">Serie:</div>
                            <div class="print-value">${reparacion.imei}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">Tel:</div>
                            <div class="print-value">${reparacion.telefono}</div>
                        </div>
                        <div class="print-row print-row--stack">
                            <div class="print-label">Problema:</div>
                            <div class="print-value">${reparacion.problema}</div>
                        </div>
                        <div class="print-row print-row--stack">
                            <div class="print-label">Observaciones:</div>
                            <div class="print-value">${(reparacion.observaciones || '').trim() || '-'}</div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <div class="print-row">
                            <div class="print-label">Técnico:</div>
                            <div class="print-value">${reparacion.tecnico}</div>
                            <div class="print-label">Anticipo:</div>
                            <div class="print-value">$${reparacion.anticipo.toLocaleString()}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">Estado:</div>
                            <div class="print-value">${reparacion.estado.toUpperCase()}</div>
                            <div class="print-label">Total:</div>
                            <div class="print-value">$${reparacion.costoEstimado.toLocaleString()}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">Fecha:</div>
                            <div class="print-value">${reparacion.fecha}</div>
                            <div class="print-label">SALDO:</div>
                            <div class="print-value">$${(reparacion.costoEstimado - reparacion.anticipo).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    
                    
                    <div class="print-separator"></div>
                    
                    <div class="print-header">
                        <div class="print-title">${nombre_taller}</div>
                        <div class="print-subtitle">COPIA CLIENTE</div>
                        <div class="print-order">ORDEN #${reparacion.id}</div>
                     <div class="print-separator"></div>

                     
                    <div class="print-section">
                        <div class="print-row">
                            <div class="print-label">Cliente:</div>
                            <div class="print-value">${reparacion.cliente}</div>
                            <div class="print-label">Equipo:</div>
                            <div class="print-value">${reparacion.equipo}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">DNI:</div>
                            <div class="print-value">${reparacion.dni}</div>
                            <div class="print-label">Serie:</div>
                            <div class="print-value">${reparacion.imei}</div>
                        </div>

                        <div class="print-row">
                            <div class="print-label">Tel:</div>
                            <div class="print-value">${reparacion.telefono}</div>
                        </div>
                        <div class="print-row print-row--stack">
                            <div class="print-label">Problema:</div>
                            <div class="print-value">${reparacion.problema}</div>
                        </div>
                        <div class="print-row print-row--stack">
                            <div class="print-label">Observaciones:</div>
                            <div class="print-value">${(reparacion.observaciones || '').trim() || '-'}</div>
                        </div>

                    </div>
                    
                    <div class="print-section">
                        <div class="print-row">
                            <div class="print-label">Técnico:</div>
                            <div class="print-value">${reparacion.tecnico}</div>
                            <div class="print-label">Anticipo:</div>
                            <div class="print-value">$${reparacion.anticipo.toLocaleString()}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">Estado:</div>
                            <div class="print-value">${reparacion.estado.toUpperCase()}</div>
                            <div class="print-label">Total:</div>
                            <div class="print-value">$${reparacion.costoEstimado.toLocaleString()}</div>
                        </div>
                        <div class="print-row">
                            <div class="print-label">Fecha:</div>
                            <div class="print-value">${reparacion.fecha}</div>
                            <div class="print-label">SALDO:</div>
                            <div class="print-value">$${(reparacion.costoEstimado - reparacion.anticipo).toLocaleString()}</div>
                        </div>
                    </div>

  <div class="print-separator"></div>
                    
  <div class="print-footer" style="text-align: center;">
                        ${infoTaller ? `<strong>${infoTaller}</strong>` : nombre_taller}<br>
                        Las reparaciones tienen una garantía de 60 días únicamente por la misma falla reparada.<br>
                        Los repuestos están garantizados solo por defectos de fábrica.<br>
                        La garantía no cubre daños ocasionados por golpes, roturas, líquidos o uso indebido.<br>
                        Los trabajos de software y configuraciones no tienen garantía.
                    </div>
                </body>
                </html>
            `);
            
            ventanaImpresion.document.close();
const cerrar = () => { try { ventanaImpresion.close(); } catch(e){} };
try { ventanaImpresion.addEventListener('afterprint', cerrar); } catch(e){}
ventanaImpresion.onafterprint = cerrar;
setTimeout(() => {
  try { ventanaImpresion.focus(); } catch(e){}
  try { ventanaImpresion.print(); } catch(e){}
  setTimeout(cerrar, 1200);
}, 100);
ventanaImpresion.document.close();
            ventanaImpresion.focus();
            ventanaImpresion.print();
        }
        function enviarWhatsAppPedido(pedidoId){
           const p = (typeof pedidos!=='undefined' && Array.isArray(pedidos)) 
              ? pedidos.find(x=>String(x.id)===String(pedidoId)) : null;
        if(!p){ alert('Pedido no encontrado'); return; }
           const saldo = (Number(p.precio_total||0) - Number(p.sena||0)) || 0;
           const msg = `Hola ${p.cliente||''}, tu pedido: ${p.producto||''}. Total $${p.precio_total||0}. Seña $${p.sena||0}. Saldo $${saldo}. ${p.descripcion?('Notas: '+p.descripcion):''}`;
           const phone = normalizarTelefonoAR(p.telefono||'');
           window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
}

        function imprimirComprobanteHistorial(equipoId) {
            imprimirComprobante(equipoId);
        }

        function editarReparacion(ordenId) {
            showEditEstado(ordenId);
        }
function imprimirComprobantePedido(pedidoId){
  const p = (typeof pedidos!=='undefined' && Array.isArray(pedidos)) 
              ? pedidos.find(x=>String(x.id)===String(pedidoId)) : null;
  if(!p){ alert('Pedido no encontrado'); return; }
  _imprimirTicketBase({ 
    id: p.id, cliente: p.cliente, telefono: p.telefono, producto: p.producto,
    fecha: p.fecha, sena: p.sena, precio_total: p.precio_total, descripcion: p.descripcion
  }, 'PEDIDO');
}

        function enviarWhatsApp(ordenId) {
            // Cambiar a la sección de WhatsApp
            showSection('whatsapp');
            
            // Preseleccionar la reparación
            const selectReparacion = document.getElementById('select-reparacion');
            if (selectReparacion) {
                selectReparacion.value = ordenId;
                
                // Cargar datos de la reparación
                const reparacion = reparaciones.find(r => r.id === ordenId);
                if (reparacion) {
                    reparacionSeleccionada = reparacion;
                    
                    // Llenar datos del cliente
                    document.getElementById('notif-cliente').value = reparacion.cliente;
                    document.getElementById('notif-telefono').value = reparacion.telefono;
                    
                    // Configurar tipo de mensaje según el estado actual
                    const tipoMensaje = document.getElementById('tipo-mensaje');
                    let tipoSeleccionado = 'recibido'; // default
                    
                    switch (reparacion.estado) {
                        case 'recibido':
                            tipoSeleccionado = 'recibido';
                            break;
                        case 'diagnosticando':
                            tipoSeleccionado = 'diagnostico';
                            break;
                        case 'listo':
                            tipoSeleccionado = 'listo';
                            break;
                        case 'entregado':
                            tipoSeleccionado = 'recordatorio';
                            break;
                        default:
                            tipoSeleccionado = 'recibido';
                    }
                    
                    tipoMensaje.value = tipoSeleccionado;
                    
                    // Generar mensaje inmediatamente
                    generarMensaje();
                    
                    // Mostrar mensaje de confirmación
                    mostrarMensaje('success', `Reparación cargada en WhatsApp con tipo de mensaje "${tipoMensaje.options[tipoMensaje.selectedIndex].text}" según el estado "${reparacion.estado}".`, 'whatsapp-messages');
                }
            }
        }

        function eliminarReparacion(ordenId) {
            if (confirm('¿Estás seguro de que deseas eliminar esta reparación? Esta acción no se puede deshacer.')) {
                // Comparar ID como cadenas para evitar fallos cuando id es numérico o string
                const index = reparaciones.findIndex(r => String(r.id) === String(ordenId));
                if (index !== -1) {
                    reparaciones.splice(index, 1);
                    guardarDatos();
                    cargarTablaReparaciones();
                    cargarReparacionesEnSelect();
                    actualizarKPIs();
                    
                    mostrarMensaje('success', 'Reparación eliminada exitosamente.', 'nueva-messages');
                }
            }
        }

        /**
         * Elimina un registro del historial de entregados.
         * Confirma la acción y actualiza la tabla, los datos guardados y los indicadores.
         * @param {string|number} ordenId Identificador de la reparación entregada
         */
        function eliminarHistorial(ordenId) {
            if (confirm('¿Estás seguro de que deseas eliminar este registro del historial? Esta acción no se puede deshacer.')) {
                const idx = historialEntregados.findIndex(e => String(e.id) === String(ordenId));
                if (idx !== -1) {
                    historialEntregados.splice(idx, 1);
                    guardarDatos();
                    cargarTablaHistorial();
                    // Actualizar KPIs si la función existe
                    if (typeof actualizarKPIs === 'function') actualizarKPIs();
                    // Mostrar mensaje de éxito
                    if (typeof mostrarMensaje === 'function') {
                        mostrarMensaje('success', 'Registro eliminado del historial.', 'edit-messages');
                    }
                }
            }
        }

        // FUNCIONES DE WHATSAPP
        function cargarReparacionesEnSelect() {
            const select = document.getElementById('select-reparacion');
            
            // Limpiar opciones existentes (excepto la primera)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            reparaciones.forEach(reparacion => {
                const option = document.createElement('option');
                option.value = reparacion.id;
                option.textContent = `#${reparacion.id} - ${reparacion.cliente} - ${reparacion.equipo}`;
                select.appendChild(option);
            });
        }

        function cargarDatosReparacion() {
            const selectReparacion = document.getElementById('select-reparacion');
            const ordenId = selectReparacion.value;
            
            if (!ordenId) {
                document.getElementById('notif-cliente').value = '';
                document.getElementById('notif-telefono').value = '';
                document.getElementById('mensaje-preview').value = 'El mensaje se generará automáticamente...';
                document.getElementById('mensaje-controls').style.display = 'none';
                reparacionSeleccionada = null;
                return;
            }
            
            reparacionSeleccionada = reparaciones.find(r => r.id === ordenId);
            
            if (reparacionSeleccionada) {
                document.getElementById('notif-cliente').value = reparacionSeleccionada.cliente;
                document.getElementById('notif-telefono').value = reparacionSeleccionada.telefono;
                
                // Preseleccionar tipo de mensaje según el estado actual
                const tipoMensaje = document.getElementById('tipo-mensaje');
                let tipoSeleccionado = 'recibido'; // default
                
                switch (reparacionSeleccionada.estado) {
                    case 'recibido':
                        tipoSeleccionado = 'recibido';
                        break;
                    case 'diagnosticando':
                        tipoSeleccionado = 'diagnostico';
                        break;
                    case 'listo':
                        tipoSeleccionado = 'listo';
                        break;
                    case 'entregado':
                        tipoSeleccionado = 'recordatorio';
                        break;
                    default:
                        tipoSeleccionado = 'recibido';
                }
                // Si hay un estado de equipo que indique no reparable, preseleccionar ese tipo
                if (reparacionSeleccionada.estadoEquipo === 'no-reparado' || reparacionSeleccionada.estadoEquipo === 'no-repuesto' || reparacionSeleccionada.estadoEquipo === 'devolver') {
                    tipoSeleccionado = 'no-reparable';
                }
                // Si hay un estado de equipo que indique no reparable, preseleccionar ese tipo
                if (reparacion.estadoEquipo === 'no-reparado' || reparacion.estadoEquipo === 'no-repuesto' || reparacion.estadoEquipo === 'devolver') {
                    tipoSeleccionado = 'no-reparable';
                }
                
                tipoMensaje.value = tipoSeleccionado;
                generarMensaje();
            }
        }

        function enviarMensajeWhatsApp() {
            const mensaje = document.getElementById('mensaje-preview').value;
            const telefono = document.getElementById('notif-telefono').value;
            const cliente = document.getElementById('notif-cliente').value;
            
            if (!mensaje || !telefono || !reparacionSeleccionada) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            // Limpiar número de teléfono
            const telefonoLimpio = telefono.replace(/[^\d]/g, '');
            
            // Crear URL de WhatsApp
            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/${telefonoLimpio}?text=${mensajeCodificado}`;
            
            // Abrir WhatsApp
            window.open(urlWhatsApp, '_blank');
            
            // Guardar en historial
            const historialItem = {
                id: Date.now().toString(),
                cliente: cliente,
                telefono: telefono,
                mensaje: document.getElementById('tipo-mensaje').options[document.getElementById('tipo-mensaje').selectedIndex].text,
                fecha: obtenerFechaActual(),
                estado: 'enviado'
            };
            
            historialMensajes.push(historialItem);
            guardarDatos();
            cargarHistorialMensajes();
            
            mostrarMensaje('success', 'Mensaje enviado por WhatsApp', 'whatsapp-messages');
        }

        function generarMensaje() {
            const tipoMensaje = document.getElementById('tipo-mensaje').value;
            const mensajeTextarea = document.getElementById('mensaje-preview');
            
            if (!reparacionSeleccionada || !tipoMensaje) {
                mensajeTextarea.value = 'El mensaje se generará automáticamente...';
                document.getElementById('mensaje-controls').style.display = 'none';
                return;
            }
            
            let mensaje = '';
            
            switch (tipoMensaje) {
                case 'recibido':
                    mensaje = `Hola ${reparacionSeleccionada.cliente}, hemos recibido su ${reparacionSeleccionada.equipo}. Le mantendremos informado del progreso. Ticket: #${reparacionSeleccionada.id}`;
                    break;
                case 'diagnostico':
                    mensaje = `Hola ${reparacionSeleccionada.cliente}, hemos diagnosticado su ${reparacionSeleccionada.equipo}. ${reparacionSeleccionada.problema}. Costo estimado: $${reparacionSeleccionada.costoEstimado.toLocaleString()}. ¿Autoriza la reparación?`;
                    break;
                case 'listo':
                    mensaje = `¡Buenas noticias! Su ${reparacionSeleccionada.equipo} está listo para retirar. Costo total: $${reparacionSeleccionada.costoEstimado.toLocaleString()}. Horario: Lun-Vie 9-18hs, Sáb 9-13hs`;
                    break;
                case 'recordatorio':
                    mensaje = `Hola ${reparacionSeleccionada.cliente}, su ${reparacionSeleccionada.equipo} está listo para retirar desde hace varios días. Por favor coordine su retiro. Gracias.`;
                    break;
                case 'no-reparable':
                    mensaje = `Hola ${reparacionSeleccionada.cliente}, lamentablemente su ${reparacionSeleccionada.equipo} no se puede reparar debido a ${reparacionSeleccionada.problema}. Puede pasar a retirarlo sin cargo. Gracias.`;
                    break;
            }
            
            // Append the workshop name from configuration instead of a fixed label
            // Default to "Fixly Taller" but override if config provides a nombre/nombre_taller
            try {
                let nombreConf = 'Fixly Taller';
                const rawConf = localStorage.getItem('fixlytallerData');
                if (rawConf) {
                    const parsed = JSON.parse(rawConf);
                    if (parsed) {
                        const cfg = parsed.configTaller || parsed.config;
                        if (cfg) {
                            nombreConf = cfg.nombre || cfg.nombre_taller || nombreConf;
                        }
                    }
                }
                mensaje += '\n\n' + nombreConf;
            } catch (err) {
                // In case of any error reading config, fall back to default
                mensaje += '\n\nFixly Taller';
            }

            mensajeOriginal = mensaje;
            mensajeTextarea.value = mensaje;
            document.getElementById('mensaje-controls').style.display = 'flex';
        }

        function restaurarMensaje() {
            document.getElementById('mensaje-preview').value = mensajeOriginal;
            document.getElementById('edit-mode-indicator').classList.remove('show');
            modoEdicion = false;
        }

        function toggleModoEdicion() {
            modoEdicion = !modoEdicion;
            const indicator = document.getElementById('edit-mode-indicator');
            
            if (modoEdicion) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        function cargarHistorialMensajes() {
            const tbody = document.getElementById('historial-mensajes');
            tbody.innerHTML = '';
            
            historialMensajes.slice(-10).reverse().forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${item.cliente}</td>
                    <td class="py-2">${item.mensaje}</td>
                    <td class="py-2"><span class="text-green-600">${item.estado}</span></td>
                    <td class="py-2">${item.fecha}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // FUNCIÓN DE UTILIDAD PARA MOSTRAR MENSAJES
        function mostrarMensaje(tipo, mensaje, containerId) {
            const container = document.getElementById(containerId);
            const alertDiv = document.createElement('div');
            
            const colorClass = tipo === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700';
            
            alertDiv.className = `border-l-4 p-4 mb-4 ${colorClass}`;
            alertDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm">${mensaje}</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                if (container.contains(alertDiv)) {
                    container.removeChild(alertDiv);
                }
            }, 5000);
        }

        // FUNCIONES PARA MÓDULO DE PEDIDOS
        // Sincronizar el listado local de pedidos con la variable global
        let pedidos = Array.isArray(window.pedidos) ? window.pedidos : [];
        let proximoPedidoId = 1;

        function toggleSena() {
            const dejaSena = document.querySelector('input[name="deja_sena"]:checked').value;
            const senaContainer = document.getElementById('sena-container');
            
            if (dejaSena === 'si') {
                senaContainer.style.display = 'block';
            } else {
                senaContainer.style.display = 'none';
                document.querySelector('input[name="sena"]').value = '';
            }
        }

        function cargarPedidos() {
            const datos = localStorage.getItem('fixlytallerData');
            if (datos) {
                const datosParseados = JSON.parse(datos);
                pedidos = datosParseados.pedidos || [];
                proximoPedidoId = datosParseados.proximoPedidoId || 1;
            }
            actualizarListaPedidos();
        }

        function guardarPedidos() {
            const datos = JSON.parse(localStorage.getItem('fixlytallerData') || '{}');
            // Persistir pedidos tanto en la estructura general como en la clave propia
            datos.pedidos = Array.isArray(window.pedidos) ? window.pedidos : pedidos;
            datos.proximoPedidoId = proximoPedidoId;
            localStorage.setItem('fixlytallerData', JSON.stringify(datos));
            if (typeof saveToOwnKey === 'function') saveToOwnKey();
        }

        function actualizarListaPedidos() {
            // Utilizar la función centralizada para renderizar la lista si está disponible
            if (typeof window.renderListaPedidos === 'function') {
                window.renderListaPedidos();
                return;
            }
            // Si no existe la función centralizada, dejar la implementación anterior como respaldo
            const lista = document.getElementById('lista-pedidos');
            const busqueda = document.getElementById('buscar-pedidos').value.toLowerCase();
            const filtroEstadoPedidos = document.getElementById('filtro-estado-pedidos');
            const filtroEstado = filtroEstadoPedidos ? filtroEstadoPedidos.value : '';
            lista.innerHTML = '';
            const pedidosFiltrados = pedidos.filter(pedido => {
                const coincideBusqueda = pedido.cliente.toLowerCase().includes(busqueda) || 
                                       pedido.producto.toLowerCase().includes(busqueda);
                const coincideEstado = !filtroEstado || pedido.estado === filtroEstado;
                return coincideBusqueda && coincideEstado;
            });
            if (pedidosFiltrados.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-500 py-4">No hay pedidos que mostrar</div>';
                return;
            }
            pedidosFiltrados.forEach(pedido => {
                const estadoColor = {
                    'pendiente': 'bg-yellow-100 text-yellow-800',
                    'listo': 'bg-green-100 text-green-800',
                    'entregado': 'bg-gray-100 text-gray-800'
                };
                const saldo = pedido.precio_total - pedido.sena;
                const pedidoDiv = document.createElement('div');
                pedidoDiv.className = 'border border-gray-200 rounded-lg p-4 hover:bg-gray-50';
                pedidoDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-800">#${pedido.id} - ${pedido.cliente}</h4>
                            <p class="text-sm text-gray-600">${pedido.producto}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoColor[pedido.estado]}">${pedido.estado.toUpperCase()}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">
                        <p><strong>Tel:</strong> ${pedido.telefono}</p>
                        ${pedido.descripcion ? `<p><strong>Descripción:</strong> ${pedido.descripcion}</p>` : ''}
                        <p><strong>Total:</strong> $${pedido.precio_total.toLocaleString()} | <strong>Seña:</strong> $${pedido.sena.toLocaleString()} | <strong>Saldo:</strong> $${saldo.toLocaleString()}</p>
                        <p><strong>Fecha:</strong> ${pedido.fecha}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cambiarEstadoPedido('${pedido.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                            <i class="fas fa-edit mr-1"></i>Estado
                        </button>
                        <button onclick="window.eliminarPedido('${pedido.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                            <i class="fas fa-trash mr-1"></i>Eliminar
                        </button>
                        <button onclick="window.imprimirPedido('${pedido.id}')" class="btn-print-orange text-white px-3 py-1 rounded text-xs" title="Imprimir">
                            <i class="fas fa-print mr-1"></i>Imprimir
                        </button>
                        <button onclick="window.enviarWhatsAppPedido('${pedido.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700" title="WhatsApp">
                            <i class="fab fa-whatsapp mr-1"></i>WhatsApp
                        </button>
                    </div>
                `;
                lista.appendChild(pedidoDiv);
            });
        }

        function cambiarEstadoPedido(pedidoId) {
            // Utilizar la lista global de pedidos si existe
            const list = Array.isArray(window.pedidos) ? window.pedidos : pedidos;
            const pedido = list.find(p => String(p.id) === String(pedidoId));
            if (!pedido) return;
            const nuevoEstado = prompt(`Estado actual: ${pedido.estado}\n\nSeleccione nuevo estado:\n1. pendiente\n2. listo\n3. entregado\n\nIngrese el número:`);
            const estados = ['pendiente', 'listo', 'entregado'];
            const estadoIndex = parseInt(nuevoEstado) - 1;
            if (estadoIndex >= 0 && estadoIndex < estados.length) {
                pedido.estado = estados[estadoIndex];
                if (typeof saveToOwnKey === 'function') saveToOwnKey();
                if (typeof guardarPedidos === 'function') guardarPedidos();
                if (typeof window.renderListaPedidos === 'function') window.renderListaPedidos();
                else if (typeof actualizarListaPedidos === 'function') actualizarListaPedidos();
                if (typeof mostrarMensaje === 'function') {
                    mostrarMensaje('success', `Estado del pedido #${pedidoId} actualizado a "${pedido.estado}".`, 'pedidos-messages');
                }
            }
        }

        function eliminarPedido(pedidoId) {
            if (confirm('¿Estás seguro de que deseas eliminar este pedido?')) {
                // Usar el array global de pedidos si está disponible
                const list = Array.isArray(window.pedidos) ? window.pedidos : pedidos;
                const idx = list.findIndex(p => String(p.id) === String(pedidoId));
                if (idx !== -1) {
                    list.splice(idx, 1);
                    // Guardar cambios según el método disponible
                    if (typeof saveToOwnKey === 'function') saveToOwnKey();
                    if (typeof guardarPedidos === 'function') guardarPedidos();
                    // Actualizar la interfaz
                    if (typeof window.renderListaPedidos === 'function') window.renderListaPedidos();
                    else if (typeof actualizarListaPedidos === 'function') actualizarListaPedidos();
                    // Mostrar mensaje de éxito
                    if (typeof mostrarMensaje === 'function') {
                        mostrarMensaje('success', 'Pedido eliminado exitosamente.', 'pedidos-messages');
                    }
                }
            }
        }

        // FUNCIONES PARA MÓDULO DE CONFIGURACIÓN
        let configTaller = {
            nombre: 'Fixly Taller',
            direccion: 'Av. Corrientes 1234, CABA',
            telefono: '+54 11 1234-5678',
            email: 'info@fixlytaller.com'
        };

        function cargarConfiguracion() {
            const datos = localStorage.getItem('fixlytallerData');
            if (datos) {
                const datosParseados = JSON.parse(datos);
                configTaller = datosParseados.configTaller || configTaller;
            }
            cargarListaTecnicos();
        }

        function guardarConfiguracion() {
            const datos = JSON.parse(localStorage.getItem('fixlytallerData') || '{}');
            datos.configTaller = configTaller;
            localStorage.setItem('fixlytallerData', JSON.stringify(datos));
        }

        function cargarListaTecnicos() {
            const lista = document.getElementById('lista-tecnicos');
            lista.innerHTML = '';
            
            if (tecnicos.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-500 py-4">No hay técnicos registrados</div>';
                return;
            }
            
            tecnicos.forEach((tecnico, index) => {
                const tecnicoDiv = document.createElement('div');
                tecnicoDiv.className = 'border border-gray-200 rounded-lg p-3 hover:bg-gray-50';
                tecnicoDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-gray-800">${tecnico.nombre}</h4>
                            <p class="text-sm text-gray-600">${tecnico.especialidad}</p>
                        </div>
                        <button onclick="eliminarTecnico(${index})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                lista.appendChild(tecnicoDiv);
            });
        }

        function showAgregarTecnico() {
            const nombre = prompt('Nombre del técnico:');
            if (!nombre) return;
            
            const especialidad = prompt('Especialidad del técnico:');
            if (!especialidad) return;
            
            tecnicos.push({ nombre: nombre.trim(), especialidad: especialidad.trim() });
            guardarDatos();
            cargarTecnicos();
            cargarListaTecnicos();
            mostrarMensaje('success', 'Técnico agregado exitosamente.', 'config-messages');
        }

        function eliminarTecnico(index) {
            if (confirm('¿Estás seguro de que deseas eliminar este técnico?')) {
                tecnicos.splice(index, 1);
                guardarDatos();
                cargarTecnicos();
                cargarListaTecnicos();
                mostrarMensaje('success', 'Técnico eliminado exitosamente.', 'config-messages');
            }
        }

        function cambiarPassword() {
            const nuevaPassword = document.getElementById('nueva-password').value;
            const confirmarPassword = document.getElementById('confirmar-password').value;
            
            if (!nuevaPassword || !confirmarPassword) {
                mostrarMensaje('error', 'Por favor complete ambos campos de contraseña.', 'config-messages');
                return;
            }
            
            if (nuevaPassword !== confirmarPassword) {
                mostrarMensaje('error', 'Las contraseñas no coinciden.', 'config-messages');
                return;
            }
            
            if (nuevaPassword.length < 6) {
                mostrarMensaje('error', 'La contraseña debe tener al menos 6 caracteres.', 'config-messages');
                return;
            }
            
            // Guardar nueva contraseña en localStorage
            const datos = JSON.parse(localStorage.getItem('fixlytallerData') || '{}');
            datos.password = nuevaPassword;
            localStorage.setItem('fixlytallerData', JSON.stringify(datos));
            
            document.getElementById('nueva-password').value = '';
            document.getElementById('confirmar-password').value = '';
            
            mostrarMensaje('success', 'Contraseña cambiada exitosamente.', 'config-messages');
        }

        function exportarDatos() {
            const datos = localStorage.getItem('fixlytallerData');
            if (!datos) {
                mostrarMensaje('error', 'No hay datos para exportar.', 'config-messages');
                return;
            }
            
            const blob = new Blob([datos], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fixly-taller-backup-${__nowISO().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarMensaje('success', 'Datos exportados exitosamente.', 'config-messages');
        }

        function importarDatos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const datos = JSON.parse(e.target.result);
                        localStorage.setItem('fixlytallerData', JSON.stringify(datos));
                        location.reload(); // Recargar para aplicar los datos importados
                    } catch (error) {
                        mostrarMensaje('error', 'Error al importar datos. Archivo inválido.', 'config-messages');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function limpiarTodosLosDatos() {
            if (confirm('¿Estás seguro de que deseas eliminar TODOS los datos? Esta acción no se puede deshacer.')) {
                if (confirm('ÚLTIMA CONFIRMACIÓN: Se eliminarán todas las reparaciones, historial, técnicos y configuraciones. ¿Continuar?')) {
                    localStorage.removeItem('fixlytallerData');
                    location.reload();
                }
            }
        }

        // Event Listeners para los nuevos módulos
        document.addEventListener('DOMContentLoaded', function() {
            // Formulario de nuevo pedido
            const formNuevoPedido = document.getElementById('formNuevoPedido');
            if (formNuevoPedido) {
                formNuevoPedido.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Utilizar la lógica centralizada de pedidos (v7) si está disponible
                    try {
                        if (typeof window.crearNuevoPedido === 'function') {
                            window.crearNuevoPedido(new FormData(this));
                        } else {
                            // Fallback: construir el pedido de forma básica y agregar a window.pedidos
                            const formData = new FormData(this);
                            const dejaSena = formData.get('deja_sena') === 'si';
                            const sena = dejaSena ? parseInt(formData.get('sena')) || 0 : 0;
                            const pedido = {
                                id: 'P' + String(Date.now()).slice(-8),
                                cliente: formData.get('cliente') || '',
                                telefono: formData.get('telefono') || '',
                                producto: formData.get('producto') || '',
                                descripcion: formData.get('descripcion') || '',
                                deja_sena: dejaSena,
                                sena: sena,
                                precio_total: parseInt(formData.get('precio_total')) || 0,
                                saldo: Math.max((parseInt(formData.get('precio_total'))||0) - sena, 0),
                                estado: 'pendiente',
                                fecha: (typeof obtenerFechaActual === 'function') ? obtenerFechaActual() : ''
                            };
                            window.pedidos = Array.isArray(window.pedidos) ? window.pedidos : [];
                            window.pedidos.unshift(pedido);
                            // Guardar en storage mediante la función si está disponible
                            if (typeof guardarPedidos === 'function') guardarPedidos();
                            if (typeof window.renderListaPedidos === 'function') window.renderListaPedidos();
                        }
                    } catch(ex) {
                        console.error('Error al crear pedido', ex);
                    }
                    // Resetear formulario y ocultar la sección de seña
                    this.reset();
                    const senaCont = document.getElementById('sena-container');
                    if (senaCont) senaCont.style.display = 'none';
                    // Mostrar mensaje de éxito
                    if (typeof mostrarMensaje === 'function') {
                        mostrarMensaje('success', 'Pedido creado exitosamente.', 'pedidos-messages');
                    }
                });
                // Marcar el formulario como ya configurado para evitar que otros módulos añadan otro listener
                formNuevoPedido.__wired = true;
            }
            
            // Formulario de configuración del taller
            const formConfigTaller = document.getElementById('formConfigTaller');
            if (formConfigTaller) {
                formConfigTaller.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    configTaller = {
                        nombre: formData.get('nombre_taller'),
                        direccion: formData.get('direccion'),
                        telefono: formData.get('telefono'),
                        email: formData.get('email')
                    };
                    
                    guardarConfiguracion();
                    mostrarMensaje('success', 'Información del taller guardada exitosamente.', 'config-messages');
                });
            }
            
            // Filtros de pedidos
            const buscarPedidos = document.getElementById('buscar-pedidos');
            const filtroEstadoPedidos = document.getElementById('filtro-estado-pedidos');
            
            if (buscarPedidos) {
                buscarPedidos.addEventListener('input', actualizarListaPedidos);
            }
            
            if (filtroEstadoPedidos) {
                filtroEstadoPedidos.addEventListener('change', actualizarListaPedidos);
            }
            
            // Cargar datos iniciales
            cargarPedidos();
            cargarConfiguracion();
        });
  </script>
<script id="html_badge_script1">
   window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDuUXOJHRBty4VZVnGULVxJUWI0WDGypcKqoKyoaQT5GzhVwUEVoPGE1Ww0JI1fxjBDdPDETQcgOdf9TBSwVHO9PANzDwZpOZx2nFB2xRwcwPN2LSei862hJqpbl3qo5HL95T8ktHIu1X2NnmEkZlh8eWh4rWtTEvA1JA460KFjOaWVBo22dAd7La60y1xkXa%2FjqTgjfI0BME5Em3Xys9ahuK3wqViTw%2BWW6LlIkerxKnbVqr2GQHaBN0r9yDhsWkmt7REl1Y4gEZVEsc%2BmFKDfuMCKVsdK1mXcpyezIIOja%2Fnmqt1finOu3njhP0qtyjGoqcYctwwt%2B6Q1cxYOeUsPDqpu9LGiYR40pNL5nNMiVENIGpoa3KK%2BIpQhh7yhU243GwghGS1iSLYckk1xcgBuWg2f8jPv9SQq%2Bs%2BhHosmc1De9q%2BA1BRtMneDuGKkVqCSqZDDkTzU81lq1wDtNvXrz85PaZ9syC7yrENRTIFF74WrY8PGiz1mdY4Gyyi8qyMg%3D%3D";
        window.__genspark_locale = "es-ES";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDuUXOJHRBty4VZVnGULVxJUWI0WDGypcKqoKyoaQT5GzhVwUEVoPGE1Ww0JI1fxjBDdPDETQcgOdf9TBSwVHO9PANzDwZpOZx2nFB2xRwcwPN2LSei862hJqpbl3qo5HL95T8ktHIu1X2NnmEkZlh8eWh4rWtTEvA1JA460KFjOaWVBo22dAd7La60y1xkXa/jqTgjfI0BME5Em3Xys9ahuK3wqViTw+WW6LlIkerxKnbVqr2GQHaBN0r9yDhsWkmt7REl1Y4gEZVEsc+mFKDfuMCKVsdK1mXcpyezIIOja/nmqt1finOu3njhP0qtyjGoqcYctwwt+6Q1cxYOeUsPDqpu9LGiYR40pNL5nNMiVENIGpoa3KK+IpQhh7yhU243GwghGS1iSLYckk1xcgBuWg2f8jPv9SQq+s+hHosmc1De9q+A1BRtMneDuGKkVqCSqZDDkTzU81lq1wDtNvXrz85PaZ9syC7yrENRTIFF74WrY8PGiz1mdY4Gyyi8qyMg==";
  </script>
<script id="html_notice_dialog_script" src="./Fixly Taller - Sistema de Gestión Completo_files/notice_dialog.js.descargar">
   || (typeof reparaciones!=='undefined' ? reparaciones.find(e=>e.id===ordenId) : null);
  if(!r) return;

  const w = window.open('', '_blank');
  w.document.write(`<!DOCTYPE html>
  <html><head>
    <meta charset="utf-8">
    <style>
      body{font-family:Arial,sans-serif;padding:10mm;font-size:13px;line-height:1.5}
      .titulo{font-size:19px;font-weight:700;text-align:center;margin-bottom:12px}
      .bloque{margin-bottom:10px}
      .fila{margin-bottom:5px}
      .label{font-weight:700;display:inline-block;width:100px}
      .garantia{margin-top:16px;font-size:14px;font-weight:700;line-height:1.6;border-top:1px solid #000;padding-top:10px}
      .gracias{margin-top:22px;text-align:center;font-size:17px;font-weight:700}
    </style>
  
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}

        /* La función eliminarHistorial se declara en el script principal. */
</style>

</head><body>
    <div class="titulo">Fixly Taller — Copia para el Cliente</div>

    <div class="bloque">
      <div class="fila"><span class="label">Orden:</span> #${r.id}</div>
      <div class="fila"><span class="label">Cliente:</span> ${r.cliente || r.nombre || ''}</div>
      <div class="fila"><span class="label">Teléfono:</span> ${r.telefono || ''}</div>
      <div class="fila"><span class="label">Equipo:</span> ${r.equipo || r.dispositivo || ''}</div>
      <div class="fila"><span class="label">Problema:</span> ${r.problema || r.falla || ''}</div>
      <div class="fila"><span class="label">Técnico:</span> ${r.tecnico || ''}</div>
      <div class="fila"><span class="label">Fecha Entrega:</span> ${r.fechaEntrega || r.fecha || ''}</div>
    </div>

    <div class="garantia">
      Las reparaciones tienen una garantía de 60 días únicamente por la misma falla reparada.<br>
      Los repuestos están garantizados solo por defectos de fábrica.<br>
      La garantía no cubre daños ocasionados por golpes, roturas, líquidos o uso indebido.<br>
      Los trabajos de software y configuraciones no tienen garantía.
    </div>

    <div class="gracias">GRACIAS POR ELEGIRNOS</div>
  </body></html>`);
  w.document.close();
  const cerrar = ()=>{ try{ w.close(); }catch(e){} };
  try{ w.addEventListener('afterprint', cerrar); }catch(e){}
  setTimeout(()=>{ try{ w.print(); }catch(e){} setTimeout(cerrar,1200); }, 100);
}


// ==== Stubs y mejoras para evitar errores de runtime ====
function editarReparacion(id){ try { showEditEstado(id); } catch(e){ console.warn('showEditEstado no disponible', e); } }
function imprimirComprobante(id){ 
    try {
        // Comparar ID como cadenas para evitar fallos cuando id es numérico o string
        const rep = reparaciones.find(r => String(r.id) === String(id))
                   || historialEntregados.find(r => String(r.id) === String(id));
        if(!rep){ alert('No se encontró la reparación #' + id); return; }
        const w = window.open('', '_blank');
        w.document.write('<html><head><title>Comprobante #' + id + '</title>
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head><body>');
        w.document.write('<div class="print-page"><div class="print-header"><div class="print-title">Fixly Taller</div><div class="print-subtitle">Comprobante de Ingreso</div><div class="print-order">Orden #' + rep.id + '</div></div>');
        w.document.write('<div class="print-section"><div class="print-row"><span class="print-label">Cliente:</span><span class="print-value">'+rep.cliente+'</span></div>');
        w.document.write('<div class="print-row"><span class="print-label">Equipo:</span><span class="print-value">'+rep.equipo+'</span></div>');
        w.document.write('<div class="print-row"><span class="print-label">Problema:</span><span class="print-value">'+rep.problema+'</span></div>');
        w.document.write('<div class="print-row"><span class="print-label">Fecha:</span><span class="print-value">'+rep.fecha+'</span></div></div>');
        w.document.write('');
        w.document.write('<div class="print-footer">Las reparaciones tienen una garantía de 60 días únicamente por la misma falla reparada. Los repuestos están garantizados solo por defectos de fábrica. La garantía no cubre daños ocasionados por golpes, roturas, líquidos o uso indebido. Los trabajos de software y configuraciones no tienen garantía.</div>');
        w.document.write('</div></body></html>');
        w.document.close();
        w.focus();
        w.print();
        w.close();
    } catch(e){ console.error(e); alert('No se pudo imprimir.'); }
}
function imprimirHistorial(id){ 
    try{
        const eq = historialEntregados.find(e=>String(e.id)===String(id));
        if(!eq){ alert('No se encontró en historial #' + id); return; }
        const w = window.open('', '_blank');
        w.document.write('<html><head><title>Historial #' + id + '</title>
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head><body>');
        w.document.write('<div class="print-page"><div class="print-header"><div class="print-title">Fixly Taller</div><div class="print-subtitle">Comprobante de Entrega</div><div class="print-order">Orden #' + eq.id + '</div></div>');
        w.document.write('<div class="print-section"><div class="print-row"><span class="print-label">Cliente:</span><span class="print-value">'+eq.cliente+'</span></div>');
        w.document.write('<div class="print-row"><span class="print-label">Equipo:</span><span class="print-value">'+eq.equipo+'</span></div>');
        w.document.write('<div class="print-row"><span class="print-label">Problema:</span><span class="print-value">'+eq.problema+'</span></div>');
        w.document.write('<div class="print-row"><span class="print-label">Fecha Entrega:</span><span class="print-value">'+eq.fechaEntrega+'</span></div></div>');
        w.document.write('');
        w.document.write('<div class="print-footer">Gracias por elegirnos.</div>');
        w.document.write('</div></body></html>');
        w.document.close(); w.focus(); w.print(); w.close();
    } catch(e){ console.error(e); alert('No se pudo imprimir historial.'); }
}
function enviarWhatsApp(id){
    try{
        const rep = reparaciones.find(r=>r.id===id);
        if(!rep){ alert('No se encontró la reparación #' + id); return; }
        const tel = (rep.telefono || '').replace(/[^0-9]/g,'');
        const msg = encodeURIComponent(lineas.join('
'));
        const url = `https://wa.me/${tel}?text=${msg}`;
        window.open(url, '_blank');
    } catch(e){ console.error(e); alert('No se pudo abrir WhatsApp.'); }
}
function eliminarReparacion(id){
    const idx = reparaciones.findIndex(r=>r.id===id);
    if(idx===-1){ alert('No se encontró la reparación #' + id); return; }
    if(confirm('¿Eliminar la reparación #' + id + '?')){
        reparaciones.splice(idx,1);
        guardarDatos();
        cargarTablaReparaciones();
        actualizarKPIs();
    }
}


// ==== Gestión de Pedidos ====
function toggleSena(){
    const radios = document.querySelectorAll('input[name="deja_sena"]');
    const cont = document.getElementById('sena-container');
    if(!cont || radios.length===0) return;
    const si = Array.from(radios).find(r=>r.value==='si');
    const no = Array.from(radios).find(r=>r.value==='no');
    const seleccionado = Array.from(radios).find(r=>r.checked)?.value;
    cont.style.display = (seleccionado==='si') ? 'block' : 'none';
}

function crearNuevoPedido(fd){
    const pedido = {
        id: 'P' + String(Date.now()).slice(-6),
        cliente: fd.get('cliente')?.trim(),
        telefono: fd.get('telefono')?.trim(),
        producto: fd.get('producto')?.trim(),
        descripcion: fd.get('descripcion')?.trim() || '',
        deja_sena: fd.get('deja_sena') === 'si',
        sena: Number(fd.get('sena') || 0),
        precio_total: Number(fd.get('precio_total') || 0),
        estado: 'pendiente',
        fecha: obtenerFechaActual()
    };
    pedidos.unshift(pedido);
    guardarDatos();
    // limpiar form y UI
    const form = document.getElementById('formNuevoPedido');
    if(form){ form.reset(); toggleSena(); }
    const contMsg = document.getElementById('pedidos-messages');
    if(contMsg){ contMsg.innerHTML = '<div class="p-2 text-green-700 bg-green-50 rounded">Pedido creado: #' + pedido.id + '</div>'; setTimeout(()=>contMsg.innerHTML='',2500); }
    try{ renderListaPedidos(); }catch(e){ console.warn('renderListaPedidos no disponible aún', e); }
}

function renderListaPedidos(){
    const cont = document.getElementById('lista-pedidos');
    if(!cont) return;
    const q = (document.getElementById('buscar-pedidos')?.value || '').toLowerCase();
    const est = (document.getElementById('filtro-estado-pedidos')?.value || '');
    cont.innerHTML = '';
    const fil = pedidos.filter(p => {
        const matchQ = (p.cliente + ' ' + p.producto + ' ' + p.descripcion).toLowerCase().includes(q);
        const matchE = !est || p.estado === est;
        return matchQ && matchE;
    });
    if(fil.length===0){
        cont.innerHTML = '<div class="text-gray-500 text-sm">Sin pedidos.</div>';
        return;
    }
    fil.forEach(p => {
        const badge = p.estado==='pendiente' ? 'bg-yellow-100 text-yellow-800' : (p.estado==='listo' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700');
        const senaTxt = p.deja_sena ? ('$' + p.sena.toLocaleString()) : 'No';
        cont.insertAdjacentHTML('beforeend', `
            <div class="border rounded-lg p-4 flex items-start justify-between gap-4 hover:bg-gray-50">
                <div class="flex-1">
                    <div class="text-sm text-gray-500">Pedido <span class="font-semibold">#${p.id}</span> • ${p.fecha}</div>
                    <div class="font-semibold">${p.cliente}</div>
                    <div class="text-sm text-gray-700">${p.producto}</div>
                    ${p.descripcion ? `<div class="text-xs text-gray-500 mt-1">${p.descripcion}</div>` : ''}
                    <div class="mt-2 text-xs text-gray-600">Seña: <strong>${senaTxt}</strong> • Total: <strong>$${p.precio_total.toLocaleString()}</strong></div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <span class="px-2 py-1 rounded-full text-xs ${badge}">${p.estado}</span>
                    <div class="flex gap-2">
                        <button class="btn-print-orange text-white px-3 py-2 rounded" title="Imprimir" onclick="imprimirPedido('${p.id}')">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700" title="WhatsApp" onclick="whatsappPedido('${p.id}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                </div>
            </div>
        `);
    });
}

function getPedido(id){
    return pedidos.find(pp => String(pp.id)===String(id));
}

function whatsappPedido(id){
    const p = getPedido(id);
    if(!p){ alert('No se encontró el pedido ' + id); return; }
    const tel = (p.telefono || '').replace(/[^0-9]/g,'');
    if(!tel || tel.length < 6){
        alert('El teléfono del cliente está vacío o es inválido.');
        return;
    }
    const senaLine = p.deja_sena ? `Seña: $${p.sena.toLocaleString()}. ` : '';
    const msg = `Hola ${p.cliente}, tu pedido #${p.id} (${p.producto}) está *${p.estado}*. ${senaLine}Total: $${p.precio_total.toLocaleString()}. Fecha: ${p.fecha}.`;
    const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(msg);
    // Usar un <a> temporal para evitar bloqueos de popups
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    a.remove();
}
    const tel = (p.telefono || '').replace(/[^0-9]/g,'');
    const senaLine = p.deja_sena ? `Seña: $${p.sena.toLocaleString()}. ` : '';
    const msg = `Hola ${p.cliente}, tu pedido #${p.id} (${p.producto}) está *${p.estado}*. ${senaLine}Total: $${p.precio_total.toLocaleString()}. Fecha: ${p.fecha}.`;
    const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(msg);
    window.open(url, '_blank');
}


function imprimirPedido(id){
    const p = (window.pedidos||[]).find(x=>x.id===id);
    if (!p) return;

    // Datos del taller (si existen)
    let nombre_taller='Fixly Taller', direccion='', telefono='', email='';
    try{
        const raw = localStorage.getItem('fixlytallerData');
        if (raw){
            const d = JSON.parse(raw);
            if (d && d.config){
                nombre_taller = d.config.nombre_taller || nombre_taller;
                direccion = d.config.direccion || '';
                telefono = d.config.telefono || '';
                email = d.config.email || '';
            }
        }
    }catch(e){}

    const fecha = p.fecha || __fmtFecha();

    const htmlComprobante = `
    <div class="comprobante">
      <h2>${nombre_taller}</h2>
      <div class="info-local">
        ${direccion ? `📍 ${direccion}` : ''} ${telefono ? `– ${telefono}` : ''} ${email ? `– ${email}` : ''}<br>
        📅 Fecha: ${fecha}
      </div>

      <h3>Comprobante de Pedido</h3>
      <p class="nro"><strong>N° Pedido:</strong> ${p.id}</p>

      <div class="detalle"><strong>Cliente:</strong> ${p.cliente||''}</div>
      <div class="detalle"><strong>Producto/Servicio:</strong> ${p.producto||''}</div>
      <div class="detalle"><strong>Descripción:</strong> ${p.descripcion||'-'}</div>
      <div class="detalle"><strong>Precio Total:</strong> $${Number(p.precio_total||0).toLocaleString()}</div>
      <div class="detalle"><strong>Seña:</strong> $${Number(p.deja_sena ? (p.sena||0) : 0).toLocaleString()}</div>
      <div class="detalle"><strong>Saldo:</strong> $${Number(p.saldo||0).toLocaleString()}</div>
      <div class="detalle"><strong>Estado:</strong> ${(p.estado ? p.estado.toUpperCase() : 'PENDIENTE')}</div>

      <div class="footer">
        ✅ Gracias por confiar en <strong>${nombre_taller}</strong><br>
        Cualquier consulta, estamos a disposición.
      </div>
    </div>`;

    const style = `
      @page { size: A4; margin: 12mm; }
      body { font-family: Arial, sans-serif; color:#000; }
      .comprobante {
        width: 100%;
        max-width: 700px;
        margin: 0 auto;
        border: 1px solid #333;
        padding: 20px;
        border-radius: 8px;
      }
      .comprobante h2 { text-align:center; margin:0 0 10px; }
      .info-local { text-align:center; margin-bottom: 15px; font-size:17px; }
      h3 { text-align:center; margin: 15px 0; }
      .nro { text-align:center; margin: 0 0 10px; }
      .detalle { margin: 6px 0; font-size:18px; }
      .detalle strong { display:inline-block; width: 180px; }
      .footer { text-align:center; margin-top: 20px; font-size:17px; border-top: 1px dashed #555; padding-top: 10px; }
      @media print {
        body { margin:0;  margin-top: 15mm; margin-bottom: 15mm; line-height: 1.6; }
      }
    `;

    const win = window.open('', '_blank');
    win.document.write(`<!doctype html><html><head><meta charset="UTF-8"><title>Imprimir Pedido ${p.id}</title><style>${style}</style>
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head><body>${htmlComprobante}</body></html>`);
    win.document.close();
    win.focus();
    try { win.print(); } catch(e){}
    // No cerramos automáticamente por si se quiere reintentar
}
function enviarWhatsAppPedido(pedidoId){
    try{
        let p = null;
        if (typeof getPedido === 'function') {
            p = getPedido(pedidoId);
        } else if (Array.isArray(window.pedidos)) {
            p = window.pedidos.find(x=>String(x.id)===String(pedidoId));
        }
        if(!p){
            alert('Pedido no encontrado (#' + pedidoId + ')');
            return;
        }
        const tel = normalizarTelefonoAR(p.telefono);
        if(!tel || tel.length < 10){
            alert('El teléfono del cliente está vacío o es inválido.');
            return;
        }
        const senaLine = p.deja_sena ? `Seña: $${Number(p.sena||0).toLocaleString()}. ` : '';
        const msg = `Hola ${p.cliente}, tu pedido #${p.id} (${p.producto}) está *${p.estado}*. ${senaLine}Total: $${Number(p.precio_total||0).toLocaleString()}. Fecha: ${p.fecha}.`;
        const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(msg);
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel = 'noopener';
        document.body.appendChild(a); a.click(); a.remove();
    }catch(e){
        console.error('enviarWhatsAppPedido error', e);
        alert('No se pudo abrir WhatsApp para este pedido.');
    }
}


// === Impresión robusta para Pedidos ===
function _imprimirTicketBase(htmlBody){
    try{
        let iframe = document.getElementById('print_iframe_me');
        if(!iframe){
            iframe = document.createElement('iframe');
            iframe.id = 'print_iframe_me';
            iframe.style.position = 'fixed';
            iframe.style.right = '0'; iframe.style.bottom = '0';
            iframe.style.width = '0'; iframe.style.height = '0';
            iframe.style.border = '0';
            document.body.appendChild(iframe);
        }
        const styles = (document.querySelector('style')?.innerHTML || '');
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`<html><head><title>Impresión</title><style>${styles}</style>
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head><body>${htmlBody}</body></html>`);
        doc.close();
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
    }catch(err){
        console.error('Error al imprimir:', err);
        alert('No se pudo imprimir el comprobante.');
    }
}

function imprimirComprobantePedido(pedidoId){
    try{
        let p = null;
        if (typeof getPedido === 'function') { p = getPedido(pedidoId); }
        else if (Array.isArray(window.pedidos)) { p = window.pedidos.find(x=>String(x.id)===String(pedidoId)); }
        if(!p){ alert('Pedido no encontrado (#' + pedidoId + ')'); return; }
        // Obtener datos del taller para el encabezado
        let nombre_taller = 'Fixly Taller', direccion = '', telefono = '', email = '';
        try {
            const raw = localStorage.getItem('fixlytallerData');
            if (raw) {
                const d = JSON.parse(raw);
                if (d) {
                    const cfg = d.configTaller || d.config;
                    if (cfg) {
                        nombre_taller = cfg.nombre || cfg.nombre_taller || nombre_taller;
                        direccion = cfg.direccion || direccion;
                        telefono = cfg.telefono || telefono;
                        email = cfg.email || email;
                    }
                }
            }
        } catch (e) { /* continuar con valores por defecto */ }
        // Construir información del taller para encabezado y pie de página
        const infoTaller = [nombre_taller, direccion, telefono, email].filter(Boolean).join(' • ');

        const cuerpo = `
        <div class="print-page">
            <div class="print-header">
                <div class="print-title">${nombre_taller}</div>
                <div class="print-subtitle">Comprobante de Pedido</div>
                <div class="print-order">Pedido #${p.id}</div>
                ${infoTaller ? `<div style="font-size:10pt">${infoTaller}</div>` : ''}
            </div>
            <div class="print-section">
                <div class="print-row"><span class="print-label">Cliente:</span><span class="print-value">${p.cliente||''}</span></div>
                <div class="print-row"><span class="print-label">Teléfono:</span><span class="print-value">${p.telefono||''}</span></div>
                <div class="print-row"><span class="print-label">Producto:</span><span class="print-value">${p.producto||''}</span></div>
                ${p.descripcion ? `<div class="print-row"><span class="print-label">Descripción:</span><span class="print-value">${p.descripcion}</span></div>` : ''}
                <div class="print-row"><span class="print-label">Estado:</span><span class="print-value">${p.estado||'pendiente'}</span></div>
                <div class="print-row"><span class="print-label">Seña:</span><span class="print-value">${p.deja_sena ? ('$'+Number(p.sena||0).toLocaleString()) : 'No'}</span></div>
                <div class="print-row"><span class="print-label">Total:</span><span class="print-value">$${Number(p.precio_total||0).toLocaleString()}</span></div>
                <div class="print-row"><span class="print-label">Fecha:</span><span class="print-value">${p.fecha||''}</span></div>
            </div>
            
            <div class="print-footer">
                ${(infoTaller || nombre_taller)}<br>
                Las reparaciones tienen una garantía de 60 días únicamente por la misma falla reparada. Los repuestos están garantizados solo por defectos de fábrica. La garantía no cubre daños ocasionados por golpes, roturas, líquidos o uso indebido. Los trabajos de software y configuraciones no tienen garantía.
            </div>
        </div>`;
        _imprimirTicketBase(cuerpo);
    }catch(e){
        console.error('imprimirComprobantePedido error', e);
        alert('No se pudo imprimir el pedido.');
    }
}
  </script>
<script>
   // ================== MÓDULO DE PEDIDOS (v7 STRICT) ==================
(function(){
    const KEY = 'fixlytallerPedidos';
    window.pedidos = Array.isArray(window.pedidos) ? window.pedidos : [];

    function loadFromOwnKey(){
        try{
            const raw = localStorage.getItem(KEY);
            if (raw){ const arr = JSON.parse(raw); if (Array.isArray(arr)) window.pedidos = arr; }
        }catch(e){ console.warn('No se pudo leer pedidos propios', e); }
    }
    function saveToOwnKey(){
        try{ localStorage.setItem(KEY, JSON.stringify(window.pedidos||[])); }catch(e){ console.warn('No se pudo guardar pedidos', e); }
    }
    function maybeMergeWithMain(){
        try{
            const raw = localStorage.getItem('fixlytallerData');
            if (!raw) return;
            const data = JSON.parse(raw);
            if (!data || !Array.isArray(data.pedidos)) return;
            if ((window.pedidos||[]).length === 0 && data.pedidos.length > 0){
                window.pedidos = data.pedidos;
                saveToOwnKey();
            }
        }catch(e){ console.warn('No se pudo sincronizar con data general', e); }
    }

    window.obtenerFechaActual = window.obtenerFechaActual || function(){
        const d = new Date();
        const pad = n => String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    function normalizarTelefono(t){
        if(!t) return '';
        return (''+t).replace(/\\D+/g,'');
    }

    window.crearNuevoPedido = function(fd){
        try{
            const obj = (fd instanceof FormData) ? Object.fromEntries(fd.entries()) : (fd||{});
            const id = 'P' + String(Date.now()).slice(-8);
            const dejaSena = (obj.deja_sena === 'si');
            const senaNum = Number(obj.sena || 0);
            const totalNum = Number(obj.precio_total || 0);
            const saldo = Math.max(totalNum - senaNum, 0);
            const pedido = {
                id,
                cliente: (obj.cliente || '').trim(),
                telefono: (obj.telefono || '').trim(),
                producto: (obj.producto || '').trim(),
                descripcion: (obj.descripcion || '').trim(),
                deja_sena: dejaSena,
                sena: senaNum,
                precio_total: totalNum,
                saldo,
                estado: 'pendiente',
                fecha: window.obtenerFechaActual()
            };
            window.pedidos.unshift(pedido);
            saveToOwnKey();
            renderListaPedidos();
            const box = document.getElementById('pedidos-messages');
            if (box){
                box.innerHTML = `<div class="mb-3 p-3 rounded-lg bg-green-50 text-green-700 border border-green-200">
                    <i class="fas fa-check mr-1"></i> Pedido creado (#${id}).
                </div>`;
                setTimeout(()=> box.innerHTML='', 2000);
            }
        }catch(e){
            console.error('crearNuevoPedido error', e);
            alert('No se pudo crear el pedido.');
        }
    };

    window.cambiarEstadoPedido = function(id, nuevo){
        const i = (window.pedidos||[]).findIndex(p=>p.id===id);
        if (i>=0){
            window.pedidos[i].estado = nuevo;
            saveToOwnKey();
            renderListaPedidos();
        }
    };

    window.eliminarPedido = function(id){
        if (!confirm('¿Eliminar este pedido?')) return;
        window.pedidos = (window.pedidos||[]).filter(p=>p.id!==id);
        saveToOwnKey();
        renderListaPedidos();
    };

    window.enviarWhatsAppPedido = function(id){
        const p = (window.pedidos||[]).find(x=>x.id===id);
        if (!p) return;
        let nombreTaller = 'Fixly Taller', direccion='', telefono='', email='';
        try{
            const raw = localStorage.getItem('fixlytallerData');
            if (raw){
                const d = JSON.parse(raw);
                if (d){
                    const cfg = d.configTaller || d.config;
                    if (cfg){
                        nombreTaller = cfg.nombre || cfg.nombre_taller || nombreTaller;
                        direccion = cfg.direccion || direccion;
                        telefono = cfg.telefono || telefono;
                        email = cfg.email || email;
                    }
                }
            }
        }catch(e){}
        const lineas = [
            `¡Hola ${p.cliente}! 👋`,
        `Gracias por confiar en ${nombreTaller} 🙌`,
        `Te compartimos el detalle de tu pedido:`,
            `Tu pedido #${p.id}`,
            `• Producto/Servicio: ${p.producto}`,
            p.descripcion ? `• Descripción: ${p.descripcion}` : null,
            `• Precio total: $${(p.precio_total||0).toLocaleString()}`,
            p.deja_sena ? `• Seña: $${(p.sena||0).toLocaleString()}` : null,
            p.deja_sena ? `• Saldo: $${(p.saldo||0).toLocaleString()}` : null,
            `• Estado: ${(p.estado ? p.estado.toUpperCase() : 'PENDIENTE')}`,
            `Fecha: ${p.fecha}`,
            `Cualquier consulta, estamos a disposición 👍`
        ].filter(Boolean);
        const msg = encodeURIComponent(lineas.join('\n'));
        const tel = normalizarTelefono(p.telefono);
        if (!tel){ alert('El pedido no tiene teléfono válido.'); return; }
        window.open(`https://wa.me/${tel}?text=${msg}`, '_blank');
    };

    window.imprimirPedido = function(id){
        const p = (window.pedidos||[]).find(x=>x.id===id);
        if (!p) return;
        let nombre_taller='Fixly Taller', direccion='', telefono='', email='';
        try{
            const raw = localStorage.getItem('fixlytallerData');
            if (raw){
                const d = JSON.parse(raw);
                if (d && d.config){
                    nombre_taller = d.config.nombre_taller || nombre_taller;
                    direccion = d.config.direccion || '';
                    telefono = d.config.telefono || '';
                    email = d.config.email || '';
                }
            }
        }catch(e){}
        const copia = (titulo) => `
        <div class="print-header">
            <div class="print-title">${nombre_taller}</div>
            <div class="print-subtitle">Pedido - ${titulo}</div>
            <div class="print-order">N.º ${p.id} - ${p.fecha}</div>
            <div style="font-size:10px">${direccion} • ${telefono} • ${email}</div>
        </div>
        <div class="print-section">
            <div class="print-row"><div class="print-label">Cliente:</div><div class="print-value">${p.cliente||''}</div></div>
            <div class="print-row"><div class="print-label">Teléfono:</div><div class="print-value">${p.telefono||''}</div></div>
        </div>
        <div class="print-section">
            <div class="print-row"><div class="print-label">Producto:</div><div class="print-value">${p.producto||''}</div></div>
            <div class="print-row"><div class="print-label">Descripción:</div><div class="print-value">${p.descripcion||'-'}</div></div>
            <div class="print-row"><div class="print-label">Estado:</div><div class="print-value" style="text-transform:uppercase">${p.estado||'PENDIENTE'}</div></div>
        </div>
        <div class="print-section">
            <div class="print-row"><div class="print-label">Precio Total:</div><div class="print-value">$${Number(p.precio_total||0).toLocaleString()}</div></div>
            <div class="print-row"><div class="print-label">Seña:</div><div class="print-value">$${Number(p.deja_sena ? (p.sena||0) : 0).toLocaleString()}</div></div>
            <div class="print-row"><div class="print-label">Saldo:</div><div class="print-value">$${Number(p.saldo||0).toLocaleString()}</div></div>
        </div>
        
        <div class="print-footer">
            * Los pedidos se reservan durante 7 días corridos salvo acuerdo distinto. Pasado ese plazo podrán liberarse los productos. Precios sujetos a disponibilidad.
        </div>`;
        const styleTag = document.querySelector('style') ? document.querySelector('style').innerHTML : '';
        const win = window.open('', '_blank');
        win.document.write(`<html><head><title>Imprimir Pedido ${p.id}</title><style>${styleTag}</style>
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head><body><div class="print-page">${copia('')}<div class="print-separator"></div>${copia('')}</div></body></html>`);
        win.document.close(); win.focus(); try{ win.print(); }catch(e){}
    };

    window.renderListaPedidos = function(){
        const cont = document.getElementById('lista-pedidos');
        if (!cont) return;
        const q = (document.getElementById('buscar-pedidos')?.value || '').toLowerCase();
        const estado = (document.getElementById('filtro-estado-pedidos')?.value || '').toLowerCase();
        const filtrados = (window.pedidos || []).filter(p => {
            const t = (p.cliente + ' ' + p.producto + ' ' + (p.descripcion||'') + ' ' + p.id).toLowerCase();
            const okQ = !q || t.includes(q);
            const okE = !estado || (String(p.estado||'').toLowerCase() === estado);
            return okQ && okE;
        });
        if (filtrados.length === 0){
            cont.innerHTML = `<div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                <i class="fas fa-info-circle mr-1"></i>No hay pedidos que coincidan.
            </div>`;
            return;
        }
        cont.innerHTML = filtrados.map(p => `
            <div class="p-4 rounded-lg border border-gray-200 bg-white flex items-start justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="font-semibold text-gray-800">#${p.id}</span>
                        <span>• ${p.fecha}</span>
                        <span class="px-2 py-0.5 rounded-full text-xs ${p.estado==='listo'?'bg-green-100 text-green-700':(p.estado==='entregado'?'bg-gray-100 text-gray-700':'bg-blue-100 text-blue-700')}">
                            ${String(p.estado||'pendiente').toUpperCase()}
                        </span>
                    </div>
                    <div class="mt-1 font-medium">${p.cliente||''} • ${p.telefono||''}</div>
                    <div class="text-sm text-gray-700 mt-1">
                        <div><span class="font-semibold">Producto:</span> ${p.producto||''}</div>
                        ${p.descripcion ? `<div><span class="font-semibold">Descripción:</span> ${p.descripcion}</div>` : ''}
                        <div class="mt-1">
                            <span class="font-semibold">Total:</span> $${Number(p.precio_total||0).toLocaleString()}
                            ${p.deja_sena ? ` • <span class="font-semibold">Seña:</span> $${Number(p.sena||0).toLocaleString()} • <span class="font-semibold">Saldo:</span> $${Number(p.saldo||0).toLocaleString()}` : ''}
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-2 shrink-0">
                    <div class="flex gap-2">
                        <button onclick="imprimirPedido('${p.id}')" class="btn-print-orange text-white px-3 py-2 rounded-lg" title="Imprimir">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="enviarWhatsAppPedido('${p.id}')" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700" title="WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button onclick="eliminarPedido('${p.id}')" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <select onchange="window.cambiarEstadoPedido('${p.id}', this.value)" class="px-2 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="pendiente" ${'pendiente'===(p.estado||'')?'selected':''}>Pendiente</option>
                            <option value="listo" ${'listo'===(p.estado||'')?'selected':''}>Listo</option>
                            <option value="entregado" ${'entregado'===(p.estado||'')?'selected':''}>Entregado</option>
                        </select>
                    </div>
                </div>
            </div>
        `).join('');
    };

    function boot(){
        try{
            loadFromOwnKey();
            maybeMergeWithMain();
            const formPedido = document.getElementById('formNuevoPedido');
            if (formPedido && !formPedido.__wired){
                formPedido.addEventListener('submit', function(e){
                    e.preventDefault();
                    window.crearNuevoPedido(new FormData(formPedido));
                });
                formPedido.__wired = true;
            }
            const buscar = document.getElementById('buscar-pedidos');
            const filtro = document.getElementById('filtro-estado-pedidos');
            if (buscar && !buscar.__wired){ buscar.addEventListener('input', window.renderListaPedidos); buscar.__wired = true; }
            if (filtro && !filtro.__wired){ filtro.addEventListener('change', window.renderListaPedidos); filtro.__wired = true; }
            window.renderListaPedidos();
        }catch(e){ console.error('boot pedidos error', e); }
    }
    if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', boot); }
    else { boot(); }
})();
// ================== FIN MÓDULO DE PEDIDOS (v7) ==================
  </script>
<script>
   // ==== OVERRIDE DURO: imprimirPedido = 1 sola copia (cliente) ====
window.imprimirPedido = function(id){
  const p = (window.pedidos||[]).find(x=>x.id===id);
  if (!p) return;

  let nombre_taller='Fixly Taller', direccion='', telefono='', email='';
  try{
    const raw = localStorage.getItem('fixlytallerData');
    if (raw){
      const d = JSON.parse(raw);
      if (d && d.config){
        nombre_taller = d.config.nombre_taller || nombre_taller;
        direccion = d.config.direccion || '';
        telefono = d.config.telefono || '';
        email = d.config.email || '';
      }
    }
  }catch(e){}

  const fecha = p.fecha || __fmtFecha();

  const comprobante = `
    <div id="comprobante" class="comprobante">
      <div style="text-align:center;border-bottom:1px solid #000;padding-bottom:6px;margin-bottom:8px;">
        <div style="font-weight:700;font-size:21px;">${nombre_taller}</div>
        <div style="font-weight:600;font-size:19px;margin-top:3px;">Comprobante de Pedido</div>
        <div style="font-size:17px;margin-top:3px;">N.º ${p.id} - ${fecha}</div>
        <div style="font-size:16px;margin-top:3px;">${[direccion, telefono, email].filter(Boolean).join(' • ')}</div>
      </div>
      <div style="margin:8px 0;">
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Cliente:</div><div>${p.cliente||''}</div></div>
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Teléfono:</div><div>${p.telefono||''}</div></div>
      </div>
      <div style="margin:8px 0;">
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Producto/Servicio:</div><div>${p.producto||''}</div></div>
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Descripción:</div><div>${p.descripcion||'-'}</div></div>
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Estado:</div><div>${(p.estado ? p.estado.toUpperCase() : 'PENDIENTE')}</div></div>
      </div>
      <div style="margin:8px 0;">
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Precio Total:</div><div>$${Number(p.precio_total||0).toLocaleString()}</div></div>
        <div ;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Seña:</div><div>$${Number(p.deja_sena ? (p.sena||0) : 0).toLocaleString()}</div></div>
        <div style="display:flex;gap:10px;font-size:16px;"><div style="width:160px;font-weight:600;">Saldo:</div><div>$${Number(p.saldo||0).toLocaleString()}</div></div>
      </div>
     <div style="margin-top:10px;font-size:13px;border-top:1px dashed #000;padding-top:6px;text-align:center;">
        * Gracias por confiar en ${nombre_taller}. Cualquier consulta, estamos a disposición.
      </div>
    </div>`;

  const styles = `
    @page { size: A4; margin: 12mm; }
    body { font-family: Arial, sans-serif; color:#000; }
    @media print {
      body * { visibility: hidden; }
      #comprobante, #comprobante * { visibility: visible; }
      #comprobante { position:absolute; left:0; top:0; width:100%; }
    }
  `;

  const win = window.open('', '_blank');
  win.document.write(`<!doctype html><html><head><meta charset="UTF-8"><title>Imprimir Pedido ${p.id}</title><style>${styles}</style>
<style>
@media print {
    body {
        margin: 10mm !important; /* márgenes reducidos */
        font-size: 12px !important; /* bajamos un punto */
    }

    .print-container {
        transform: scale(0.95); /* encoge todo un poco */
        transform-origin: top left;
        width: 100%;
    }

    h1, h2, h3 {
        margin: 4px 0 !important; /* menos espacio */
    }

    p, td, th {
        margin: 2px 0 !important;
        padding: 1px !important;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 11px; /* tablas más compactas */
    }

    table td, table th {
        padding: 2px !important;
    }
}
</style>

</head><body>${comprobante}</body></html>`);
  win.document.close();
  win.focus();
  try { win.print(); } catch(e){}
};
  </script>
<script>
   // ======== LOGIN ESTRICTO (sin auto-ingreso) ========
(function(){
  // Contenedores (con fallbacks)
  var form = document.getElementById('loginForm') || document.querySelector('form[data-login], form#formLogin, form.login-form');
  var loginScreen = document.getElementById('loginScreen') || document.querySelector('#login, .login, .login-screen');
  var mainApp = document.getElementById('mainApp') || document.querySelector('#app, .main-app, #main');

  // Siempre forzar estado inicial: mostrar login, ocultar app
  try { localStorage.removeItem('fixlytallerLoggedIn'); } catch(e){}
  if (loginScreen) loginScreen.classList.remove('hidden');
  if (mainApp) mainApp.classList.add('hidden');

  // Handler de login que pisa cualquier otro
  function __doLogin(e){
    if (e) { e.preventDefault(); e.stopImmediatePropagation(); }
    var uEl = document.getElementById('username') || document.querySelector('input[name=username], #user, [data-username]');
    var pEl = document.getElementById('password') || document.querySelector('input[type=password], [data-password]');
    var username = (uEl && uEl.value ? uEl.value : '').trim();
    var password = (pEl && pEl.value ? pEl.value : '').trim();

    // Credenciales por defecto + desde config si existe
    var cfgUser = 'admin', cfgPass = 'admin123';
    try {
      var raw = localStorage.getItem('fixlytallerData');
      if (raw) {
        var d = JSON.parse(raw);
        if (d && d.config) {
          if (d.config.usuario) cfgUser = d.config.usuario;
          if (d.config.contrasena) cfgPass = d.config.contrasena;
        }
      }
    } catch(e){}

    var ok = (username === cfgUser && password === cfgPass) ||
             (username === 'admin' && password === 'admin') ||
             (username === 'admin' && password === 'admin123');

    if (!ok) {
      alert('Usuario o contraseña incorrectos');
      return false;
    }

    try { localStorage.setItem('fixlytallerLoggedIn', '1'); } catch(e){}
    if (loginScreen) loginScreen.classList.add('hidden');
    if (mainApp) mainApp.classList.remove('hidden');
    return false;
  }

  // Si el form tenía onsubmit inline, lo redirigimos al nuestro
  if (form) {
    form.setAttribute('onsubmit', 'return window.__loginOverride(event)');
  }

  // Escucha en captura para anular otros handlers previos
  document.addEventListener('submit', function(ev){
    if (!form || !ev.target) return;
    if (ev.target === form) { __doLogin(ev); }
  }, true);

  // Exponer para onsubmit
  window.__loginOverride = __doLogin;

  // Evitar cualquier auto-login previo que intente ejecutarse después
  window.addEventListener('load', function(){
    try { localStorage.removeItem('fixlytallerLoggedIn'); } catch(e){}
    if (loginScreen) loginScreen.classList.remove('hidden');
    if (mainApp) mainApp.classList.add('hidden');
  });
})();
  </script>
<script>
   // === FIX: Contador desde P001 y evitar duplicados al guardar ===
(function(){
  const COUNTER_KEY = 'pedidoCounter_v3';

  function nextPedidoId(){
    try {
      let n = parseInt(localStorage.getItem(COUNTER_KEY) || '1', 10);
      if (!Number.isFinite(n) || n < 1) n = 1;
      const id = 'P' + String(n).padStart(3, '0');
      localStorage.setItem(COUNTER_KEY, String(n + 1));
      return id;
    } catch (e){
      return 'P' + String(Math.floor(Math.random()*999)).padStart(3,'0');
    }
  }

  // Capturar SUBMIT del form de pedidos en fase de captura y manejar nosotros (así evitamos handlers duplicados)
  document.addEventListener('submit', function(ev){
    const form = ev.target;
    if (!form || form.id !== 'formNuevoPedido') return;
    ev.preventDefault();
    ev.stopPropagation();
    ev.stopImmediatePropagation();

    if (window.__savingPedido) return;
    window.__savingPedido = true;
    setTimeout(() => { window.__savingPedido = false; }, 500);

    const fd = new FormData(form);
    const dejaSena = (fd.get('deja_sena') === 'si');
    const senaNum = dejaSena ? Number(fd.get('sena') || 0) : 0;
    const totalNum = Number(fd.get('precio_total') || 0);
    const saldoNum = Math.max(0, totalNum - senaNum);

    const pedido = {
      id: nextPedidoId(),
      cliente: (fd.get('cliente')||'').trim(),
      telefono: (fd.get('telefono')||'').trim(),
      producto: (fd.get('producto')||'').trim(),
      descripcion: (fd.get('descripcion')||'').trim(),
      deja_sena: dejaSena,
      sena: senaNum,
      precio_total: totalNum,
      saldo: saldoNum,
      estado: 'pendiente',
      fecha: (typeof obtenerFechaActual === 'function') ? obtenerFechaActual() : new Date().toLocaleDateString('es-AR')
    };

    // Guardar en memoria y localStorage
    window.pedidos = Array.isArray(window.pedidos) ? window.pedidos : [];
    window.pedidos.unshift(pedido);
    try {
      localStorage.setItem('fixlytallerPedidos', JSON.stringify(window.pedidos));
    } catch(e){ console.warn('No se pudo guardar pedidos', e); }

    // Refrescar lista (compatibilidad con dos UIs)
    if (typeof renderListaPedidos === 'function') renderListaPedidos();
    if (typeof actualizarListaPedidos === 'function') try { actualizarListaPedidos(); } catch(e){}

    // Reset UI
    try { form.reset(); } catch(e){}
    const senaContainer = document.getElementById('sena-container');
    if (senaContainer) senaContainer.style.display = 'none';
    if (typeof mostrarMensaje === 'function') mostrarMensaje('success','Pedido creado exitosamente.','pedidos-messages');
  }, true); // <= CAPTURA
})();
  </script>
<script>
   // === Render inmediato tras crear el pedido (sin recargar ni reingresar) ===
(function(){
  // Redibuja la lista con la mejor función disponible o recarga como último recurso
  function repaintPedidos(){
    try {
      if (typeof renderListaPedidos === 'function') { renderListaPedidos(); return; }
      if (typeof actualizarListaPedidos === 'function') { actualizarListaPedidos(); return; }
      // Si existe un inicializador global
      if (typeof initPedidos === 'function') { initPedidos(); return; }
      // Último recurso: recarga suave
      setTimeout(function(){ location.reload(); }, 50);
    } catch(e){
      setTimeout(function(){ location.reload(); }, 50);
    }
  }

  // Si nuestro FIX de submit ya existe, lo ampliamos para repintar siempre
  document.addEventListener('submit', function(ev){
    const form = ev.target;
    if (!form || form.id !== 'formNuevoPedido') return;
    // Nuestro manejador principal ya corre en otra IIFE; acá solo añadimos el repaint post-guardado
    // Esperamos un tick para asegurar que localStorage y window.pedidos se actualizaron
    setTimeout(repaintPedidos, 80);
  }, true);

  // Además escuchamos un evento custom por si otras partes lo disparan
  window.addEventListener('pedidos:actualizado', repaintPedidos);
})();
  </script>
<script>
   // ===== Helpers país-agnóstico para WhatsApp =====
function esTelefonoValido(tel) {
  const digits = String(tel).replace(/\D/g,'');
  return digits.length >= 7 && digits.length <= 15;
}
function normalizarTelefono(tel) {
  return String(tel || '').replace(/\D/g,'');
}
function detectarCodigoPais(tel) {
  const digits = normalizarTelefono(tel);
  const codigosPais = {
    '1': 'Estados Unidos/Canadá',
    '34': 'España',
    '52': 'México',
    '54': 'Argentina',
    '55': 'Brasil',
    '57': 'Colombia',
    '58': 'Venezuela',
    '56': 'Chile',
    '51': 'Perú',
    '593': 'Ecuador',
    '44': 'Reino Unido',
    '49': 'Alemania',
    '33': 'Francia'
  };
  for (let codigo in codigosPais) {
    if (digits.startsWith(codigo)) return codigo;
  }
  return null;
}
function getPhonesByClient(){ try { return JSON.parse(localStorage.getItem('phonesByClient') || '{}'); } catch(_){ return {}; } }
function setPhonesByClient(m){ try { localStorage.setItem('phonesByClient', JSON.stringify(m)); } catch(_){ } }
function guardarTelefonoDeCliente(cliente, tel){
  const norm = normalizarTelefono(tel);
  if (!cliente || !esTelefonoValido(norm)) return false;
  const b = getPhonesByClient(); b[cliente] = norm; setPhonesByClient(b);
  try {
    document.querySelectorAll('table tr').forEach(tr=>{
      const td2 = tr.querySelector('td:nth-child(2)');
      if (td2 && td2.textContent.trim() === cliente) tr.setAttribute('data-phone', norm);
    });
  } catch(_){}
  return true;
}
function resolverTelefono(cliente, fallbackAttr) {
  let tel = normalizarTelefono(fallbackAttr);
  if (!esTelefonoValido(tel)) {
    const book = getPhonesByClient();
    if (cliente && esTelefonoValido(book[cliente])) {
      tel = normalizarTelefono(book[cliente]);
    }
  }
  if (!esTelefonoValido(tel)) {
    const ingreso = prompt(
      'Ingresá el número de teléfono con código de país:\\n\\n' +
      'Ejemplos:\\n' +
      '• +1 234 567 8900 (USA/Canadá)\\n' +
      '• +52 55 1234 5678 (México)\\n' +
      '• +54 911 1234 5678 (Argentina)\\n' +
      '• +34 612 345 678 (España)', 
      ''
    );
    if (!ingreso) return '';
    const norm = normalizarTelefono(ingreso);
    if (!esTelefonoValido(norm)) {
      alert('Número inválido. Debe tener entre 7 y 15 dígitos.');
      return '';
    }
    const codigoPais = detectarCodigoPais(norm);
    if (!codigoPais && norm.length < 10) {
      const codigoSeleccionado = prompt(
        'El número parece ser local. ¿Qué código de país usar?\\n\\n' +
        'Ejemplos: 1, 52, 54, 34, 57, etc.\\n' +
        'Déjalo vacío si ya tiene código de país',
        '1'
      );
      if (codigoSeleccionado) {
        tel = normalizarTelefono(codigoSeleccionado) + norm;
      } else {
        tel = norm;
      }
    } else {
      tel = norm;
    }
    if (cliente) guardarTelefonoDeCliente(cliente, tel);
  }
  return tel;
}
function enviarWhatsApp(telefono, mensaje) {
  try {
    const tel = normalizarTelefono(telefono);
    if (!esTelefonoValido(tel)) {
      alert('Número de teléfono inválido. Verificá el formato.');
      return;
    }
    const url = 'https://wa.me/' + tel + '?text=' + encodeURIComponent(mensaje || '');
    window.open(url, '_blank');
  } catch (e) {
    console.error('Error al abrir WhatsApp:', e);
  }
}
function armarMensaje(det) {
  // Obtener nombre del taller de la configuración o usar valor por defecto
  let taller = 'Fixly Taller';
  try {
    const rawConf = localStorage.getItem('fixlytallerData');
    if (rawConf) {
      const parsed = JSON.parse(rawConf);
      if (parsed) {
        const cfg = parsed.configTaller || parsed.config;
        if (cfg) {
          taller = cfg.nombre || cfg.nombre_taller || taller;
        }
      }
    }
  } catch (e) {
    /* si hay error, mantener el nombre por defecto */
  }
  const estado = (det.estado || '').toLowerCase();
  let textoEstado = det.estado || '';
  if (estado.includes('listo')) textoEstado = 'LISTO para retirar';
  else if (estado.includes('diagnost')) textoEstado = 'en DIAGNÓSTICO';
  else if (estado.includes('repar')) textoEstado = 'en REPARACIÓN';
  const partes = [
    `Hola ${det.cliente || ''}, te escribimos de ${taller}.`,
    det.orden ? `Reparación N° ${det.orden}` : '',
    det.equipo ? `Equipo: ${det.equipo}` : '',
    textoEstado ? `Estado: ${textoEstado}` : '',
    det.tecnico ? `Técnico/a: ${det.tecnico}` : '',
    det.fecha ? `Fecha: ${det.fecha}` : '',
    `Cualquier consulta, respondé este mensaje.`
  ].filter(Boolean);
  return partes.join('\\n');
}

function enviarWhatsAppDesdeBoton(btn) {
  try {
    // 1) Caso A: botón dentro de una fila de tabla (flujo antiguo)
    const tr = btn.closest && btn.closest('tr');
    if (tr) {
      const td = (n) => tr ? tr.querySelector('td:nth-child(' + n + ')') : null;
      const txt = (el) => (el && el.textContent ? el.textContent.trim() : '');
      const orden   = txt(td(1)).replace(/^#/, '');
      const cliente = txt(td(2));
      const equipo  = txt(td(3));
      const estado  = txt(td(4));
      const tecnico = txt(td(5));
      const fecha   = txt(td(6));
      const fallbackAttr = (btn.getAttribute('data-phone') || tr.getAttribute('data-phone') || '').trim();
      let telefono = resolverTelefono(cliente, fallbackAttr);
      telefono = solicitarTelefono(cliente, telefono);
      if (!telefono) return;
      const predef = btn.getAttribute('data-msg');
      const mensaje = predef && predef.trim() ? predef : armarMensaje({orden, cliente, equipo, estado, tecnico, fecha});
      tr.setAttribute('data-phone', telefono);
      btn.setAttribute('data-phone', telefono);
      enviarWhatsApp(telefono, mensaje);
      return;
    }
    // 2) Caso B: botón en la sección WhatsApp (formulario)
    const formSection = document.getElementById('whatsapp') || document;
    const inputCliente = formSection.querySelector('#notif-cliente');
    const inputTel = formSection.querySelector('#notif-telefono');
    const textareaMsg = formSection.querySelector('#mensaje-preview');
    const selectRep = formSection.querySelector('#select-reparacion');
    const cliente = inputCliente ? inputCliente.value.trim() : '';
    let telefono = inputTel ? normalizarTelefono(inputTel.value) : '';
    if (!esTelefonoValido(telefono)) {
      telefono = solicitarTelefono(cliente, telefono);
      if (!telefono) return;
    }
    const mensaje = (textareaMsg && textareaMsg.value.trim()) || '';
    if (!mensaje) {
      alert('No hay mensaje para enviar. Escribí o seleccioná una plantilla.');
      return;
    }
    if (cliente) guardarTelefonoDeCliente(cliente, telefono);
    enviarWhatsApp(telefono, mensaje);
  } catch (e) {
    console.error('Error desde botón WhatsApp:', e);
  }
}
);
    tr.setAttribute('data-phone', telefono);
    btn.setAttribute('data-phone', telefono);
    enviarWhatsApp(telefono, mensaje);
  } catch (e) {
    console.error('Error desde botón WhatsApp:', e);
  }
});
    tr.setAttribute('data-phone', telefono);
    btn.setAttribute('data-phone', telefono);
    enviarWhatsApp(telefono, mensaje);
  } catch (e) {
    console.error('Error desde botón WhatsApp:', e);
  }
}
  

// --- Fallback robusto para garantizar un teléfono válido ---
function solicitarTelefono(cliente, valorInicial){
  let tel = normalizarTelefono(valorInicial || '');
  // Si ya es válido, devolvemos directo
  if (esTelefonoValido(tel)) return tel;
  // Hasta 3 intentos de ingreso
  for (let i=0; i<3; i++){
    const ingreso = prompt('Ingresá el teléfono con código de país (puede ser local, ej: 11xxxxxxxx):', tel || '');
    if (ingreso === null) return ''; // usuario canceló
    tel = normalizarTelefono(ingreso);
    if (esTelefonoValido(tel)) {
      if (cliente) guardarTelefonoDeCliente(cliente, tel);
      return tel;
    }
    alert('Número inválido. Debe tener entre 7 y 15 dígitos.');
  }
  return '';
}
  </script>
<script>
   // --- Robust wrapper: ensure showSection works with 1 or 2 args and never leaves blank page
(function(){
  function toggleTo(sectionName){
    try{
      var sections = document.querySelectorAll('.section');
      if (!sections.length) return;
      sections.forEach(s => s.classList.remove('active'));
      var target = document.getElementById(sectionName) || sections[0];
      if (target) {
        target.classList.add('active');
        // Optional: sync hash/title
        try {
          if (target.id) location.hash = '#' + target.id;
        } catch(_){}
      }
    }catch(e){ console.warn('toggleTo error', e); }
  }
  var original = window.showSection;
  window.showSection = function(eventOrName, maybeName){
    var sectionName;
    if (typeof maybeName === 'string') sectionName = maybeName;
    else if (typeof eventOrName === 'string') sectionName = eventOrName;
    else sectionName = 'reparaciones';
    try{
      if (eventOrName && typeof eventOrName.preventDefault === 'function') eventOrName.preventDefault();
    }catch(_){}
    // Prefer original if exists; otherwise do our toggle
    if (typeof original === 'function') {
      try { original(eventOrName && typeof eventOrName.preventDefault==='function' ? eventOrName : null, sectionName); }
      catch(e){ console.warn('original showSection failed, using fallback', e); toggleTo(sectionName); }
    } else {
      toggleTo(sectionName);
    }
  };
  // On ready, ensure some section is visible
  document.addEventListener('DOMContentLoaded', function(){
    var active = document.querySelector('.section.active');
    if (!active) {
      var defaultId = document.getElementById('reparaciones') ? 'reparaciones' : (document.querySelector('.section')?.id || null);
      if (defaultId) window.showSection(null, defaultId);
    }
  });
})();
  </script>
<!-- === HISTORIAL LIMIT 5 + ARCHIVE TO HISTORIAL TAB === -->
<script>
(function(){
  const MAX_HISTORIAL_ROWS = 5;
  const HIST_KEY = "historialWsp";

  function loadHistorial(){
    try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch(_){ return []; }
  }
  function saveHistorial(arr){
    try { localStorage.setItem(HIST_KEY, JSON.stringify(arr)); } catch(_){}
  }

  // Render últimos N en el widget de WhatsApp
  function renderHistorial(){
    const tb = document.querySelector("#historial-mensajes");
    if (!tb) return;
    tb.innerHTML = "";
    const rows = loadHistorial();
    const slice = rows.slice(-MAX_HISTORIAL_ROWS);
    slice.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="py-1">${r.cliente}</td>
                      <td class="py-1 max-w-[320px] truncate">${r.mensaje}</td>
                      <td class="py-1">${r.estado||"ENVIADO"}</td>
                      <td class="py-1">${__fmtFecha(r.fecha)}</td>`;
      tb.prepend(tr);
    });
  }
  window.renderHistorial = renderHistorial;

  // Inserta una fila compacta en la pestaña Historial (tabla #tabla-historial)
  function appendToHistorialTab(entry){
    const tbh = document.querySelector("#tabla-historial");
    if (!tbh) return;
    const idFila = "MSG-" + (entry.seq || Date.now());
    const hoy = new Date(entry.fecha);
    const fechaStr = isNaN(hoy.getTime()) ? new Date().toLocaleDateString() : hoy.toLocaleDateString();
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-gray-50";
    tr.innerHTML = `
      <td class="py-3 px-4 font-medium">#${idFila}</td>
      <td class="py-3 px-4">${entry.cliente}</td>
      <td class="py-3 px-4">WhatsApp</td>
      <td class="py-3 px-4">${entry.tipo || '—'}</td>
      <td class="py-3 px-4">${fechaStr}</td>
      <td class="py-3 px-4">${fechaStr}</td>
      <td class="py-3 px-4">Envío de mensaje</td>`;
    tbh.prepend(tr);
  }

  // Sobrescribe/inyecta pushHistorialEnvio
  window.pushHistorialEnvio = function(cliente, mensaje, estado){
    try {
      const rows = loadHistorial();
      const entry = { cliente, mensaje, estado: estado||"ENVIADO", fecha: __nowISO(), seq: rows.length+1 };
      rows.push(entry);
      saveHistorial(rows);
      renderHistorial();
      appendToHistorialTab(entry);
    } catch(_){}
  };

  // Re-render al cargar
  document.addEventListener("DOMContentLoaded", function(){
    try{ renderHistorial(); }catch(_){}
  });
})();
</script>
<!-- === END HISTORIAL LIMIT === -->
<!-- === HISTORIAL: Controles Ver todo / Borrar === -->
<script>
(function(){
  const HIST_KEY = "historialWsp";

  function loadHistorial(){
    try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch(_){ return []; }
  }
  function saveHistorial(arr){
    try { localStorage.setItem(HIST_KEY, JSON.stringify(arr)); } catch(_){}
  }

  // UI controls under WhatsApp history table
  function ensureHistorialControls(){
    const tb = document.querySelector("#historial-mensajes");
    if (!tb) return;
    const parent = tb.parentElement; // tbody -> table
    const wrap = parent && parent.parentElement; // table -> container
    if (!wrap) return;
    let ctr = document.querySelector("#historial-wsp-controls");
    if (!ctr){
      ctr = document.createElement("div");
      ctr.id = "historial-wsp-controls";
      ctr.style.display = "flex";
      ctr.style.gap = "8px";
      ctr.style.marginTop = "8px";
      wrap.appendChild(ctr);
    }
    ctr.innerHTML = "";
    const verTodo = document.createElement("button");
    verTodo.className = "text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300";
    verTodo.textContent = "Ver todo";
    verTodo.onclick = ()=>{
      const rows = loadHistorial();
      const win = window.open("", "_blank");
      const style = "<style>body{font-family:system-ui,Segoe UI,Arial;margin:16px} table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:8px} th{background:#f3f4f6;text-align:left}</style>";
      const head = "<h2>Historial completo</h2>";
      const header = "<tr><th>Cliente</th><th>Mensaje</th><th>Estado</th><th>Fecha</th></tr>";
      const rowsHtml = rows.map(r => `<tr><td>${r.cliente}</td><td>${r.mensaje}</td><td>${r.estado||"ENVIADO"}</td><td>${__fmtFecha(r.fecha)}</td></tr>`).join("");
      win.document.write(style + head + "<table>" + header + rowsHtml + "</table>");
    };

    const borrar = document.createElement("button");
    borrar.className = "text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600";
    borrar.textContent = "Borrar historial";
    borrar.onclick = ()=>{
      if (!confirm("¿Seguro que querés borrar TODO el historial de WhatsApp?")) return;
      // limpiar localStorage
      saveHistorial([]);
      // limpiar tabla del panel WhatsApp
      const tbw = document.querySelector("#historial-mensajes");
      if (tbw) tbw.innerHTML = "";
      // limpiar filas agregadas en pestaña Historial (las que tienen id tipo #MSG-...)
      const tbh = document.querySelector("#tabla-historial");
      if (tbh){
        Array.from(tbh.querySelectorAll("tr")).forEach(tr=>{
          const first = tr.querySelector("td");
          if (first && /^#?MSG-/i.test(first.textContent.trim())) tr.remove();
        });
      }
      alert("Historial borrado.");
    };

    ctr.appendChild(verTodo);
    ctr.appendChild(borrar);
  }

  document.addEventListener("DOMContentLoaded", ensureHistorialControls);
  window.ensureHistorialControls = ensureHistorialControls;
})();
</script>
<!-- === END CONTROLES === -->
<!-- === OVERRIDE: Unificar historial WhatsApp (MAX=5) y borrar consistente === -->
<script>
(function(){
  const HIST_KEY = "historialWsp";
  const MAX_HIST = 5;

  function loadHist(){ try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch(_){ return []; } }
  function saveHist(a){ try { localStorage.setItem(HIST_KEY, JSON.stringify(a)); } catch(_){ } }

  // Renderiza desde localStorage, no desde historialMensajes
  function renderWspHistory(){
    const tbody = document.getElementById('historial-mensajes');
    if (!tbody) return;
    tbody.innerHTML = "";
    const rows = loadHist();
    const rows = loadHist();
    rows.slice(-MAX_HIST).forEach(r => {
      const tr = document.createElement('tr');
      const tipo = r.tipo || r.tipoMensaje || '';
      const fecha = new Date(r.fecha || Date.now()).toLocaleString();
      tr.innerHTML = `<td class="py-2">${r.cliente||""}</td><td class="py-2">${r.tipo||r.tipoMensaje||""}</td><td class="py-2">${new Date(r.fecha||Date.now()).toLocaleString()}</td>`;
      tbody.prepend(tr);
    });
  }
  // Override funciones existentes para que apunten a nuestro render
  window.renderHistorial = renderWspHistory;
  window.cargarHistorialMensajes = renderWspHistory;

  // Hook de envío por compatibilidad: si existe push vía historialMensajes, mantenemos sync
  const origPush = window.pushHistorialEnvio;
  window.pushHistorialEnvio = function(cliente, mensaje, estado){
    try{
      // Guardar en nuestro storage
      const rows = loadHist();
    const rows = loadHist();
    rows.slice(-MAX_HIST).forEach(r => {
      const tr = document.createElement('tr');
      const tipo = r.tipo || r.tipoMensaje || '';
      const fecha = new Date(r.fecha || Date.now()).toLocaleString();
      tr.innerHTML = `<td class="py-2">${r.cliente||""}</td><td class="py-2">${r.tipo||r.tipoMensaje||""}</td><td class="py-2">${new Date(r.fecha||Date.now()).toLocaleString()}</td>`;
      tbody.prepend(tr);
    });
  }catch(_){ } }
    if (typeof window.appendToHistorialTab === "function"){ try{ window.appendToHistorialTab({ ...entry, seq: rows.length }); }catch(_){ } }
    if (Array.isArray(window.historialMensajes)){ window.historialMensajes.push(entry); }
    if (typeof window.guardarDatos === "function"){ try{ window.guardarDatos(); }catch(_){ } }
  }

  // Wrap enviarMensajeWhatsApp
  if (typeof window.enviarMensajeWhatsApp === "function"){
    const __origEnviar = window.enviarMensajeWhatsApp;
    window.enviarMensajeWhatsApp = function(){
      const entry = captureFields();
      try { __origEnviar.apply(this, arguments); } finally { archive(entry); }
    };
  }

  // Wrap enviarWhatsAppDesdeBoton si existe
  if (typeof window.enviarWhatsAppDesdeBoton === "function"){
    const __origBtn = window.enviarWhatsAppDesdeBoton;
    window.enviarWhatsAppDesdeBot
<script>
  // Fuerza que cualquier llamada legacy a cargarHistorialMensajes use nuestro render limitado
  (function(){
    function __render5(){ try{ window.renderHistorial && window.renderHistorial(); }catch(e){} }
    window.cargarHistorialMensajes = __render5;
  })();
</script>
on = function(){
      const entry = captureFields();
      try { __origBtn.apply(this, arguments); } finally { archive(entry); }
    };
  }
})();

<!-- === END AUGMENT === -->
<!-- === FIX: Ver todo muestra datos reales (lee historialWsp y fallback de fixlytallerData) === -->
<script>
(function(){
  const HIST_KEY = "historialWsp";
  function loadHist(){
    try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch(_){ return []; }
  }
  function loadLegacy(){
    try{
      const raw = localStorage.getItem('fixlytallerData');
      if (!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data.historialMensajes) ? data.historialMensajes : [];
    }catch(_){ return []; }
  }
  function showFullHistory(){
    // Merge storages, prefer modern entries
    const a = loadHist();
    const b = loadLegacy();
    // Simple merge by stringified content to avoid duplicates
    const seen = new Set();
    const all = [];
    [...b, ...a].forEach(r=>{
      const key = JSON.stringify([r.cliente, r.mensaje, r.tipo, r.estado, r.fecha]);
      if (!seen.has(key)){ seen.add(key); all.push(r); }
    });
    // Build HTML
    const style = "<style>body{font-family:system-ui,Segoe UI,Arial;margin:16px} table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:8px} th{background:#f3f4f6;text-align:left;white-space:nowrap}</style>";
    const head = "<h2>Historial completo</h2>";
    
    const header = "<tr><th>Cliente</th><th>Mensaje</th><th>Tipo</th><th>Estado</th><th>Fecha</th></tr>";
    const rowsHtml = all.map(r => {
      const fecha = __fmtFecha(r.fecha);
      const tipo = r.tipo || r.tipoMensaje || "";
      const msg = (r.mensaje || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const cli = (r.cliente || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const est = (r.estado || "ENVIADO");
      return `<tr><td>${cli}</td><td style="max-width:520px;overflow:hidden;text-overflow:ellipsis">${msg}</td><td>${tipo}</td><td>${est}</td><td>${fecha}</td></tr>`;
    }).join("");
    
      const tipo = r.tipo || r.tipoMensaje || "";
      const msg = (r.mensaje || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const cli = (r.cliente || "").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const est = (r.estado || "ENVIADO");
      return `<tr><td>${cli}</td><td style="max-width:520px;overflow:hidden;text-overflow:ellipsis">${msg}</td><td>${tipo}</td><td>${est}</td><td>${fecha}</td></tr>`;
    }).join("");
    const w = window.open("", "_blank");
    w.document.write(style + head + "<table>" + header + rowsHtml + "</table>");
  }
  // Hook buttons that say "Ver todo"
  window.addEventListener("load", () => {
    document.querySelectorAll("#historial-wsp-controls button, button").forEach(btn=>{
      if (btn && /ver todo/i.test(btn.textContent || "")){
        btn.onclick = showFullHistory;
      }
    });
  });
  // Expose in case se llama manualmente
  window.__showFullHistory = showFullHistory;
})();
</script>
<!-- === END FIX === -->
<!-- === DATE FIX: Guardar ISO y formatear robusto === -->
<script>
(function(){
  // Normaliza a ISO siempre
  function nowISO(){ try { return __nowISO(); } catch(_) { return Date(); } }
  // Intenta parsear múltiples formatos (ISO, dd/mm/yyyy, yyyy-mm-dd, etc.)
  function parseFechaSmart(v){
    if (!v) return new Date();
    try{
      const d = new Date(v);
      if (!isNaN(d.getTime())) return d;
      // dd/mm/yyyy HH:MM (opcional)
      const m = String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if (m){
        const dd = parseInt(m[1],10), mm = parseInt(m[2],10)-1, yyyy = parseInt(m[3].length===2?('20'+m[3]):m[3],10);
        const hh = m[4]?parseInt(m[4],10):0, mi = m[5]?parseInt(m[5],10):0;
        return new Date(yyyy, mm, dd, hh, mi);
      }
    }catch(_){}
    return new Date();
  }
  // Formatea en es-AR corto
  function fmtFecha(v){
    const d = parseFechaSmart(v);
    try{
      return d.toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' });
    }catch(_){
      return d.toLocaleString();
    }
  }
  // Exponer por si otras funciones lo usan
  window.__nowISO = nowISO;
  window.__fmtFecha = fmtFecha;
  window.__parseFechaSmart = parseFechaSmart;
})();
</script>
<!-- === END DATE FIX === -->
<!-- === HISTORIAL: unificación estricta + tope 5 + Ver todo fiable === -->
<script>
(function(){
  const HIST_KEY = "historialWsp";
  const MAX_ROWS = 5;

  function nowISO(){ try{return new Date().toISOString();}catch(_){return Date();} }
  function parseSmart(v){
    if(!v) return new Date();
    const d = new Date(v);
    if(!isNaN(d.getTime())) return d;
    const m = String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
    if(m){
      const dd=+m[1], mm=(+m[2])-1, yy=m[3].length===2?+("20"+m[3]):+m[3], hh=+(m[4]||0), mi=+(m[5]||0);
      return new Date(yy,mm,dd,hh,mi);
    }
    return new Date();
  }
  function fmt(v){
    const d = parseSmart(v);
    try { return d.toLocaleString('es-AR', {dateStyle:'short', timeStyle:'short'}); }
    catch(_){ return d.toLocaleString(); }
  }

  function loadHist(){
    try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch(_){ return []; }
  }
  function saveHist(arr){
    try { localStorage.setItem(HIST_KEY, JSON.stringify(arr)); } catch(_){}
  }

  // Escribe 1 sola vez por envío; evita duplicados inmediatos (<=3s) mismo cliente+tipo+mensaje
  function archiveOnce(entry){
    const rows = loadHist();
    const last = rows[rows.length-1];
    const tooClose = last && last.cliente===entry.cliente && (last.tipo||"")===(entry.tipo||"") && (last.mensaje||"")===(entry.mensaje||"") && (Math.abs(new Date(entry.fecha)-new Date(last.fecha))<=3000);
    if (!tooClose){
      rows.push(entry);
      saveHist(rows);
    }
    renderPanel();
  }

  // Panel (solo Cliente / Tipo / Fecha)
  function renderPanel(){
    const tb = document.getElementById("historial-mensajes");
    if (!tb) return;
    tb.innerHTML = "";
    const rows = loadHist();
    const last5 = rows.slice(-MAX_ROWS);
    last5.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="py-2">${r.cliente||""}</td>
                      <td class="py-2">${r.tipo||r.tipoMensaje||""}</td>
                      <td class="py-2">${fmt(r.fecha)}</td>`;
      tb.prepend(tr);
    });
  }

  // Ver todo (lee solo nuestro storage)
  function openFull(){
    const rows = loadHist();
    const style = "<style>body{font-family:system-ui,Segoe UI,Arial;margin:16px} table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:8px} th{background:#f3f4f6;text-align:left;white-space:nowrap}</style>";
    const head = "<h2>Historial completo</h2>";
    const header = "<tr><th>Cliente</th><th>Mensaje</th><th>Tipo</th><th>Estado</th><th>Fecha</th></tr>";
    const rowsHtml = rows.map(r => `<tr>
      <td>${(r.cliente||"").replace(/</g,"&lt;")}</td>
      <td style='max-width:520px;overflow:hidden;text-overflow:ellipsis'>${(r.mensaje||"").replace(/</g,"&lt;")}</td>
      <td>${(r.tipo||r.tipoMensaje||"")}</td>
      <td>${r.estado||"ENVIADO"}</td>
      <td>${fmt(r.fecha)}</td>
    </tr>`).join("");
    const w = window.open("", "_blank");
    w.document.write(style + head + "<table>" + header + rowsHtml + "</table>");
  }

  // ---- Hooks y overrides seguros ----
  // 1) Forzar nuestra función como fuente de verdad
  window.renderHistorial = renderPanel;
  window.cargarHistorialMensajes = renderPanel;

  // 2) Reemplazar pushHistorialEnvio para que guarde 1 vez en nuestro storage
  window.pushHistorialEnvio = function(cliente, mensaje, estado){
    const tipoSel = document.getElementById('tipo-mensaje');
    const tipo = tipoSel ? (tipoSel.options[tipoSel.selectedIndex]?.text || tipoSel.value || "") : "";
    archiveOnce({ cliente, mensaje, tipo, estado: estado||"ENVIADO", fecha: nowISO() });
    // También intentamos reflejar en la pestaña Historial si existe helper
    if (typeof window.appendToHistorialTab === "function"){
      try { window.appendToHistorialTab({ cliente, mensaje, tipo, estado: estado||"ENVIADO", fecha: nowISO(), seq: loadHist().length }); } catch(_){}
    }
  };

  // 3) Envolver los dos flujos de envío para que SIEMPRE llamen a pushHistorialEnvio exactamente una vez
  function wrapSend(name){
    const fn = window[name];
    if (typeof fn !== "function") return;
    window[name] = function(){
      const cli = document.getElementById('notif-cliente')?.value || "Cliente";
      const msg = document.getElementById('mensaje-preview')?.value || "";
      try { fn.apply(this, arguments); } finally { try{ window.pushHistorialEnvio(cli, msg, "ENVIADO"); }catch(_){ } }
    };
  }
  wrapSend("enviarMensajeWhatsApp");
  wrapSend("enviarWhatsAppDesdeBoton");

  // 4) Botón Ver todo
  window.addEventListener("load", ()=>{
    document.querySelectorAll("button").forEach(b=>{
      if (/ver todo/i.test(b.textContent||"")) b.onclick = openFull;
    });
    renderPanel();
  });

  // Exponer por si se necesita
  window.__hist_openFull = openFull;
  window.__hist_renderPanel = renderPanel;
})();
</script>
<!-- === FIN HISTORIAL UNIFICADO === -->
<!-- === REMOVE "Borrar historial" button (robusto) === -->
<style>
  /* Si algún script legacy lo agrega, lo ocultamos igual */
  #historial-wsp-controls .bg-red-500 { display: none !important; }
</style>
<script>
(function(){
  function removeClearButtons(){
    document.querySelectorAll('#historial-wsp-controls button, button').forEach(btn=>{
      if (/borrar historial/i.test(btn.textContent||"")) {
        btn.remove();
      }
    });
  }
  // Neutralizar cualquier función clearAll legacy
  window.clearAll = function(){};
  // Si existe ensureHistorialControls, envolvemos para limpiar luego
  if (typeof window.ensureHistorialControls === "function"){
    const _orig = window.ensureHistorialControls;
    window.ensureHistorialControls = function(){
      const r = _orig.apply(this, arguments);
      try{ removeClearButtons(); }catch(_){}
      return r;
    };
  }
  document.addEventListener("DOMContentLoaded", removeClearButtons);
  window.addEventListener("load", removeClearButtons);
})();
</script>
<!-- === END REMOVE === -->
<!-- === ORANGE CLEAR BUTTON: keep button, color orange, restore action === -->
<style>
  /* Estilo naranja para el botón de borrar historial */
  .btn-clear-orange{
    background-color:#f97316 !important; /* orange-500 */
    color:#fff !important;
    border-radius:6px;
    padding:4px 8px;
    font-size:12px;
    line-height:1.2;
    display:inline-flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
    border:none;
  }
  .btn-clear-orange:hover{ background-color:#ea580c !important; } /* orange-600 */
</style>
<script>
(function(){
  const HIST_KEY = "historialWsp";

  function loadHist(){ try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch(_){ return []; } }
  function saveHist(a){ try { localStorage.setItem(HIST_KEY, JSON.stringify(a)); } catch(_){ } }

  // Restaurar funcionalidad de borrar (si el usuario decide usarlo)
  function clearAll(){
    if (!confirm("¿Seguro que querés borrar TODO el historial de WhatsApp?")) return;
    saveHist([]);
    // Vaciar panel
    const tbw = document.getElementById("historial-mensajes");
    if (tbw) tbw.innerHTML = "";
    // Quitar filas #MSG- en pestaña Historial
    const tbh = document.getElementById("tabla-historial");
    if (tbh){
      Array.from(tbh.querySelectorAll("tr")).forEach(tr=>{
        const first = tr.querySelector("td");
        if (first && /^#?MSG-/i.test((first.textContent||'').trim())) tr.remove();
      });
    }
    alert("Historial borrado.");
  }
  window.clearAll = clearAll; // por si algo lo sobreescribió

  function ensureOrangeButton(){
    const ctr = document.getElementById("historial-wsp-controls") || document.querySelector("#historial-mensajes")?.parentElement?.parentElement;
    if (!ctr) return;
    // Buscar botón existente por texto
    let btn = null;
    (ctr.querySelectorAll("button")||[]).forEach(b=>{
      if (/borrar historial/i.test(b.textContent||"")) btn = b;
    });
    if (!btn){
      // Crear si no existía
      btn = document.createElement("button");
      btn.textContent = "Borrar historial";
      ctr.appendChild(btn);
    }
    btn.classList.add("btn-clear-orange");
    // Quitar clases de color anteriores que pudieran ocultarlo
    btn.classList.remove("bg-red-500","hover:bg-red-600");
    // Forzar visible por si alguna regla lo ocultó
    btn.style.display = "inline-flex";
    btn.onclick = clearAll;
  }

  document.addEventListener("DOMContentLoaded", ensureOrangeButton);
  window.addEventListener("load", ensureOrangeButton);
})();
</script>
<!-- === END ORANGE CLEAR BUTTON === -->
<!-- === OWNER PIN GUARD for "Borrar historial" === -->
<script>
(function(){
  const HIST_KEY = "historialWsp";
  const OWNER_HASH_KEY = "ownerKeyHash_v1";

  // SHA-256 hash to hex
  async function sha256Hex(str){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const bytes = Array.from(new Uint8Array(hash));
    return bytes.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function ensureOwnerKey(){
    let stored = localStorage.getItem(OWNER_HASH_KEY);
    if (stored) return true;
    const k1 = prompt("Configurar clave del dueño (mínimo 4 caracteres):");
    if (k1 === null) return false;
    if ((k1 || "").length < 4){ alert("La clave debe tener al menos 4 caracteres."); return false; }
    const k2 = prompt("Confirmá la clave del dueño:");
    if (k2 === null) return false;
    if (k1 !== k2){ alert("Las claves no coinciden."); return false; }
    const h = await sha256Hex(k1);
    localStorage.setItem(OWNER_HASH_KEY, h);
    alert("Clave del dueño configurada.");
    return true;
  }

  async function requireOwnerKey(){
    const stored = localStorage.getItem(OWNER_HASH_KEY);
    if (!stored){
      // primera vez: configurar
      const ok = await ensureOwnerKey();
      return ok;
    }
    const input = prompt("Ingresá la clave del dueño para borrar el historial:");
    if (input === null) return false;
    const h = await sha256Hex(input);
    if (h !== stored){
      alert("Clave incorrecta.");
      return false;
    }
    return true;
  }

  // Lógica real de borrado (no tocar)
  function doClearAll(){
    try{
      // limpiar storage del historial
      localStorage.setItem(HIST_KEY, "[]");
      // limpiar panel
      const tbw = document.getElementById("historial-mensajes");
      if (tbw) tbw.innerHTML = "";
      // limpiar filas #MSG- en pestaña Historial
      const tbh = document.getElementById("tabla-historial");
      if (tbh){
        Array.from(tbh.querySelectorAll("tr")).forEach(tr=>{
          const first = tr.querySelector("td");
          if (first && /^#?MSG-/i.test((first.textContent||'').trim())) tr.remove();
        });
      }
      alert("Historial borrado.");
    }catch(e){
      alert("No se pudo borrar el historial: " + e.message);
    }
  }

  // Wrapper con PIN
  async function guardedClearAll(){
    const ok = await requireOwnerKey();
    if (!ok) return;
    doClearAll();
  }

  // Re-vincular el botón naranja a nuestro guard
  function hookButton(){
    // Contenedor habitual
    const ctr = document.getElementById("historial-wsp-controls") || document.querySelector("#historial-mensajes")?.parentElement?.parentElement;
    if (!ctr) return;
    let btn = null;
    (ctr.querySelectorAll("button")||[]).forEach(b=>{
      if (/borrar historial/i.test(b.textContent||"")) btn = b;
    });
    if (btn){
      btn.onclick = guardedClearAll;
      // etiqueta visual sutil
      btn.title = "Solo dueño (requiere clave)";
    }
    // por si existiera window.clearAll en algún script viejo, lo sobreescribimos
    window.clearAll = guardedClearAll;
  }

  document.addEventListener("DOMContentLoaded", hookButton);
  window.addEventListener("load", hookButton);

  // Exponer utilidades (opcional)
  window.__owner_setKey = ensureOwnerKey;
  window.__owner_resetKey = function(){
    if (confirm("¿Eliminar la clave del dueño? Tendrás que configurarla de nuevo.")){
      localStorage.removeItem(OWNER_HASH_KEY);
      alert("Clave eliminada.");
    }
  };
})();
</script>
<!-- === END OWNER PIN GUARD === -->
<!-- PATCH: WhatsApp fixes, historial top-5, Ver todo, Borrar historial con PIN -->
<script>
(function(){
  // ---------- Utils ----------
  function todayStr(){
    try{
      const tz = 'America/Argentina/Buenos_Aires';
      const d = new Date();
      // format DD/MM/YYYY HH:MM
      const pad = n => String(n).padStart(2,'0');
      return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes());
    }catch(_){ return new Date().toLocaleString(); }
  }
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  // ---------- Safe showSection fallback ----------
  if (typeof window.showSection !== 'function'){
    window.showSection = function(_e, id){
      try{
        $all('.section').forEach(sec => sec.classList.remove('active'));
        const t = document.getElementById(id);
        if (t){ t.classList.add('active'); }
        $all('.sidebar-item').forEach(a => a.classList.remove('active'));
      }catch(_){}
    };
  }

  // ---------- Implement enviarWhatsAppDesdeBoton ----------
  window.enviarWhatsAppDesdeBoton = function(btn){
    try{
      // Try to infer context (reparación or pedido)
      let cliente = '', telefono = '', ticket = '';
      // Look up closest row/card for basic info
      const row = btn.closest('tr, .p-4.rounded-lg.border'); // table row or pedido card
      if (row){
        // Reparaciones table layout
        const tds = row.querySelectorAll('td');
        if (tds && tds.length >= 6){
          ticket = (tds[0]?.innerText || '').trim().replace('#','');
          cliente = (tds[1]?.innerText || '').trim();
        }
        // Pedidos card layout
        const nameLine = row.querySelector('.mt-1.font-medium');
        if (nameLine && !cliente){
          const txt = nameLine.textContent.trim();
          const parts = txt.split('•');
          if (parts.length){
            cliente = parts[0].trim();
            telefono = (parts[1]||'').replace(/\D/g,'');
          }
        }
      }
      // Go to WhatsApp module
      window.showSection(null,'whatsapp');
      // Prefill fields if exist
      const sec = document.getElementById('whatsapp');
      if (sec){
        const clienteEl = sec.querySelector('#notif-cliente');
        const telEl = sec.querySelector('#notif-telefono');
        const selRep = sec.querySelector('#select-reparacion');
        const tipoEl = sec.querySelector('#tipo-mensaje');
        if (clienteEl && cliente) clienteEl.value = cliente;
        if (telEl && telefono) telEl.value = telefono;
        if (selRep && ticket){
          const opt = selRep.querySelector(`option[value="${ticket}"]`);
          if (opt){ selRep.value = ticket; if (typeof window.cargarDatosReparacion === 'function') window.cargarDatosReparacion(); }
        }
        if (tipoEl && !tipoEl.value){
          tipoEl.value = 'recibido';
          if (typeof window.generarMensaje === 'function') window.generarMensaje();
        }
        // Focus send btn
        const sendBtn = sec.querySelector('#btn-enviar-wsp');
        if (sendBtn) sendBtn.scrollIntoView({behavior:'smooth',block:'center'});
      }
    }catch(err){
      console.error('enviarWhatsAppDesdeBoton error', err);
      alert('No se pudo abrir el módulo de WhatsApp.');
    }
  };

  // ---------- Historial de envíos (top 5, ver todo, borrar con PIN) ----------
  const LS_KEY = 'historialMensajesME';
  const PIN_KEY = 'historialPINME';

  function getHistorial(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(_){ return []; }
  }
  function setHistorial(arr){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }catch(_){}
  }
  function pushHistorial(item){
    const arr = getHistorial();
    arr.unshift(item); // newest first
    setHistorial(arr);
    renderHistorialMensajes();
  }
  function renderHistorialMensajes(showAll){
    const tbody = document.getElementById('historial-mensajes');
    if (!tbody) return;
    const data = getHistorial();
    // Limit or all
    const view = (showAll ? data : data.slice(0,5));
    tbody.innerHTML = '';
    for (const it of view){
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      // Cliente
      const tdCliente = document.createElement('td'); tdCliente.className='py-2'; tdCliente.textContent = it.cliente || '-';
      // Tipo (no texto completo)
      const tdTipo = document.createElement('td'); tdTipo.className='py-2'; tdTipo.textContent = it.tipo || '-';
      // Estado fijo "Enviado"
      const tdEstado = document.createElement('td'); tdEstado.className='py-2'; tdEstado.textContent = 'Enviado';
      // Fecha
      const tdFecha = document.createElement('td'); tdFecha.className='py-2'; tdFecha.textContent = it.fecha || '-';
      tr.append(tdCliente, tdTipo, tdEstado, tdFecha);
      tbody.appendChild(tr);
    }
    // Update button state
    const btnVer = document.getElementById('btn-ver-todo-historial');
    if (btnVer){
      const isAll = !!showAll;
      btnVer.dataset.state = isAll ? 'all' : 'top5';
      btnVer.textContent = isAll ? 'Ver solo 5' : 'Ver todo';
    }
  }

  function ensureHistorialUI(){
    const container = document.getElementById('whatsapp');
    if (!container) return;
    // Buttons area: place above the table
    const titulo = container.querySelector('h4.font-semibold.mb-4');
    if (!titulo) return;
    let btns = document.getElementById('historial-actions');
    if (!btns){
      btns = document.createElement('div');
      btns.id = 'historial-actions';
      btns.className = 'flex gap-2 mb-3';
      btns.innerHTML = `
        <button id="btn-ver-todo-historial" class="px-3 py-2 rounded-lg border text-sm">Ver todo</button>
        <button id="btn-borrar-historial" class="px-3 py-2 rounded-lg border border-red-600 text-red-700 text-sm">Borrar historial</button>
      `;
      titulo.after(btns);
      // Events
      btns.querySelector('#btn-ver-todo-historial').addEventListener('click', function(){
        const nowAll = (this.dataset.state !== 'all');
        renderHistorialMensajes(nowAll);
      });
      btns.querySelector('#btn-borrar-historial').addEventListener('click', function(){
        const pinStored = localStorage.getItem(PIN_KEY) || '2468';
        const pin = prompt('Ingresá PIN para borrar historial:');
        if (pin === null) return;
        if (String(pin) !== String(pinStored)){
          alert('PIN incorrecto.');
          return;
        }
        if (!confirm('¿Seguro que querés borrar todo el historial de envíos?')) return;
        setHistorial([]);
        renderHistorialMensajes(false);
      });
    }
  }

  // Inject CSS to hide beyond 5 rows by default
  (function injectCSS(){
    const css = document.createElement('style');
    css.textContent = `#historial-mensajes tr:nth-child(n+6){ display:none; }`;
    document.head.appendChild(css);
  })();

  // Monkey-patch enviarMensajeWhatsApp to log minimal info on click
  if (typeof window.enviarMensajeWhatsApp === 'function'){
    const __orig = window.enviarMensajeWhatsApp;
    window.enviarMensajeWhatsApp = function(){
      try{
        // Read minimal info
        const sec = document.getElementById('whatsapp');
        const cliente = (sec?.querySelector('#notif-cliente')?.value || '').trim();
        const tipo = (sec?.querySelector('#tipo-mensaje')?.value || '').trim();
        const fecha = todayStr();
        // Push beforehand
        if (cliente && tipo){
          pushHistorial({cliente, tipo, fecha});
        }
      }catch(_){}
      // Call original
      return __orig.apply(this, arguments);
    };
  }

  // Ensure UI after load
  window.addEventListener('DOMContentLoaded', function(){
    ensureHistorialUI();
    renderHistorialMensajes(false);
  });

  // Also ensure when navigating to the WhatsApp tab
  const navWhatsapp = document.querySelector('.sidebar-item.btn-whatsapp, .btn-whatsapp');
  $all('.sidebar-item, .btn-whatsapp').forEach(el => {
    el.addEventListener('click', function(){
      setTimeout(function(){
        ensureHistorialUI();
        renderHistorialMensajes(false);
      }, 50);
    });
  });
})();
</script>

<!-- PATCH: Doble click en Reparaciones para vista previa de ticket -->
<script>
(function(){
  // Crea modal reutilizable para preview
  function ensurePreviewModal(){
    if (document.getElementById('previewTicketModal')) return;
    const modal = document.createElement('div');
    modal.id = 'previewTicketModal';
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.display = 'none';
    modal.style.zIndex = '9999';
    modal.innerHTML = `
      <div style="max-width:900px;width:92%;background:#fff;margin:5vh auto;padding:20px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h3 id="previewTitle" style="font-size:20px;font-weight:700;margin:0;">Vista previa</h3>
          <div>
            <button id="btnPreviewPrint" style="padding:8px 12px;border:1px solid #2563eb;border-radius:8px;background:#2563eb;color:#fff;margin-right:8px">Imprimir</button>
            <button id="btnPreviewClose" style="padding:8px 12px;border:1px solid #aaa;border-radius:8px;background:#f3f4f6;color:#111">Cerrar</button>
          </div>
        </div>
        <div id="previewBody" style="border:1px solid #e5e7eb;border-radius:8px;overflow:auto;max-height:70vh;padding:16px;background:#fff"></div>
      </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e)=>{ if(e.target.id==='previewTicketModal') hidePreviewModal(); });
    document.getElementById('btnPreviewClose').addEventListener('click', hidePreviewModal);
    document.getElementById('btnPreviewPrint').addEventListener('click', function(){
      const id = this.dataset.ordenId;
      if (typeof window.imprimirComprobante === 'function'){
        hidePreviewModal();
        window.imprimirComprobante(Number(id));
      }
    });
  }
  function showPreviewModal(html, ordenId){
    ensurePreviewModal();
    document.getElementById('previewBody').innerHTML = html;
    const btnPrint = document.getElementById('btnPreviewPrint');
    btnPrint.dataset.ordenId = ordenId || '';
    document.getElementById('previewTitle').textContent = 'Vista previa ticket #' + (ordenId || '');
    document.getElementById('previewTicketModal').style.display = 'block';
  }
  function hidePreviewModal(){
    const modal = document.getElementById('previewTicketModal');
    if (modal) modal.style.display = 'none';
  }

  function buildPreviewHTML(rep){
    if(!rep) return '<p>No se encontraron datos de la reparación.</p>';
    const fmt = (v)=> (v==null || v==='') ? '-' : String(v);
    // Leer nombre del taller de la configuración para mostrar en la vista previa
    let nombreConfPreview = 'Fixly Taller';
    try {
        const rawConf = localStorage.getItem('fixlytallerData');
        if (rawConf) {
            const parsedConf = JSON.parse(rawConf);
            if (parsedConf) {
                const cfg = parsedConf.configTaller || parsedConf.config;
                if (cfg) {
                    nombreConfPreview = cfg.nombre || cfg.nombre_taller || nombreConfPreview;
                }
            }
        }
    } catch (e) { /* ignorar errores y usar valor por defecto */ }

    return `
      <div style="font-family:Arial, sans-serif">
        <div style="text-align:center;margin-bottom:8px;">
          <div style="font-size:22px;font-weight:700;">${nombreConfPreview}</div>
          <div style="font-size:13px;color:#555">Comprobante de reparación</div>
        </div>
        <hr style="margin:8px 0;border:none;border-top:1px solid #e5e7eb">
        <table style="width:100%;font-size:14px;line-height:1.4">
          <tr><td style="width:35%;color:#555">N° Orden</td><td>#${fmt(rep.id)}</td></tr>
          <tr><td style="color:#555">Cliente</td><td>${fmt(rep.cliente)}</td></tr>
          <tr><td style="color:#555">Teléfono</td><td>${fmt(rep.telefono)}</td></tr>
          <tr><td style="color:#555">Equipo</td><td>${fmt(rep.equipo)}</td></tr>
          <tr><td style="color:#555">IMEI/Serie</td><td>${fmt(rep.imei)}</td></tr>
          <tr><td style="color:#555">Estado</td><td>${fmt(rep.estado)}</td></tr>
          <tr><td style="color:#555">Técnico</td><td>${fmt(rep.tecnico)}</td></tr>
          <tr><td style="color:#555">Fecha</td><td>${fmt(rep.fecha)}</td></tr>
          <tr><td style="color:#555">Anticipo</td><td>${fmt(rep.anticipo)}</td></tr>
          <tr><td style="color:#555">Costo</td><td>${fmt(rep.costo !== undefined ? rep.costo : rep.costoEstimado)}</td></tr>
        </table>
        <hr style="margin:8px 0;border:none;border-top:1px solid #e5e7eb">
        <div style="margin-top:6px;">
          <div style="font-weight:600;margin-bottom:4px;">Problema reportado</div>
          <div style="white-space:pre-wrap">${fmt(rep.problema)}</div>
        </div>
        <div style="margin-top:10px;">
          <div style="font-weight:600;margin-bottom:4px;">Observaciones</div>
          <div style="white-space:pre-wrap">${fmt(rep.observaciones)}</div>
        </div>
        <div style="margin-top:10px;">
          <div style="font-weight:600;margin-bottom:4px;">Accesorios</div>
          <div>${fmt(rep.accesorios)}</div>
        </div>
      </div>`;
  }

  function getRepById(id){
    try{
      // Buscar por coincidencia de ID convirtiendo ambos a string.
      // Usamos las variables de ámbito (reparaciones, historialEntregados) en lugar de window
      const repList = (typeof reparaciones !== 'undefined' && Array.isArray(reparaciones)) ? reparaciones : [];
      const histList = (typeof historialEntregados !== 'undefined' && Array.isArray(historialEntregados)) ? historialEntregados : [];
      const idStr = String(id);
      const r1 = repList.find(r => String(r.id) === idStr);
      if (r1) return r1;
      const r2 = histList.find(r => String(r.id) === idStr);
      if (r2) return r2;
    }catch(_){}
    return null;
  }

  function attachDblclick(){
    const seccion = document.querySelector('#reparaciones, #section-reparaciones, .reparaciones-section') || document;
    const tbody = seccion.querySelector('table tbody');
    if (!tbody) return;
    // Evitar duplicar listeners
    if (tbody.dataset.dblbound === '1') return;
    tbody.dataset.dblbound = '1';
    tbody.addEventListener('dblclick', function(e){
      const tr = e.target.closest('tr');
      if (!tr) return;
      // Ignorar clics sobre botones, enlaces o el contenedor de acciones
      if (e.target.closest('button, a, .acciones')) return;
      const firstCell = tr.querySelector('td');
      if (!firstCell) return;
      // El identificador viene con un '#' al comienzo (por ejemplo "#1012").
      // Lo dejamos como cadena para evitar convertir a número y perder coincidencias.
      const idStr = firstCell.textContent.trim().replace('#','');
      if (!idStr) return;
      // Buscar la reparación por ID utilizando la cadena
      const rep = getRepById(idStr);
      const html = buildPreviewHTML(rep);
      showPreviewModal(html, idStr);
    });
  }

  window.addEventListener('DOMContentLoaded', function(){
    ensurePreviewModal();
    attachDblclick();
  });

  // Re-attach after navegar tabs o recargas parciales
  document.addEventListener('click', function(e){
    if (e.target.closest('.sidebar-item')){
      setTimeout(attachDblclick, 120);
    }
  });
})();
</script>

<script>
// --- UX FIX WhatsApp: autoselección/recall de tipo y generación automática de mensaje ---
(function(){
  function on(el, ev, cb){ if(el){ el.addEventListener(ev, cb, false); } }
  function q(id){ return document.getElementById(id); }

  function initWhatsAppUX(){
    var selRep = q('select-reparacion');
    var tipo   = q('tipo-mensaje');
    var msg    = q('mensaje-preview');

    // recordar última opción elegida
    var last = '';
    try { last = localStorage.getItem('wspTipoMsg') || ''; } catch(_){}

    // si no hay tipo seleccionado, usar el último o 'recibido' por defecto
    if (tipo && !tipo.value){
      tipo.value = last || 'recibido';
    }

    // cuando cambia el tipo -> guardar preferencia y regenerar
    on(tipo, 'change', function(){
      try { localStorage.setItem('wspTipoMsg', tipo.value || ''); } catch(_){}
      try { if (typeof generarMensaje==='function') generarMensaje(); } catch(_){}
    });

    // cuando cambia la reparación -> cargar datos y regenerar
    on(selRep, 'change', function(){
      try { if (typeof cargarDatosReparacion==='function') cargarDatosReparacion(); } catch(_){}
      // si sigue vacío el tipo, forzar por defecto
      if (tipo && !tipo.value){ tipo.value = (localStorage.getItem('wspTipoMsg') || 'recibido'); }
      try { if (typeof generarMensaje==='function') generarMensaje(); } catch(_){}
    });

    // Al entrar al módulo: si ya hay reparación y tipo, generar mensaje si el textarea está vacío
    try {
      if (selRep && selRep.value && tipo && tipo.value && msg && !msg.value){
        if (typeof cargarDatosReparacion==='function') cargarDatosReparacion();
        if (typeof generarMensaje==='function') generarMensaje();
      }
    } catch(_){}
  }

  // Ejecutar al cargar DOM si ya estamos en la sección WhatsApp
  document.addEventListener('DOMContentLoaded', function(){
    var sec = document.getElementById('whatsapp');
    if (sec && sec.classList.contains('active')){
      initWhatsAppUX();
    }
  });

  // Hookear navegación: cuando se muestra la sección WhatsApp, inicializar UX
  (function hookShowSection(){
    var _oldShow = window.showSection;
    window.showSection = function(event, sectionName){
      try { if (typeof _oldShow === 'function') _oldShow.apply(this, arguments); } catch(_){}
      // si se navegó a "whatsapp", aplicar UX fix
      if (sectionName === 'whatsapp'){
        try { initWhatsAppUX(); } catch(_){}
      }
    };
  })();
})();
</script>


<script>
// --- UX FIX Pedidos: filtro de usuario por defecto "Todos" + persistencia y auto-fallback ---
(function(){
  function findUserFilterSelect(){
    // Busca un <select> que tenga una opción "Todos" en la sección de pedidos
    var candidates = Array.from(document.querySelectorAll('select'));
    for (var i=0;i<candidates.length;i++){
      var s = candidates[i];
      var hasTodos = Array.from(s.options).some(function(o){ return (o.textContent||'').trim().toLowerCase() === 'todos'; });
      // Evitar confundir con otros selects (WhatsApp, etc.) tratando de ubicarlo cerca del área de "Lista de Pedidos"
      var nearList = s.closest('.lista-pedidos') || s.closest('#lista-pedidos') || s.closest('.orders-list') || s.closest('.right-panel') || s.parentElement;
      if (hasTodos) return s;
    }
    return null;
  }

  function applyDefaultFilter(){
    var select = findUserFilterSelect();
    if (!select) return;
    // Valor previamente guardado
    var saved = '';
    try { saved = localStorage.getItem('pedidosFiltroUsuario') || ''; } catch(_){}
    // Detectar opción "Todos" y su value real
    var todosOpt = Array.from(select.options).find(function(o){ return (o.textContent||'').trim().toLowerCase() === 'todos'; });
    var todosVal = todosOpt ? (todosOpt.value || '') : '';
    // Si no hay saved => usar "Todos"
    var desired = saved || todosVal;
    if (desired && select.value !== desired){
      select.value = desired;
      // disparar change
      try { select.dispatchEvent(new Event('change', {bubbles:true})); } catch(_){}
    }
    // Guardar persistencia al cambiar
    select.addEventListener('change', function(){
      try { localStorage.setItem('pedidosFiltroUsuario', select.value || ''); } catch(_){}
    });
  }

  // Detectar cuando se navega a la sección de pedidos
  function hookShowSection(){
    var _old = window.showSection;
    window.showSection = function(event, sectionName){
      try { if (typeof _old === 'function') _old.apply(this, arguments); } catch(_){}
      if ((sectionName||'').toLowerCase().includes('pedido')){
        setTimeout(applyDefaultFilter, 50);
      }
    };
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Aplicar al cargar si ya está visible
    applyDefaultFilter();
    hookShowSection();
  });

  // Fallback: si después de render no hay items y el filtro != "Todos", forzar "Todos"
  var observer = new MutationObserver(function(){
    try {
      var list = document.querySelector('.lista-pedidos') || document.querySelector('#lista-pedidos') || document.querySelector('.orders-list');
      if (!list) return;
      var empty = list.querySelector('[data-empty]') || list.querySelector('.alert') || list.textContent.trim().match(/no hay pedidos/i);
      var select = findUserFilterSelect();
      if (empty && select){
        var todosOpt = Array.from(select.options).find(function(o){ return (o.textContent||'').trim().toLowerCase() === 'todos'; });
        var todosVal = todosOpt ? (todosOpt.value || '') : '';
        if (select.value !== todosVal){
          select.value = todosVal;
          try { select.dispatchEvent(new Event('change', {bubbles:true})); } catch(_){}
        }
      }
    } catch(_){}
  });
  try { observer.observe(document.body, {subtree:true, childList:true}); } catch(_){}
})();
</script>


<script>
// --- UX FIX Pedidos v2: filtro de usuario limpiado por defecto, persistente y con fallback ---
(function(){
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function getPedidosRoot(){
    // Busca el contenedor que tenga el título "Lista de Pedidos"
    var nodes = $all('*');
    for (var i=0;i<nodes.length;i++){
      var n = nodes[i];
      var txt = (n.textContent||'').trim().toLowerCase();
      if (txt === 'lista de pedidos'){
        // subir al contenedor padre más cercano (panel derecho)
        return n.closest('.card, .panel, .p-4, .right-panel') || n.parentElement;
      }
    }
    // fallback: tomar la mitad derecha (donde esté el historial) por estructura
    return document.body;
  }

  function findUserFilter(){
    var root = getPedidosRoot();
    // candidato: input o select que NO sea el de "Todos" (estado) y aparezca antes que la tabla/lista
    var inputs = $all('input, select', root);
    // Heurística: primero suele ser el filtro de usuario;
    // si hay dos controles y uno contiene opción "Todos", elegimos el otro como "user"
    var selectTodos = inputs.find(function(el){
      if (el.tagName === 'SELECT'){
        return $all('option', el).some(function(o){ return (o.textContent||'').trim().toLowerCase()==='todos'; });
      }
      return false;
    });
    if (inputs.length){
      if (selectTodos){
        return inputs.find(function(el){ return el !== selectTodos; }) || inputs[0];
      }
      // si no encontramos "Todos", tomamos el primero
      return inputs[0];
    }
    return null;
  }

  function triggerInput(el){
    try { el.dispatchEvent(new Event('input', {bubbles:true})); } catch(e){}
    try { el.dispatchEvent(new Event('change', {bubbles:true})); } catch(e){}
  }

  function applyUserFilterDefault(){
    var ctl = findUserFilter();
    if (!ctl) return;
    var key = 'pedidosFiltroUsuario_v2';
    var saved = '';
    try { saved = localStorage.getItem(key) || ''; } catch(_){}

    if (saved){
      // restaurar preferencia del usuario
      if (ctl.value !== saved){
        ctl.value = saved;
        triggerInput(ctl);
      }
    } else {
      // no hay preferencia -> limpiar (equivale a "Todos")
      if (ctl.value){
        ctl.value = '';
        triggerInput(ctl);
      }
    }

    // Persistir cada cambio
    ctl.addEventListener('input', function(){
      try { localStorage.setItem(key, ctl.value || ''); } catch(_){}
    });
    ctl.addEventListener('change', function(){
      try { localStorage.setItem(key, ctl.value || ''); } catch(_){}
    });
  }

  function autoFallbackIfEmpty(){
    var root = getPedidosRoot();
    var ctl = findUserFilter();
    if (!ctl) return;
    // Si detectamos mensaje de vacío, limpiar el filtro usuario
    var empty = root.querySelector('.alert, [data-empty]');
    if (!empty){
      // buscar texto "No hay pedidos que coincidan"
      var t = (root.textContent||'').toLowerCase();
      if (t.indexOf('no hay pedidos que coincidan') !== -1){
        empty = true;
      }
    }
    if (empty && ctl.value){
      ctl.value = '';
      triggerInput(ctl);
      try { localStorage.setItem('pedidosFiltroUsuario_v2',''); } catch(_){}
    }
  }

  // Hookear navegación
  var _oldShow = window.showSection;
  window.showSection = function(event, sectionName){
    try { if (typeof _oldShow==='function') _oldShow.apply(this, arguments); } catch(_){}
    if ((sectionName||'').toLowerCase().includes('pedido')){
      setTimeout(function(){
        applyUserFilterDefault();
        autoFallbackIfEmpty();
      }, 50);
    }
  };

  document.addEventListener('DOMContentLoaded', function(){
    // Aplicar por si ya estamos en la sección
    applyUserFilterDefault();
    autoFallbackIfEmpty();
  });

  // Observar cambios en la lista para re-aplicar el fallback
  try {
    var obs = new MutationObserver(function(){ autoFallbackIfEmpty(); });
    obs.observe(document.body, {subtree:true, childList:true});
  } catch(_){}
})();
</script>


<style>
/* --- UI Clean: ocultar buscador de Lista de Pedidos --- */
.fixly-hide-pedidos-search { display: none !important; }
</style>
<script>
// --- UI Clean Pedidos: esconder el buscador y conservar solo el filtro ---
(function(){
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function hideSearch(){
    // Candidatos: input con placeholder que incluya 'Buscar' o 'producto' cerca del panel de pedidos
    var inputs = $all('input[placeholder]');
    inputs.forEach(function(i){
      var ph = (i.getAttribute('placeholder')||'').toLowerCase();
      if (ph.includes('buscar') || ph.includes('producto') || ph.includes('cliente')){
        // Heurística: debe estar cerca del título "Lista de Pedidos"
        var containerText = (i.closest('div')||document.body).textContent || '';
        if (containerText.toLowerCase().includes('lista de pedidos')){
          i.classList.add('fixly-hide-pedidos-search');
          // Si tiene contenedor de control (ej: input-group), ocultarlo también
          var grp = i.closest('.input-group, .flex, .form-group, .relative');
          if (grp) grp.classList.add('fixly-hide-pedidos-search');
        }
      }
    });
  }
  document.addEventListener('DOMContentLoaded', hideSearch);
  // Por si se re-renderiza
  try {
    var obs = new MutationObserver(hideSearch);
    obs.observe(document.body, {subtree:true, childList:true});
  } catch(_){}
})();
</script>


<script>
// --- PATCH: Guardar y precargar Código Maestro en Configuración ---
(function(){
  function readData(){ try { return JSON.parse(localStorage.getItem('fixlytallerData')||'{}'); } catch(e){ return {}; } }
  function writeData(d){ try { localStorage.setItem('fixlytallerData', JSON.stringify(d)); } catch(e){} }
  function ensureShape(d){ if(!d||typeof d!=='object') d={}; d.config=d.config||{}; return d; }

  document.addEventListener('DOMContentLoaded', function(){
    var form = document.getElementById('formConfigTaller');
    if (!form) return;

    // Preload
    try {
      var d = ensureShape(readData());
      if (form.codigo_maestro && d.config.codigo_maestro){
        form.codigo_maestro.value = d.config.codigo_maestro;
      }
    } catch(e){}

    // Save
    form.addEventListener('submit', function(){
      try {
        var d = ensureShape(readData());
        if (form.codigo_maestro){
          d.config.codigo_maestro = form.codigo_maestro.value || '';
          writeData(d);
        }
      } catch(e){}
    });
  });
})();
</script>


<script>
// --- SECURITY: Requerir Código Maestro para eliminar o acciones críticas ---
(function(){
  var VALIDATED_KEY = 'fixlyMasterValidated';
  function readData(){ try { return JSON.parse(localStorage.getItem('fixlytallerData')||'{}'); } catch(e){ return {}; } }
  function getMaster(){
    var d = readData(); d = (d && d.config) ? d : {config:{}};
    return d.config.codigo_maestro || '';
  }
  function isDangerEl(el){
    if (!el) return false;
    var t = (el.getAttribute('title')||'').toLowerCase();
    var aria = (el.getAttribute('aria-label')||'').toLowerCase();
    var cls = el.className||'';
    var dact = el.getAttribute('data-action')||'';
    var txt = (el.textContent||'').toLowerCase();
    // heurísticas típicas de los botones de borrar
    return (
      el.matches('[data-requires-master]') ||
      /eliminar|borrar|delete|trash/.test(t) ||
      /eliminar|borrar|delete/.test(aria) ||
      /btn-danger|delete|trash|btn-delete/.test(cls) ||
      /delete|remove/.test(dact) ||
      /eliminar|borrar/.test(txt)
    );
  }
  function askMasterIfNeeded(){
    var code = getMaster();
    if (!code) return true; // no hay protección configurada
    // Si ya validado en esta sesión, OK
    try { if (sessionStorage.getItem(VALIDATED_KEY)==='1') return true; } catch(e){}
    var entered = prompt('Ingresá el Código Maestro para continuar:');
    if (entered === null) return false;
    if ((entered||'') === code){
      try { sessionStorage.setItem(VALIDATED_KEY,'1'); } catch(e){}
      return true;
    } else {
      alert('Código Maestro incorrecto.');
      return false;
    }
  }

  // Captura clicks en fase de captura y verifica si el target o algún padre es "peligroso"
  document.addEventListener('click', function(ev){
    var el = ev.target;
    // sube hasta 3 niveles para encontrar el botón real
    for (var i=0;i<3 && el; i++){ if (isDangerEl(el)) break; el = el.parentElement; }
    if (!el || !isDangerEl(el)) return;

    if (!askMasterIfNeeded()){
      ev.preventDefault();
      ev.stopPropagation();
      return false;
    }
    // Marca el elemento como validado para este click
    el.setAttribute('data-requires-master','ok');
  }, true);
})();
</script>


<script>
// --- SECURITY OWNER KEY: aplicar SOLO a botones de eliminar en todos los módulos ---
(function(){
  var OWNER_KEY_LS = 'fixlyOwnerKey';
  var SESSION_OK   = 'fixlyOwnerValidated';

  function getOwnerKey(){
    try {
      var k = localStorage.getItem(OWNER_KEY_LS) || '';
      if (k) return k;
      // Compat con blob de config
      var d = JSON.parse(localStorage.getItem('fixlytallerData') || '{}');
      if (d && d.config && d.config.codigo_maestro){
        k = d.config.codigo_maestro;
        localStorage.setItem(OWNER_KEY_LS, k || '');
      }
      return k || '';
    } catch(_) { return ''; }
  }
  function setOwnerKey(k){
    try {
      localStorage.setItem(OWNER_KEY_LS, k);
      var d = JSON.parse(localStorage.getItem('fixlytallerData') || '{}'); d=d||{}; d.config=d.config||{};
      d.config.codigo_maestro = k;
      localStorage.setItem('fixlytallerData', JSON.stringify(d));
    } catch(_) {}
  }
  function ensureOwnerKey(){
    var key = getOwnerKey();
    if (key && key.length >= 4) return true;
    var entered = prompt('Configurar clave del dueño (mínimo 4 caracteres):');
    if (entered === null) return false;
    entered = (entered || '').trim();
    if (entered.length < 4){ alert('La clave debe tener al menos 4 caracteres.'); return false; }
    setOwnerKey(entered); return true;
  }
  function isValidated(){
    try { return sessionStorage.getItem(SESSION_OK) === '1'; } catch(_) { return false; }
  }
  function validateOnce(){
    if (isValidated()) return true;
    var k = getOwnerKey(); if (!k) return true;
    var entered = prompt('Confirmá la clave del dueño:');
    if (entered === null) return false;
    if ((entered || '') === k){ try { sessionStorage.setItem(SESSION_OK,'1'); } catch(_){}; return true; }
    alert('Clave incorrecta.'); return false;
  }

  // Detecta si el elemento es un botón de ELIMINAR/BORRAR
  function isDeleteButton(el){
    if (!el) return false;
    var txt  = (el.textContent || '').toLowerCase();
    var tit  = (el.getAttribute && (el.getAttribute('title') || '').toLowerCase()) || '';
    var aria = (el.getAttribute && (el.getAttribute('aria-label') || '').toLowerCase()) || '';
    var act  = (el.getAttribute && (el.getAttribute('data-action') || '').toLowerCase()) || '';
    var cls  = (el.className || '').toLowerCase();
    // Íconos trash típicos
    var icon = el.matches && (el.matches('.fa-trash, .fa-trash-alt, .lucide-trash, .bi-trash') || false);

    return icon ||
           /eliminar|borrar|delete|remove|trash/.test(txt + tit + aria + act + cls) ||
           el.matches && el.matches('[data-action="delete"], [data-action*="delete"], .btn-delete, .delete, .btn-danger.delete');
  }

  // Intercepta clicks en fase de captura y exige clave SOLO para eliminar
  document.addEventListener('click', function(ev){
    var node = ev.target;
    // subir unos niveles por si el click fue sobre un ícono dentro del botón
    for (var i=0; i<4 && node; i++){
      if (isDeleteButton(node)) break;
      node = node.parentElement;
    }
    if (!node || !isDeleteButton(node)) return;

    if (!ensureOwnerKey()){ ev.preventDefault(); ev.stopPropagation(); return false; }
    if (!validateOnce()){   ev.preventDefault(); ev.stopPropagation(); return false; }
  }, true);

  // Tip visual: agregar title si falta
  function markDeletes(){
    var btns = document.querySelectorAll('button, a, [role="button"], .fa-trash, .fa-trash-alt, .lucide-trash, .bi-trash');
    btns.forEach(function(b){
      if (isDeleteButton(b) && !b.getAttribute('title')){
        try { b.setAttribute('title','Solo dueño (requiere clave)'); } catch(_){}
      }
    });
  }
  document.addEventListener('DOMContentLoaded', markDeletes);
  try { new MutationObserver(markDeletes).observe(document.body, {subtree:true, childList:true}); } catch(_){}
})();
</script>

</body>
</html>
